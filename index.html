<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WorkFlow Pro - ×× ×”×œ ××©×™××•×ª</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<!-- Appwrite SDK -->
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
<style>
  :root {
    --bg: #f0f4f8;
    --bg2: #e8eef5;
    --bg3: #eaf0f7;
    --card: #ffffff;
    --border: #dde5ef;
    --border2: #c8d5e5;
    --text: #2d3a4a;
    --text2: #6b7e96;
    --text3: #a0b0c4;
    --accent: #7bb3d8;
    --accent2: #5a9bc8;
    --accent3: rgba(123,179,216,0.15);
    --green: #6bc4a6;
    --green2: rgba(107,196,166,0.18);
    --red: #e88fa0;
    --red2: rgba(232,143,160,0.18);
    --yellow: #e8c46a;
    --yellow2: rgba(232,196,106,0.18);
    --blue: #7bb3d8;
    --blue2: rgba(123,179,216,0.18);
    --orange: #e8a87a;
    --orange2: rgba(232,168,122,0.18);
    --pink: #d4a0c8;
    --pink2: rgba(212,160,200,0.18);
    --radius: 12px;
    --shadow: 0 4px 24px rgba(100,130,170,0.12);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€â”€ Login Screen â”€â”€â”€ */
  #loginScreen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e8f0fa 0%, #f5e8f5 40%, #e8f5f0 100%);
    padding: 20px;
  }

  .login-box {
    width: 100%;
    max-width: 420px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 60px rgba(100,130,200,0.12);
  }

  .login-logo {
    text-align: center;
    margin-bottom: 32px;
  }

  .login-logo h1 {
    font-size: 28px;
    font-weight: 800;
    background: linear-gradient(135deg, #7bb3d8, #d4a0c8, #6bc4a6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -1px;
  }

  .login-logo p { color: var(--text2); font-size: 13px; margin-top: 4px; }

  .form-group { margin-bottom: 18px; }
  .form-group label { display:block; font-size:13px; color:var(--text2); margin-bottom:6px; font-weight:500; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(108,99,255,0.2);
  }
  .form-group select option { background: var(--bg3); }
  .form-group textarea { resize: vertical; min-height: 80px; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 10px;
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .btn-primary {
    background: var(--accent);
    color: white;
    width: 100%;
    justify-content: center;
    font-size: 15px;
  }
  .btn-primary:hover { background: var(--accent2); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(123,179,216,0.35); }
  .btn-sm { padding: 7px 14px; font-size: 12px; }
  .btn-outline { background: transparent; border: 1px solid var(--border2); color: var(--text2); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: var(--red2); color: #c0506a; border: 1px solid transparent; }
  .btn-danger:hover { background: var(--red); color: white; }
  .btn-success { background: var(--green2); color: #3a9a7a; border: 1px solid transparent; }
  .btn-success:hover { background: var(--green); color: white; }

  .demo-accounts {
    margin-top: 24px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }
  .demo-accounts p { font-size: 12px; color: var(--text3); margin-bottom: 10px; text-align:center; }
  .demo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .demo-btn {
    padding: 10px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    text-align: right;
    transition: all 0.2s;
  }
  .demo-btn:hover { border-color: var(--accent); background: var(--accent3); }
  .demo-btn .role { font-size: 11px; color: var(--text3); }
  .demo-btn .name { font-size: 13px; font-weight: 600; color: var(--text); }

  /* â”€â”€â”€ App Layout â”€â”€â”€ */
  #app { display: none; min-height: 100vh; }

  .app-wrapper { display: flex; min-height: 100vh; }

  /* Sidebar */
  .sidebar {
    width: 250px;
    min-width: 250px;
    background: var(--card);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    z-index: 100;
    transition: transform 0.3s;
  }

  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-logo {
    font-size: 18px;
    font-weight: 800;
    background: linear-gradient(135deg, #7bb3d8, #d4a0c8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .sidebar-user {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
  }

  .sidebar-user-info .name { font-size: 13px; font-weight: 600; }
  .sidebar-user-info .role-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    font-weight: 600;
    display: inline-block;
    margin-top: 2px;
  }

  .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }

  .nav-section-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text3);
    padding: 8px 8px 6px;
    margin-top: 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.15s;
    margin-bottom: 2px;
  }
  .nav-item:hover { background: var(--bg3); color: var(--text); }
  .nav-item.active { background: var(--accent3); color: var(--accent); font-weight: 600; }
  .nav-item .icon { font-size: 16px; width: 20px; text-align:center; }
  .nav-item .badge {
    margin-right: auto;
    background: var(--accent);
    color: white;
    font-size: 10px;
    padding: 1px 7px;
    border-radius: 20px;
  }

  .sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border);
  }

  /* Main Content */
  .main-content {
    flex: 1;
    margin-right: 250px;
    min-height: 100vh;
    background: var(--bg);
  }

  /* Top Bar */
  .topbar {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .topbar-title { font-size: 17px; font-weight: 700; }

  .topbar-actions { display: flex; align-items: center; gap: 12px; }

  .hamburger {
    display: none;
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 4px;
  }

  /* Pages */
  .page { display: none; padding: 24px; max-width: 1200px; margin: 0 auto; }
  .page.active { display: block; }

  /* Cards & Panels */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .card-title { font-size: 15px; font-weight: 700; }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }

  .stat-card.purple::before { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .stat-card.green::before { background: var(--green); }
  .stat-card.yellow::before { background: var(--yellow); }
  .stat-card.blue::before { background: var(--blue); }
  .stat-card.red::before { background: var(--red); }
  .stat-card.orange::before { background: var(--orange); }

  .stat-icon { font-size: 24px; margin-bottom: 10px; }
  .stat-value { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
  .stat-label { font-size: 12px; color: var(--text2); margin-top: 4px; }

  /* Tables */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    text-align: right;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text3);
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f5f8fc; }

  /* Tags & Badges */
  .tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }
  .tag-purple { background: var(--accent3); color: #4a88b8; }
  .tag-green { background: var(--green2); color: #3a9a7a; }
  .tag-red { background: var(--red2); color: #c0506a; }
  .tag-yellow { background: var(--yellow2); color: #a07820; }
  .tag-blue { background: var(--blue2); color: #4a88b8; }
  .tag-orange { background: var(--orange2); color: #b06830; }
  .tag-gray { background: rgba(0,0,0,0.05); color: var(--text2); }

  /* Task Cards */
  .tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 14px; }

  .task-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .task-card:hover { border-color: var(--border2); transform: translateY(-2px); box-shadow: var(--shadow); }
  .task-card.done { opacity: 0.6; }
  .task-card.done .task-title { text-decoration: line-through; }

  .task-card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
  .task-title { font-size: 14px; font-weight: 600; line-height: 1.4; }
  .task-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
  .task-desc { font-size: 12px; color: var(--text2); line-height: 1.5; margin-top: 6px; }

  .priority-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
  }
  .p-high { background: var(--red); }
  .p-medium { background: var(--yellow); }
  .p-low { background: var(--green); }

  /* Notes */
  .notes-area {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    line-height: 1.7;
    resize: vertical;
    min-height: 150px;
    outline: none;
    transition: border-color 0.2s;
  }
  .notes-area:focus { border-color: var(--accent); }

  /* Hours Table */
  .hours-table { border-radius: var(--radius); overflow: hidden; }
  .hours-table th { background: #f5f8fc; }
  .hours-input {
    width: 80px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 8px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 13px;
    text-align: center;
    outline: none;
  }
  .hours-input:focus { border-color: var(--accent); }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideUp 0.25s ease;
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity:0; } to { transform: translateY(0); opacity:1; } }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
  .modal-close {
    position: absolute;
    top: 16px;
    left: 16px;
    background: none;
    border: none;
    color: var(--text2);
    font-size: 20px;
    cursor: pointer;
  }
  .modal-close:hover { color: var(--text); }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

  /* Company Cards (Admin) */
  .company-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .company-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.2s;
  }
  .company-card:hover { border-color: var(--border2); }
  .company-logo {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    margin-bottom: 12px;
  }
  .company-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
  .company-meta { font-size: 12px; color: var(--text2); margin-bottom: 14px; }
  .company-actions { display: flex; gap: 8px; }

  /* Signature area */
  .sig-box {
    background: var(--bg3);
    border: 2px dashed var(--border2);
    border-radius: var(--radius);
    padding: 24px;
    text-align: center;
  }
  .sig-stamp {
    display: inline-block;
    border: 3px solid var(--green);
    border-radius: 50%;
    padding: 16px 20px;
    color: #3a9a7a;
    font-weight: 800;
    font-size: 18px;
    transform: rotate(-15deg);
    box-shadow: 0 0 20px rgba(107,196,166,0.3);
  }

  /* Toggle Checkbox */
  .toggle-wrap { display: flex; align-items: center; gap: 10px; }
  .toggle {
    width: 44px;
    height: 24px;
    background: var(--border2);
    border-radius: 20px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle.on { background: var(--accent); }
  .toggle::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: white;
    border-radius: 50%;
    top: 3px;
    right: 3px;
    transition: transform 0.2s;
  }
  .toggle.on::after { transform: translateX(-20px); }

  /* Tabs */
  .tabs { display: flex; gap: 4px; background: var(--bg3); border-radius: 10px; padding: 4px; margin-bottom: 20px; overflow-x: auto; }
  .tab {
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab.active { background: var(--card); color: var(--text); box-shadow: var(--shadow); }

  /* Notification dot */
  .notif-dot {
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    display: inline-block;
  }

  .active-sort { border-color: var(--accent) !important; color: var(--accent) !important; background: var(--accent3) !important; }

  /* Monthly hours grid â€” fixed layout so all 31 days always fit */
  .hours-grid-table {
    border-collapse: collapse;
    table-layout: fixed;
    width: 100%;
    font-size: 11px;
  }
  .hours-grid-table th {
    background: var(--bg3);
    padding: 5px 1px;
    text-align: center;
    font-size: 10px;
    font-weight: 700;
    border: 1px solid var(--border);
    overflow: hidden;
    white-space: nowrap;
  }
  .hours-grid-table th.worker-name-col {
    text-align: right;
    width: 120px;
    position: sticky;
    right: 0;
    background: var(--bg3);
    z-index: 2;
    border-right: 2px solid var(--border2);
    padding-right: 8px;
    padding-left: 4px;
  }
  .hours-grid-table th.total-col {
    width: 46px;
    background: #e8f0fa;
    border-left: 2px solid var(--border2);
  }
  .hours-grid-table td {
    padding: 5px 1px;
    text-align: center;
    border: 1px solid var(--border);
    font-size: 10px;
    overflow: hidden;
    white-space: nowrap;
    color: var(--text);
  }
  .hours-grid-table td.worker-name-td {
    text-align: right;
    font-weight: 700;
    font-size: 11px;
    background: #fafcff;
    position: sticky;
    right: 0;
    z-index: 1;
    border-right: 2px solid var(--border2);
    padding: 6px 8px 6px 4px;
    width: 120px;
  }
  .hours-grid-table td.total-td {
    font-weight: 800;
    font-size: 11px;
    color: #4a6080;
    background: #f0f5fb;
    border-left: 2px solid var(--border2);
    width: 46px;
  }
  .hours-grid-table th.today-col { background: #ddeeff; color: #3366aa; }
  .hours-grid-table td.today-col { background: #eef6ff; }
  .hours-grid-table td.weekend-col { background: #fff5f5; color: #c0506a; }
  .hours-grid-table th.weekend-col { background: #ffe8ea; color: #c0506a; }
  .hours-grid-table td.signed-cell { background: #f0fff4; }
  .hours-grid-table td.has-hours { font-weight: 700; color: #3366aa; }
  .hours-grid-table tr.total-row td { background: #f0f5fb; font-weight: 800; font-size: 11px; border-top: 2px solid var(--border2); }
  .hours-grid-table tr:hover td { background: #f5f8fc; }
  .hours-grid-table tr:hover td.worker-name-td { background: #e8f0fa; }
  .hours-grid-table tr:hover td.today-col { background: #ddeeff; }
  /* Fullscreen â€” bigger text, still fixed layout */
  #fs-workers-grid-wrap .hours-grid-table { font-size: 13px; }
  #fs-workers-grid-wrap .hours-grid-table th { font-size: 12px; padding: 7px 2px; }
  #fs-workers-grid-wrap .hours-grid-table td { font-size: 12px; padding: 8px 2px; }
  #fs-workers-grid-wrap .hours-grid-table td.worker-name-td { font-size: 13px; width: 140px; }
  #fs-workers-grid-wrap .hours-grid-table th.worker-name-col { width: 140px; }
  #fs-workers-grid-wrap .hours-grid-table td.total-td { font-size: 13px; }
  #fs-workers-grid-wrap .hours-grid-table tr.total-row td { font-size: 12px; }



  /* Progress bar */
  .progress-bar {
    background: var(--bg3);
    border-radius: 20px;
    height: 6px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    border-radius: 20px;
    transition: width 0.5s;
  }

  /* Search input */
  .search-input {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 13px;
    outline: none;
    width: 200px;
    transition: all 0.2s;
  }
  .search-input:focus { border-color: var(--accent); width: 240px; }

  /* Empty state */
  .empty-state { text-align: center; padding: 48px 20px; color: var(--text3); }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar {
      transform: translateX(100%);
    }
    .sidebar.open {
      transform: translateX(0);
    }
    .main-content {
      margin-right: 0;
    }
    .hamburger { display: block; }
    .page { padding: 16px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .tasks-grid { grid-template-columns: 1fr; }
    .topbar { padding: 0 16px; }
    .search-input { width: 140px; }
    .search-input:focus { width: 160px; }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    .sidebar-overlay.open { display: block; }
  }

  @media (max-width: 480px) {
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .company-grid { grid-template-columns: 1fr; }
    .demo-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <!-- Appwrite DB Setup Banner (shown if DB not initialized) -->
  <div id="setupBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(135deg,#4a6cc8,#8b5cf6);color:white;padding:14px 24px;font-size:13px;line-height:1.6;direction:rtl;">
    <div style="max-width:700px;margin:0 auto;">
      <div style="font-weight:800;font-size:15px;margin-bottom:6px;">âš™ï¸ ×”×’×“×¨×ª Appwrite Database × ×“×¨×©×ª</div>
      <div id="setupSteps" style="font-size:12px;opacity:0.9;"></div>
      <button onclick="document.getElementById('setupBanner').style.display='none'" style="margin-top:8px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.4);color:white;padding:4px 12px;border-radius:6px;cursor:pointer;font-size:11px;">×¡×’×•×¨</button>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="appwriteLoading" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,0.92);z-index:9998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
    <div style="width:48px;height:48px;border:4px solid #e0e7ff;border-top-color:#4a6cc8;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
    <div id="loadingMsg" style="font-size:14px;font-weight:600;color:#4a6cc8;">××ª×—×‘×¨ ×œ-Appwrite...</div>
    <div style="font-size:12px;color:#888;" id="loadingSubMsg"></div>
    <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
  </div>
  <div class="login-box">
    <div class="login-logo">
      <h1>WorkFlow Pro âš¡</h1>
      <p>××¢×¨×›×ª × ×™×”×•×œ ××©×™××•×ª ××ª×§×“××ª</p>
    </div>
    <div class="form-group">
      <label>×©× ××©×ª××©</label>
      <input type="text" id="loginUser" placeholder="×”×›× ×¡ ×©× ××©×ª××©">
    </div>
    <div class="form-group">
      <label>×¡×™×¡××”</label>
      <input type="password" id="loginPass" placeholder="×”×›× ×¡ ×¡×™×¡××”">
    </div>
    <div id="loginError" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none;">×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×</div>
    <button class="btn btn-primary" onclick="doLogin()">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    <div class="demo-accounts">
      <p>×›× ×™×¡×” ××”×™×¨×” ×œ×“××•</p>
      <div class="demo-grid">
        <div class="demo-btn" onclick="quickLogin('admin','admin123')">
          <div class="role">ğŸ‘‘ ×× ×”×œ ××¢×¨×›×ª</div>
          <div class="name">Admin</div>
        </div>
        <div class="demo-btn" onclick="quickLogin('ceo_techcorp','ceo123')">
          <div class="role">ğŸ¢ ×× ×›"×œ</div>
          <div class="name">TechCorp</div>
        </div>
        <div class="demo-btn" onclick="quickLogin('employee1','emp123')">
          <div class="role">ğŸ’¼ ×¢×•×‘×“</div>
          <div class="name">×“×•×“ ×œ×•×™</div>
        </div>
        <div class="demo-btn" onclick="quickLogin('worker1','work123')">
          <div class="role">ğŸ”§ ×¤×•×¢×œ</div>
          <div class="name">×™×•×¡×£ ×›×”×Ÿ</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <div class="app-wrapper">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">WorkFlow Pro âš¡</div>
        <div class="sidebar-user">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="sidebar-user-info">
            <div class="name" id="userName"></div>
            <div class="role-badge" id="roleBadge"></div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav" id="sidebarNav"></nav>
      <div class="sidebar-footer">
        <button class="btn btn-outline btn-sm" onclick="logout()" style="width:100%;justify-content:center;">ğŸšª ×™×¦×™××”</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <div class="topbar">
        <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
        <div class="topbar-title" id="pageTitle">×œ×•×— ×‘×§×¨×”</div>
        <div class="topbar-actions">
          <input type="text" id="globalSearch" class="search-input" placeholder="ğŸ” ×—×™×¤×•×©..." oninput="handleSearch(this.value)">
          <span id="topbarInfo" style="font-size:12px;color:var(--text2);"></span>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- Admin Dashboard -->
      <div class="page" id="page-admin-dashboard">
        <div class="stats-grid">
          <div class="stat-card purple">
            <div class="stat-icon">ğŸ¢</div>
            <div class="stat-value" id="stat-companies">3</div>
            <div class="stat-label">×—×‘×¨×•×ª ×‘××¢×¨×›×ª</div>
          </div>
          <div class="stat-card blue">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-value" id="stat-users">12</div>
            <div class="stat-label">××©×ª××©×™× ×¨×©×•××™×</div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">âœ…</div>
            <div class="stat-value">48</div>
            <div class="stat-label">××©×™××•×ª ×”×•×©×œ××•</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-icon">â³</div>
            <div class="stat-value">23</div>
            <div class="stat-label">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">âš¡ ×¤×¢×™×œ×•×ª ××—×¨×•× ×” ×‘××¢×¨×›×ª</div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>×¤×¢×•×œ×”</th><th>××©×ª××©</th><th>×—×‘×¨×”</th><th>×–××Ÿ</th></tr></thead>
              <tbody>
                <tr><td>× ×•×¡×¤×” ××©×™××” ×—×“×©×”</td><td>×“×•×“ ×œ×•×™</td><td>TechCorp</td><td>×œ×¤× ×™ 5 ×“×§×•×ª</td></tr>
                <tr><td>×›× ×™×¡×” ×œ××¢×¨×›×ª</td><td>CEO BuildPro</td><td>BuildPro</td><td>×œ×¤× ×™ 12 ×“×§×•×ª</td></tr>
                <tr><td>×¢×¨×™×›×ª ×©×¢×•×ª</td><td>×™×•×¡×£ ×›×”×Ÿ</td><td>BuildPro</td><td>×œ×¤× ×™ 1 ×©×¢×”</td></tr>
                <tr><td>×—×ª×™××” ×¢×œ ×“×•×— ×©×¢×•×ª</td><td>CEO BuildPro</td><td>BuildPro</td><td>×œ×¤× ×™ 2 ×©×¢×•×ª</td></tr>
                <tr><td>×”×•×©×œ××” ××©×™××”</td><td>×©×¨×” ×¨×•×–×Ÿ</td><td>TechCorp</td><td>××ª××•×œ</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Admin Companies -->
      <div class="page" id="page-admin-companies">
        <div class="card-header" style="margin-bottom:20px;">
          <div class="card-title" style="font-size:18px;">ğŸ¢ × ×™×”×•×œ ×—×‘×¨×•×ª</div>
          <button class="btn btn-primary btn-sm" onclick="openAddCompany()">+ ×”×•×¡×£ ×—×‘×¨×”</button>
        </div>
        <div class="company-grid" id="companiesGrid"></div>
      </div>

      <!-- Admin Users -->
      <div class="page" id="page-admin-users">
        <div class="card-header" style="margin-bottom:16px;">
          <div class="card-title" style="font-size:18px;">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™× ×•×¡×™×¡×××•×ª</div>
          <button class="btn btn-primary btn-sm" onclick="openAddUser()">+ ×”×•×¡×£ ××©×ª××©</button>
        </div>
        <!-- Filters & Sort bar -->
        <div class="card" style="padding:14px 18px;margin-bottom:14px;">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <input type="text" id="usersSearch" class="search-input" style="width:220px;" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©× / ××©×ª××©..." oninput="renderAdminUsers()">
            <select id="usersFilterRole" onchange="renderAdminUsers()" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;cursor:pointer;">
              <option value="">×›×œ ×”×ª×¤×§×™×“×™×</option>
              <option value="admin">ğŸ‘‘ ×× ×”×œ ××¢×¨×›×ª</option>
              <option value="ceo">ğŸ¢ ×× ×›"×œ</option>
              <option value="employee">ğŸ’¼ ×¢×•×‘×“</option>
              <option value="worker">ğŸ”§ ×¤×•×¢×œ</option>
            </select>
            <select id="usersFilterCompany" onchange="renderAdminUsers()" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;cursor:pointer;">
              <option value="">×›×œ ×”×—×‘×¨×•×ª</option>
            </select>
            <div style="margin-right:auto;display:flex;gap:6px;align-items:center;">
              <span style="font-size:12px;color:var(--text2);">××™×•×Ÿ ×œ×¤×™:</span>
              <button class="sort-btn btn btn-outline btn-sm active-sort" id="sort-name" onclick="setSort('name')">×©× â†•</button>
              <button class="sort-btn btn btn-outline btn-sm" id="sort-role" onclick="setSort('role')">×ª×¤×§×™×“ â†•</button>
              <button class="sort-btn btn btn-outline btn-sm" id="sort-company" onclick="setSort('company')">×—×‘×¨×” â†•</button>
            </div>
          </div>
        </div>
        <div class="card" style="padding:0;">
          <div class="table-wrap">
            <table>
              <thead><tr><th>×©×</th><th>×ª×¤×§×™×“</th><th>×—×‘×¨×”</th><th>×©× ××©×ª××©</th><th>×¡×™×¡××”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
              <tbody id="usersTableBody"></tbody>
            </table>
          </div>
          <div id="usersCount" style="padding:10px 16px;font-size:12px;color:var(--text3);border-top:1px solid var(--border);"></div>
        </div>
      </div>

      <!-- Admin Notes -->
      <div class="page" id="page-admin-notes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ×”×¢×¨×•×ª ××™×©×™×•×ª - ×× ×”×œ ×”××¢×¨×›×ª</div>
            <button class="btn btn-success btn-sm" onclick="saveNotes('admin')">ğŸ’¾ ×©××•×¨</button>
          </div>
          <textarea class="notes-area" id="admin-notes" placeholder="×›×ª×•×‘ ×›××Ÿ ×”×¢×¨×•×ª ××™×©×™×•×ª..." rows="12"></textarea>
        </div>
        <div id="admin-quick-notes" style="margin-top:16px;"></div>
        <button class="btn btn-outline btn-sm" onclick="addQuickNote('admin')" style="margin-top:10px;">+ ×”×•×¡×£ ×¤×ª×§ ××”×™×¨</button>
      </div>

      <!-- Admin AI Assistant -->
      <div class="page" id="page-admin-ai">
        <div style="display:flex;flex-direction:column;height:calc(100vh - 140px);gap:0;">
          <div class="card" style="margin-bottom:12px;padding:16px 20px;background:linear-gradient(135deg,#e8f0ff,#f0e8ff);border-color:#b8c8f0;flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#4a6cc8,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 12px rgba(74,108,200,0.3);">ğŸ¤–</div>
              <div>
                <div style="font-size:17px;font-weight:800;">×¢×•×–×¨ AI â€” ×× ×”×œ ××¢×¨×›×ª</div>
                <div style="font-size:12px;color:var(--text2);">×©××œ ×©××œ×•×ª ×¢×œ ×”××¢×¨×›×ª, ×§×‘×œ ×¢×¦×•×ª ×œ×©×™×¤×•×¨, ×•×‘×¦×¢ ×¤×¢×•×œ×•×ª × ×™×”×•×œ×™×•×ª</div>
              </div>
              <button onclick="clearAdminAiChat()" class="btn btn-outline btn-sm" style="margin-right:auto;font-size:11px;">ğŸ—‘ï¸ × ×§×” ×©×™×—×”</button>
            </div>
          </div>

          <div id="admin-ai-suggestions" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;flex-shrink:0;">
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">ğŸ“Š ×›××” ×—×‘×¨×•×ª ×•×›××” ××©×ª××©×™× ×™×© ×‘××¢×¨×›×ª?</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">ğŸ’¡ ××” ××¤×©×¨ ×œ×©×¤×¨ ×‘××¢×¨×›×ª?</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">ğŸ¢ ×ª×Ÿ ×œ×™ ×¡×™×›×•× ×¢×œ ×›×œ ×”×—×‘×¨×•×ª</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">ğŸ‘¥ ××™ ×”××©×ª××©×™× ×œ×œ× ×—×‘×¨×”?</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">âš ï¸ ×”×× ×™×© ×‘×¢×™×•×ª ××• ×× ×•××œ×™×•×ª ×‘××¢×¨×›×ª?</button>
          </div>

          <div id="admin-ai-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding:4px 2px;min-height:0;">
            <div id="admin-ai-welcome" style="text-align:center;padding:32px 16px;color:var(--text2);">
              <div style="font-size:40px;margin-bottom:12px;">ğŸ¤–</div>
              <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;">×©×œ×•× ×× ×”×œ ×”××¢×¨×›×ª!</div>
              <div style="font-size:13px;line-height:1.7;">×× ×™ ××›×™×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘××¢×¨×›×ª ×•×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ× ×”×œ ××•×ª×”.<br>
              ×× ×™ ×™×›×•×œ <strong>×œ×¢× ×•×ª ×©××œ×•×ª</strong>, ×œ×ª×ª <strong>×¢×¦×•×ª ×œ×©×™×¤×•×¨</strong>, ×•×’× <strong>×œ×‘×¦×¢ ×¤×¢×•×œ×•×ª</strong> ×›××• ×”×•×¡×¤×ª ×—×‘×¨×”, ×”×•×¡×¤×ª ××©×ª××©, ××—×™×§×”, ×•×¢×•×“.</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:flex-end;margin-top:10px;flex-shrink:0;">
            <textarea id="admin-ai-input" placeholder="×©××œ ×©××œ×” ××• ×‘×§×© ×œ×‘×¦×¢ ×¤×¢×•×œ×”..." rows="2"
              style="flex:1;border:2px solid #b8c8f0;border-radius:12px;padding:10px 14px;font-family:inherit;font-size:13px;resize:none;outline:none;line-height:1.5;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='#4a6cc8'" onblur="this.style.borderColor='#b8c8f0'"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAdminAiMessage();}"></textarea>
            <button onclick="sendAdminAiMessage()" id="admin-ai-send-btn"
              style="background:linear-gradient(135deg,#4a6cc8,#8b5cf6);color:white;border:none;border-radius:12px;padding:10px 18px;cursor:pointer;font-size:18px;height:46px;flex-shrink:0;box-shadow:0 4px 12px rgba(74,108,200,0.3);">â¤</button>
          </div>
          <div style="font-size:10px;color:var(--text3);text-align:center;margin-top:6px;flex-shrink:0;">Enter ×œ×©×œ×™×—×” â€¢ Shift+Enter ×œ×©×•×¨×” ×—×“×©×”</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CEO PAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- CEO Dashboard -->
      <div class="page" id="page-ceo-dashboard">
        <div id="ceo-company-header" class="card" style="margin-bottom:20px;padding:24px;background:linear-gradient(135deg,#e8f0fa,#f5e8f5);border-color:var(--accent);">
          <div style="font-size:28px;margin-bottom:8px;" id="ceo-company-emoji">ğŸ¢</div>
          <div style="font-size:22px;font-weight:800;" id="ceo-company-name">×—×‘×¨×” ×©×œ×™</div>
          <div style="color:var(--text2);font-size:13px;" id="ceo-company-field">×ª×—×•× ×¤×¢×™×œ×•×ª</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-icon">ğŸ’¼</div>
            <div class="stat-value" id="ceo-stat-employees">0</div>
            <div class="stat-label">×¢×•×‘×“×™×</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-icon">ğŸ”§</div>
            <div class="stat-value" id="ceo-stat-workers">0</div>
            <div class="stat-label">×¤×•×¢×œ×™×</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-icon">ğŸ“‹</div>
            <div class="stat-value" id="ceo-stat-tasks">0</div>
            <div class="stat-label">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">âœ…</div>
            <div class="stat-value" id="ceo-stat-done">0</div>
            <div class="stat-label">×”×•×©×œ××•</div>
          </div>
        </div>
      </div>

      <!-- CEO Employees -->
      <div class="page" id="page-ceo-employees">
        <div class="card-header" style="margin-bottom:20px;">
          <div class="card-title" style="font-size:18px;">ğŸ’¼ × ×™×”×•×œ ×¢×•×‘×“×™×</div>
          <button class="btn btn-primary btn-sm" onclick="ceoOpenAddMember('employee')">+ ×”×•×¡×£ ×¢×•×‘×“</button>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead><tr><th>×¢×•×‘×“</th><th>×ª×¤×§×™×“</th><th>××©×™××•×ª ×¤×ª×•×—×•×ª</th><th>××©×™××•×ª ×”×•×©×œ××•</th><th>×”×¡×¤×§</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
              <tbody id="ceo-employees-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CEO Workers -->
      <div class="page" id="page-ceo-workers">
        <!-- Workers list section -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header" style="flex-wrap:wrap;gap:10px;">
            <div style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:background 0.15s;" onclick="toggleSection('workers-section','workers-toggle-icon')" onmouseover="this.style.background='rgba(0,0,0,0.04)'" onmouseout="this.style.background='transparent'">
              <span id="workers-toggle-icon" style="font-size:14px;transition:transform 0.2s;display:inline-block;color:var(--text3);">â–¾</span>
              <div class="card-title" style="margin:0;">ğŸ”§ × ×™×”×•×œ ×¤×•×¢×œ×™× ×•×©×¢×•×ª</div>
            </div>
            <div style="display:flex;gap:8px;margin-right:auto;">
              <button class="btn btn-primary btn-sm" onclick="ceoOpenAddMember('worker')">+ ×”×•×¡×£ ×¤×•×¢×œ</button>
              <button class="btn btn-outline btn-sm" onclick="openBulkImportWorkers()"
                style="border-color:var(--green);color:var(--green);transition:background 0.15s,color 0.15s;white-space:nowrap;"
                onmouseover="this.style.background='var(--green)';this.style.color='white'"
                onmouseout="this.style.background='transparent';this.style.color='var(--green)'">ğŸ“¥ ×™×™×‘×•× ×××§×¡×œ</button>
            </div>
          </div>
          <div id="workers-section">
            <!-- Workers search -->
            <div style="padding:10px 0 8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <select id="workers-search-type" onchange="filterWorkersTable()" style="border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:12px;background:var(--bg3);color:var(--text);cursor:pointer;font-family:inherit;">
                <option value="name">ğŸ” ×©×</option>
                <option value="idpassport">ğŸªª ×ª"×– / ×“×¨×›×•×Ÿ</option>
              </select>
              <input type="text" id="workers-search-input" placeholder="×—×¤×© ×¤×•×¢×œ..." oninput="filterWorkersTable()"
                style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:13px;background:white;color:var(--text);min-width:180px;font-family:inherit;outline:none;">
              <span id="workers-search-count" style="font-size:12px;color:var(--text2);"></span>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>×¤×•×¢×œ</th><th>×¡×”"×› ×©×¢×•×ª</th><th>×©×¢×•×ª ×—×ª×•××•×ª âœ…</th><th>×©×¢×•×ª ×œ× ×—×ª×•××•×ª â³</th><th>×¡×˜×˜×•×¡</th><th>×¦×¤×™×™×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                <tbody id="ceo-workers-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Monthly Grid View -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header" style="flex-wrap:wrap;gap:10px;">
            <div style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:background 0.15s;" onclick="toggleSection('grid-section','grid-toggle-icon')" onmouseover="this.style.background='rgba(0,0,0,0.04)'" onmouseout="this.style.background='transparent'">
              <span id="grid-toggle-icon" style="font-size:14px;transition:transform 0.2s;display:inline-block;color:var(--text3);">â–¾</span>
              <div class="card-title" style="margin:0;">ğŸ“… ×œ×•×— ×©×¢×•×ª ×—×•×“×©×™</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-right:auto;">
              <button class="btn btn-outline btn-sm" onclick="changeGridMonth(-1)">â—€</button>
              <span id="grid-month-label" style="font-size:14px;font-weight:700;min-width:110px;text-align:center;"></span>
              <button class="btn btn-outline btn-sm" onclick="changeGridMonth(1)">â–¶</button>

              <!-- Zoom control -->
              <div style="display:flex;align-items:center;gap:0;background:var(--bg3);border:1px solid var(--border);border-radius:10px;overflow:hidden;">
                <button onclick="stepGridZoom(-0.5, false)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="×”×§×˜×Ÿ">âˆ’</button>
                <div style="width:1px;height:20px;background:var(--border);"></div>
                <div style="display:flex;align-items:center;gap:4px;padding:0 8px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color:var(--text3);flex-shrink:0;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                  <span id="grid-zoom-label" style="font-size:12px;font-weight:600;color:var(--text);min-width:26px;text-align:center;">11px</span>
                  <input type="range" id="grid-zoom-slider" min="7" max="18" step="0.5" value="11"
                    oninput="applyGridZoom(this.value, false)"
                    style="width:70px;cursor:pointer;accent-color:var(--accent);height:3px;appearance:none;-webkit-appearance:none;background:linear-gradient(to left, var(--accent) 0%, var(--border) 0%);border-radius:2px;outline:none;">
                </div>
                <div style="width:1px;height:20px;background:var(--border);"></div>
                <button onclick="stepGridZoom(0.5, false)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="×”×’×“×œ">+</button>
              </div>

              <button class="btn btn-outline btn-sm" onclick="fitGridToScreen(false)" title="×”×ª×× ×œ×¨×•×—×‘ ×”××¡×š" style="font-size:12px;">â¬œ ×”×ª××</button>
              <button class="btn btn-outline btn-sm" onclick="openGridFullscreen()" title="××¡×š ××œ×" style="font-size:14px;padding:6px 10px;">â›¶ ××¡×š ××œ×</button>
              <button class="btn btn-success btn-sm" onclick="copyGridToExcel()" title="×”×¢×ª×§×” ×œ××§×¡×œ" style="font-size:12px;gap:5px;">ğŸ“‹ ×”×¢×ª×§ ×œ××§×¡×œ</button>
            </div>
          </div>

          <div id="grid-section">
            <!-- Search bar -->
            <div style="padding:10px 0 4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <select id="grid-search-type" onchange="renderCeoWorkersGrid(false)" style="border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:12px;background:var(--bg3);color:var(--text);cursor:pointer;">
                <option value="name">ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©×</option>
                <option value="idpassport" selected>ğŸªª ×—×™×¤×•×© ×œ×¤×™ ×ª"×– / ×“×¨×›×•×Ÿ</option>
              </select>
              <input type="text" id="grid-search-input" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×©..." oninput="renderCeoWorkersGrid(false)"
                style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:13px;background:white;color:var(--text);min-width:180px;font-family:inherit;">
              <span id="grid-search-count" style="font-size:12px;color:var(--text2);"></span>
            </div>

            <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;" id="grid-scroll-container">
              <div id="workers-grid-wrap"></div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-header">
            <div class="card-title">ğŸ”‘ × ×™×”×•×œ ×¡×™×¡××ª ×—×ª×™××”</div>
          </div>
          <p style="color:var(--text2);font-size:13px;margin-bottom:14px;">×§×‘×¢ ××ª ×”×¡×™×¡××” ×©×× ×”×œ ×”××ª×¨ ×™×©×ª××© ×‘×” ×œ××™×©×•×¨ ×“×•×—×•×ª ×©×¢×•×ª</p>

          <!-- Current password display -->
          <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;">
            <div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-weight:600;">×¡×™×¡××” × ×•×›×—×™×ª:</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span id="current-sig-pass-display" style="font-family:monospace;font-size:15px;letter-spacing:3px;background:white;border:1px solid var(--border);border-radius:6px;padding:6px 14px;min-width:160px;color:var(--text);">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
              <button onclick="toggleCurrentSigPass()" id="current-sig-pass-eye" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:14px;" title="×”×¦×’/×”×¡×ª×¨">ğŸ‘ï¸</button>
            </div>
          </div>

          <!-- Set new password -->
          <div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-weight:600;">×”×’×“×¨ ×¡×™×¡××” ×—×“×©×”:</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <input type="password" id="sigPasswordInput" class="search-input" style="width:200px;" placeholder="×¡×™×¡××ª ×—×ª×™××” ×—×“×©×”">
            <button class="btn btn-success btn-sm" onclick="setSigPassword()">ğŸ’¾ ×©××•×¨ ×¡×™×¡××”</button>
          </div>
        </div>
      </div>

      <!-- CEO Tasks -->
      <div class="page" id="page-ceo-tasks">
        <div class="card-header" style="margin-bottom:20px;flex-wrap:nowrap;gap:8px;">
          <div class="card-title" style="font-size:18px;white-space:nowrap;">ğŸ“‹ × ×™×”×•×œ ××©×™××•×ª</div>
          <button class="btn btn-primary btn-sm" onclick="openAddTask('ceo')">+ ×”×•×¡×£ ××©×™××”</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
          <div class="tabs" style="margin-bottom:0;flex:1;">
            <div class="tab active" onclick="filterTasks('all',this)">×”×›×œ</div>
            <div class="tab" onclick="filterTasks('open',this)">×¤×ª×•×—×•×ª</div>
            <div class="tab" onclick="filterTasks('done',this)">×”×•×©×œ××•</div>
            <div class="tab" onclick="filterTasks('high',this)">×“×—×•×£</div>
          </div>
          <select id="ceo-task-employee-filter" onchange="renderCeoTasks()" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:13px;background:var(--bg3);color:var(--text);cursor:pointer;font-family:inherit;">
            <option value="">ğŸ‘¥ ×›×œ ×”×¢×•×‘×“×™×</option>
          </select>
        </div>
        <div class="tasks-grid" id="ceo-tasks-grid"></div>
      </div>

      <!-- CEO Credentials -->
      <div class="page" id="page-ceo-credentials">
        <div class="card" style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg,#fdf5e8,#fef9f0);border-color:var(--yellow);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">ğŸ”‘</div>
            <div>
              <div style="font-size:17px;font-weight:800;">×¤×¨×˜×™ ×›× ×™×¡×” ×©×œ ×”×¦×•×•×ª</div>
              <div style="font-size:13px;color:var(--text2);">×©××•×ª ××©×ª××© ×•×¡×™×¡×××•×ª ×©×œ ×›×œ ×”×¢×•×‘×“×™× ×•×”×¤×•×¢×œ×™× ×‘×—×‘×¨×” ×©×œ×š</div>
            </div>
          </div>
          <div style="margin-top:12px;padding:10px 14px;background:rgba(232,196,106,0.2);border-radius:8px;font-size:12px;color:#a07820;display:flex;align-items:center;gap:8px;">
            ğŸ”’ <span>×”××™×“×¢ ×”×–×” ×¨×’×™×© â€” ×©××•×¨ ××•×ª×• ×‘×¡×•×“×™×•×ª ×•××œ ×ª×©×ª×£ ×¢× ×’×•×¨××™× ×œ× ××•×¨×©×™×</span>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ’¼ ×¢×•×‘×“×™×</div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>×©×</th><th>×©× ××©×ª××©</th><th>×ª"×– / ×“×¨×›×•×Ÿ</th><th>×¡×™×¡××”</th><th>×¢×¨×™×›×”</th></tr></thead>
              <tbody id="ceo-emp-creds-table"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”§ ×¤×•×¢×œ×™×</div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>×©×</th><th>×©× ××©×ª××©</th><th>×ª"×– / ×“×¨×›×•×Ÿ</th><th>×¡×™×¡××”</th><th>×¢×¨×™×›×”</th></tr></thead>
              <tbody id="ceo-worker-creds-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CEO Notes -->
      <div class="page" id="page-ceo-notes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ×”×¢×¨×•×ª ××™×©×™×•×ª - ×× ×›"×œ</div>
            <button class="btn btn-success btn-sm" onclick="saveNotes('ceo')">ğŸ’¾ ×©××•×¨</button>
          </div>
          <textarea class="notes-area" id="ceo-notes" placeholder="×›×ª×•×‘ ×›××Ÿ ×”×¢×¨×•×ª ×¢×¡×§×™×•×ª, ×ª×–×›×•×¨×•×ª, ×•×“×‘×¨×™× ×—×©×•×‘×™×..." rows="12"></textarea>
        </div>
        <div id="ceo-quick-notes" style="margin-top:16px;"></div>
        <button class="btn btn-outline btn-sm" onclick="addQuickNote('ceo')" style="margin-top:10px;">+ ×”×•×¡×£ ×¤×ª×§ ××”×™×¨</button>
      </div>

      <!-- CEO AI Assistant -->
      <div class="page" id="page-ceo-ai">
        <div style="display:flex;flex-direction:column;height:calc(100vh - 140px);gap:0;">
          <!-- Header -->
          <div class="card" style="margin-bottom:12px;padding:16px 20px;background:linear-gradient(135deg,#f0ebff,#e8f0ff);border-color:#c8b8f0;flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#7b63d8,#5a9bc8);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 12px rgba(123,99,216,0.3);">ğŸ¤–</div>
              <div>
                <div style="font-size:17px;font-weight:800;">×¢×•×–×¨ AI</div>
                <div style="font-size:12px;color:var(--text2);">×©××œ ×©××œ×•×ª ×¢×œ ×”×—×‘×¨×” ×©×œ×š, ×§×‘×œ ×ª×•×‘× ×•×ª, ×•×‘×¦×¢ ×¤×¢×•×œ×•×ª</div>
              </div>
              <button onclick="clearAiChat()" class="btn btn-outline btn-sm" style="margin-right:auto;font-size:11px;">ğŸ—‘ï¸ × ×§×” ×©×™×—×”</button>
            </div>
          </div>

          <!-- Suggested prompts -->
          <div id="ai-suggestions" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;flex-shrink:0;">
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">ğŸ“Š ×›××” ×¤×•×¢×œ×™× ×™×© ×œ×™?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">â° ××™ ×¢×‘×“ ×”×›×™ ×”×¨×‘×” ×©×¢×•×ª ×”×—×•×“×©?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">ğŸ“‹ ×›××” ××©×™××•×ª ×¤×ª×•×—×•×ª ×™×©?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">âœ… ××™ ×¢×•×“ ×œ× ×—×ª× ×¢×œ ×“×•×— ×©×¢×•×ª?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">ğŸ”¥ ××™×œ×• ××©×™××•×ª ×“×—×•×¤×•×ª ×™×©?</button>
          </div>

          <!-- Chat messages -->
          <div id="ai-chat-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding:4px 2px;min-height:0;">
            <div id="ai-welcome-msg" style="text-align:center;padding:32px 16px;color:var(--text2);">
              <div style="font-size:40px;margin-bottom:12px;">ğŸ¤–</div>
              <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:6px;">×©×œ×•×! ×× ×™ ×”×¢×•×–×¨ ×”×—×›× ×©×œ×š</div>
              <div style="font-size:13px;">×× ×™ ×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×¢×œ ×”×¤×•×¢×œ×™×, ×”×¢×•×‘×“×™×, ×”××©×™××•×ª, ×•×©×¢×•×ª ×”×¢×‘×•×“×” ×‘×—×‘×¨×” ×©×œ×š.<br>×× ×™ ×™×›×•×œ ×’× ×œ×‘×¦×¢ ×¤×¢×•×œ×•×ª ×›××• ×™×¦×™×¨×ª ××©×™××•×ª ×•×¢×•×“.</div>
            </div>
          </div>

          <!-- Input area -->
          <div style="display:flex;gap:8px;align-items:flex-end;margin-top:10px;flex-shrink:0;">
            <textarea id="ai-input" placeholder="×©××œ ×©××œ×” ××• ×‘×§×© ×œ×‘×¦×¢ ×¤×¢×•×œ×”..." rows="2"
              style="flex:1;border:2px solid #c8b8f0;border-radius:12px;padding:10px 14px;font-family:inherit;font-size:13px;resize:none;outline:none;line-height:1.5;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='#7b63d8'" onblur="this.style.borderColor='#c8b8f0'"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAiMessage();}"></textarea>
            <button onclick="sendAiMessage()" id="ai-send-btn" style="background:linear-gradient(135deg,#7b63d8,#5a9bc8);color:white;border:none;border-radius:12px;padding:10px 18px;cursor:pointer;font-size:18px;height:46px;flex-shrink:0;box-shadow:0 4px 12px rgba(123,99,216,0.3);transition:opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">â¤</button>
          </div>
          <div style="font-size:10px;color:var(--text3);text-align:center;margin-top:6px;flex-shrink:0;">Enter ×œ×©×œ×™×—×” â€¢ Shift+Enter ×œ×©×•×¨×” ×—×“×©×”</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMPLOYEE PAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- Employee Dashboard -->
      <div class="page" id="page-emp-dashboard">
        <div class="card" style="background:linear-gradient(135deg,#e8f5ef,#f0f8e8);border-color:var(--green);margin-bottom:20px;padding:24px;">
          <div style="font-size:14px;color:var(--text2);">×©×œ×•×,</div>
          <div style="font-size:26px;font-weight:800;" id="emp-welcome-name">×¢×•×‘×“</div>
          <div style="color:var(--text2);font-size:13px;" id="emp-company-label">×—×‘×¨×”</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card yellow">
            <div class="stat-icon">ğŸ“‹</div>
            <div class="stat-value" id="emp-stat-open">0</div>
            <div class="stat-label">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">âœ…</div>
            <div class="stat-value" id="emp-stat-done">0</div>
            <div class="stat-label">×”×•×©×œ××•</div>
          </div>
          <div class="stat-card red">
            <div class="stat-icon">ğŸ”¥</div>
            <div class="stat-value" id="emp-stat-urgent">0</div>
            <div class="stat-label">×“×—×•×¤×•×ª</div>
          </div>
          <div class="stat-card purple">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-value" id="emp-stat-today">0</div>
            <div class="stat-label">×œ×”×™×•×</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”¥ ××©×™××•×ª ×“×—×•×¤×•×ª</div>
          </div>
          <div id="emp-urgent-tasks"></div>
        </div>
      </div>

      <!-- Employee Tasks -->
      <div class="page" id="page-emp-tasks">
        <div class="card-header" style="margin-bottom:20px;">
          <div class="card-title" style="font-size:18px;">ğŸ“‹ ×”××©×™××•×ª ×©×œ×™</div>
          <button class="btn btn-primary btn-sm" onclick="openAddTask('emp')">+ ×”×•×¡×£ ××©×™××”</button>
        </div>
        <div class="tabs">
          <div class="tab active" onclick="filterEmpTasks('all',this)">×”×›×œ</div>
          <div class="tab" onclick="filterEmpTasks('open',this)">×¤×ª×•×—×•×ª</div>
          <div class="tab" onclick="filterEmpTasks('done',this)">×”×•×©×œ××•</div>
          <div class="tab" onclick="filterEmpTasks('high',this)">×“×—×•×£</div>
          <div class="tab" onclick="filterEmpTasks('mine',this)">×©×™×¦×¨×ª×™</div>
        </div>
        <div class="tasks-grid" id="emp-tasks-grid"></div>
      </div>

      <!-- Employee Notes -->
      <div class="page" id="page-emp-notes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ×”×¢×¨×•×ª ××™×©×™×•×ª</div>
            <button class="btn btn-success btn-sm" onclick="saveNotes('emp')">ğŸ’¾ ×©××•×¨</button>
          </div>
          <textarea class="notes-area" id="emp-notes" placeholder="×›×ª×•×‘ ×›××Ÿ ×”×¢×¨×•×ª, ×ª×–×›×•×¨×•×ª, ×•×¨×¢×™×•× ×•×ª..." rows="12"></textarea>
        </div>
        <div id="emp-quick-notes" style="margin-top:16px;"></div>
        <button class="btn btn-outline btn-sm" onclick="addQuickNote('emp')" style="margin-top:10px;">+ ×”×•×¡×£ ×¤×ª×§ ××”×™×¨</button>
      </div>

      <!-- Employee Calendar -->
      <div class="page" id="page-emp-calendar">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“… ×œ×•×— ××©×™××•×ª ×œ×¤×™ ×ª××¨×™×š</div>
          </div>
          <div id="emp-calendar-content" style="color:var(--text2);text-align:center;padding:40px;">
            ×œ×•×— ×–×× ×™× ×™×•×¦×’ ×›××Ÿ<br>
            <div style="margin-top:20px;" id="emp-upcoming-tasks"></div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKER PAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- Worker Hours -->
      <div class="page" id="page-worker-hours">
        <div class="card" style="margin-bottom:20px;padding:24px;background:linear-gradient(135deg,#fdf0e8,#fdf5e8);border-color:var(--orange);">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
            <div>
              <div style="font-size:22px;font-weight:800;" id="worker-name-display">×©× ×”×¤×•×¢×œ</div>
              <div style="color:var(--text2);font-size:13px;" id="worker-company-display">×—×‘×¨×”</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              <button class="btn btn-outline btn-sm" onclick="changeWorkerMonth(-1)">â—€ ×—×•×“×© ×§×•×“×</button>
              <div id="worker-month-label" style="font-size:15px;font-weight:700;min-width:120px;text-align:center;"></div>
              <button class="btn btn-outline btn-sm" onclick="changeWorkerMonth(1)">×—×•×“×© ×”×‘× â–¶</button>
            </div>
          </div>
          <div style="margin-top:16px;display:flex;gap:24px;flex-wrap:wrap;">
            <div><div style="font-size:28px;font-weight:800;color:#b06830;" id="worker-total-hours">0</div><div style="font-size:12px;color:var(--text2);">×¡×”"×› ×©×¢×•×ª</div></div>
            <div><div style="font-size:28px;font-weight:800;color:#a07820;" id="worker-work-days">0</div><div style="font-size:12px;color:var(--text2);">×™××™ ×¢×‘×•×“×”</div></div>
            <div><div style="font-size:28px;font-weight:800;color:#3a9a7a;" id="worker-avg-hours">0</div><div style="font-size:12px;color:var(--text2);">×××•×¦×¢ ×™×•××™</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“Š ×“×•×— ×©×¢×•×ª ×—×•×“×©×™</div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-outline btn-sm" onclick="exportHours()">ğŸ“¥ ×™×™×¦×•×</button>
              <button class="btn btn-success btn-sm" id="worker-save-btn" onclick="saveWorkerHours()">ğŸ’¾ ×©××•×¨</button>
            </div>
          </div>
          <div id="worker-locked-banner" style="display:none;background:#fde8ec;border:1px solid #e88fa0;border-radius:10px;padding:12px 16px;margin-bottom:14px;color:#c0506a;font-size:13px;font-weight:600;">
            ğŸ”’ ×”×“×•×— × ×—×ª× ×¢×œ ×™×“×™ ×× ×”×œ ×”××ª×¨ â€” ×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ×©×¢×•×ª. ×œ×©×™× ×•×™, ×¤× ×” ×œ×× ×”×œ ×”××ª×¨ ×œ×‘×™×˜×•×œ ×”×—×ª×™××”.
          </div>
          <div class="table-wrap">
            <table class="hours-table">
              <thead><tr><th>×ª××¨×™×š</th><th>×™×•×</th><th>×”×’×¢×”</th><th>×™×¦×™××”</th><th>×©×¢×•×ª (×—×™×©×•×‘ ××•×˜×•××˜×™)</th><th>×”×¢×¨×•×ª</th></tr></thead>
              <tbody id="worker-hours-table"></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">
            <div class="card-title">âœï¸ ××™×©×•×¨ ×× ×”×œ ××ª×¨</div>
          </div>
          <div id="sig-status-area">
            <!-- Unsigned state -->
            <div class="sig-box" id="sig-unsigned">
              <div style="font-size:36px;margin-bottom:10px;">ğŸ“‹</div>
              <div style="color:var(--text2);margin-bottom:18px;font-size:14px;">×”×“×•×— ×˜×¨× ××•×©×¨ ×¢×œ ×™×“×™ ×× ×”×œ ×”××ª×¨</div>

              <!-- Sign full month -->
              <div id="sig-full-month-block" style="background:#f0f7ff;border:1px solid #c8dff5;border-radius:10px;padding:16px;margin-bottom:12px;text-align:right;">
                <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:#4a88b8;">âœ… ×—×ª×™××” ×¢×œ ×›×œ ×”×—×•×“×©</div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                  <input type="password" id="sigPasswordVerify" class="search-input" placeholder="×¡×™×¡××ª ×× ×”×œ ××ª×¨" style="width:190px;">
                  <button class="btn btn-primary btn-sm" onclick="signReport('full')">âœ… ×—×ª×•× ×¢×œ ×›×œ ×”×—×•×“×©</button>
                </div>
              </div>

              <!-- Sign specific days -->
              <div style="background:#f5f0ff;border:1px solid #d8c8f5;border-radius:10px;padding:16px;text-align:right;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
                  <div style="font-size:13px;font-weight:700;color:#7b63d8;">ğŸ“… ×—×ª×™××” ×¢×œ ×™××™× ×¡×¤×¦×™×¤×™×™×</div>
                  <button class="btn btn-sm" style="background:#e8e0ff;color:#7b63d8;border:1px solid #d8c8f5;font-size:11px;padding:5px 10px;" onclick="setSignToday()">ğŸ“Œ ×¡××Ÿ ×œ×”×™×•×</button>
                </div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                  <input type="date" id="sigDayFrom" class="search-input" style="width:155px;">
                  <span style="color:var(--text2);font-size:13px;">×¢×“</span>
                  <input type="date" id="sigDayTo" class="search-input" style="width:155px;">
                </div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;">
                  <input type="password" id="sigPasswordVerifyPartial" class="search-input" placeholder="×¡×™×¡××ª ×× ×”×œ ××ª×¨" style="width:190px;">
                  <button class="btn btn-sm" style="background:#7b63d8;color:white;" onclick="signReport('partial')">ğŸ“… ×—×ª×•× ×¢×œ ×˜×•×•×— ×™××™×</button>
                </div>
              </div>
            </div>

            <!-- Signed state -->
            <div class="sig-box" id="sig-signed" style="display:none;">
              <div style="margin-bottom:12px;">
                <div class="sig-stamp">âœ“ ××•×©×¨</div>
              </div>
              <div style="color:#3a9a7a;font-weight:600;margin-top:14px;font-size:14px;" id="sig-info">××•×©×¨ ×¢×œ ×™×“×™ ×× ×”×œ ×”××ª×¨</div>
              <div id="sig-partial-info" style="color:#7b63d8;font-size:12px;margin-top:6px;display:none;"></div>
              <!-- Note when partially signed â€” can still add more -->
              <div id="sig-partial-note" style="display:none;background:#f5f0ff;border:1px solid #d8c8f5;border-radius:8px;padding:10px 14px;margin-top:12px;font-size:12px;color:#7b63d8;">
                ğŸ“… × ×™×ª×Ÿ ×œ×”××©×™×š ×•×œ×—×ª×•× ×¢×œ ×™××™× × ×•×¡×¤×™× ×‘×××¦×¢×•×ª ×”×˜×•×¤×¡ ×œ××˜×”
              </div>
              <!-- Unsign section -->
              <div style="margin-top:16px;background:#fff5f5;border:1px solid #f0c0c8;border-radius:10px;padding:14px;">
                <div style="font-size:12px;color:#c0506a;margin-bottom:10px;">×œ×‘×™×˜×•×œ ×”×—×ª×™××”, ×™×© ×œ×”×–×™×Ÿ ××ª ×¡×™×¡××ª ×× ×”×œ ×”××ª×¨:</div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <input type="password" id="unsignPassword" class="search-input" placeholder="×¡×™×¡××ª ×× ×”×œ ××ª×¨" style="width:190px;">
                  <button class="btn btn-danger btn-sm" onclick="unsignReport()">âŒ ×‘×˜×œ ××™×©×•×¨</button>
                </div>
              </div>
            </div>

            <!-- Partial signed indicator (days) -->
            <div id="sig-days-list" style="margin-top:12px;display:none;">
              <div style="font-size:12px;font-weight:700;color:#7b63d8;margin-bottom:6px;">ğŸ“… ×ª××¨×™×›×™× ×—×ª×•××™×:</div>
              <div id="sig-days-tags" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Worker Notes -->
      <div class="page" id="page-worker-notes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ ×”×¢×¨×•×ª ××™×©×™×•×ª</div>
            <button class="btn btn-success btn-sm" onclick="saveNotes('worker')">ğŸ’¾ ×©××•×¨</button>
          </div>
          <textarea class="notes-area" id="worker-notes" placeholder="×›×ª×•×‘ ×›××Ÿ ×”×¢×¨×•×ª, ×”× ×—×™×•×ª, ×•×“×‘×¨×™× ×œ×–×›×•×¨..." rows="10"></textarea>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Fullscreen Grid Overlay -->
<div id="gridFullscreenOverlay" style="display:none;position:fixed;inset:0;background:rgba(20,30,50,0.82);z-index:9999;padding:20px;box-sizing:border-box;backdrop-filter:blur(4px);">
  <div style="background:var(--card);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.3);height:100%;display:flex;flex-direction:column;overflow:hidden;">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid var(--border);flex-shrink:0;">
      <div style="display:flex;align-items:center;gap:12px;">
        <span style="font-size:20px;">ğŸ“…</span>
        <div>
          <div style="font-size:17px;font-weight:800;" id="fs-grid-title">×œ×•×— ×©×¢×•×ª ×—×•×“×©×™</div>
          <div style="font-size:12px;color:var(--text2);" id="fs-grid-subtitle"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-outline btn-sm" onclick="changeGridMonthFS(-1)">â—€ ×—×•×“×© ×§×•×“×</button>
        <span id="fs-grid-month-label" style="font-size:14px;font-weight:700;min-width:110px;text-align:center;"></span>
        <button class="btn btn-outline btn-sm" onclick="changeGridMonthFS(1)">×—×•×“×© ×”×‘× â–¶</button>

        <!-- FS Zoom control -->
        <div style="display:flex;align-items:center;gap:0;background:var(--bg3);border:1px solid var(--border);border-radius:10px;overflow:hidden;">
          <button onclick="stepGridZoom(-0.5, true)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="×”×§×˜×Ÿ">âˆ’</button>
          <div style="width:1px;height:20px;background:var(--border);"></div>
          <div style="display:flex;align-items:center;gap:4px;padding:0 8px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color:var(--text3);flex-shrink:0;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <span id="fs-grid-zoom-label" style="font-size:12px;font-weight:600;color:var(--text);min-width:26px;text-align:center;">13px</span>
            <input type="range" id="fs-grid-zoom-slider" min="7" max="22" step="0.5" value="13"
              oninput="applyGridZoom(this.value, true)"
              style="width:80px;cursor:pointer;accent-color:var(--accent);height:3px;appearance:none;-webkit-appearance:none;background:linear-gradient(to left, var(--accent) 0%, var(--border) 0%);border-radius:2px;outline:none;">
          </div>
          <div style="width:1px;height:20px;background:var(--border);"></div>
          <button onclick="stepGridZoom(0.5, true)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="×”×’×“×œ">+</button>
        </div>
        <button class="btn btn-outline btn-sm" onclick="fitGridToScreen(true)" style="font-size:12px;">â¬œ ×”×ª××</button>
        <button onclick="closeGridFullscreen()" style="background:#f0f0f0;border:none;border-radius:50%;width:34px;height:34px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:8px;" title="×¡×’×•×¨">âœ•</button>
      </div>
    </div>
    <!-- Legend + FS Search -->
    <div style="padding:8px 24px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap;flex-shrink:0;">
      <span style="font-size:11px;color:var(--text2);font-weight:600;">××§×¨×:</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#ddeeff;border-radius:3px;display:inline-block;border:1px solid #aaccee;"></span>×”×™×•×</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#ffe8ea;border-radius:3px;display:inline-block;border:1px solid #f0c0c4;"></span>×¡×•×£ ×©×‘×•×¢</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#f0fff4;border-radius:3px;display:inline-block;border:1px solid #a8e0b8;"></span>×™×•× ×—×ª×•× âœ“</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:white;border-radius:3px;display:inline-block;border:1px solid var(--border);color:#3366aa;font-weight:700;text-align:center;line-height:14px;font-size:9px;">8</span>×©×¢×•×ª ×¢×‘×•×“×”</span>
      <!-- Search in FS -->
      <div style="display:flex;gap:6px;align-items:center;margin-right:auto;">
        <select id="fs-grid-search-type" onchange="renderCeoWorkersGrid(true)" style="border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-size:11px;background:var(--bg3);color:var(--text);cursor:pointer;">
          <option value="name">ğŸ” ×©×</option>
          <option value="idpassport" selected>ğŸªª ×ª"×– / ×“×¨×›×•×Ÿ</option>
        </select>
        <input type="text" id="fs-grid-search-input" placeholder="×—×™×¤×•×©..." oninput="renderCeoWorkersGrid(true)"
          style="border:1px solid var(--border);border-radius:8px;padding:4px 10px;font-size:12px;background:white;color:var(--text);width:150px;font-family:inherit;">
        <span id="fs-grid-search-count" style="font-size:11px;color:var(--text2);white-space:nowrap;"></span>
        <button class="btn btn-success btn-sm" onclick="copyGridToExcelFS()" style="font-size:11px;padding:4px 10px;">ğŸ“‹ ×”×¢×ª×§ ×œ××§×¡×œ</button>
      </div>
      <span style="font-size:11px;color:var(--text3);">×œ×—×¥ ESC ××• âœ• ×œ×¡×’×™×¨×”</span>
    </div>
    <!-- Grid content -->
    <div style="flex:1;overflow:auto;padding:16px 24px;">
      <div id="fs-workers-grid-wrap"></div>
    </div>
  </div>
</div>


<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA = {
  users: [
    { id:1, username:'admin', password:'admin123', name:'×× ×”×œ ×”××¢×¨×›×ª', role:'admin', company:null, avatar:'ğŸ‘‘', avatarColor:'#6c63ff' },
    { id:2, username:'ceo_techcorp', password:'ceo123', name:'××œ×™ ×™×©×¨××œ×™', role:'ceo', company:'techcorp', avatar:'ğŸ¢', avatarColor:'#60a5fa' },
    { id:3, username:'ceo_buildpro', password:'ceo456', name:'××™×›×œ ×’×•×œ×Ÿ', role:'ceo', company:'buildpro', avatar:'ğŸ—ï¸', avatarColor:'#fb923c' },
    { id:4, username:'employee1', password:'emp123', name:'×“×•×“ ×œ×•×™', role:'employee', company:'techcorp', avatar:'ğŸ’¼', avatarColor:'#4ade80', idType:'id', idNumber:'312456789' },
    { id:5, username:'employee2', password:'emp456', name:'×©×¨×” ×¨×•×–×Ÿ', role:'employee', company:'techcorp', avatar:'ğŸ’¼', avatarColor:'#fbbf24', idType:'id', idNumber:'208754321' },
    { id:6, username:'employee3', password:'emp789', name:'×¨×•×Ÿ ××‘×Ÿ', role:'employee', company:'buildpro', avatar:'ğŸ’¼', avatarColor:'#f87171', idType:'id', idNumber:'425678901' },
    { id:7, username:'worker1', password:'work123', name:'×™×•×¡×£ ×›×”×Ÿ', role:'worker', company:'buildpro', avatar:'ğŸ”§', avatarColor:'#fb923c', idType:'id', idNumber:'234567890' },
    { id:8, username:'worker2', password:'work456', name:'××—××“ ×—×¡×Ÿ', role:'worker', company:'buildpro', avatar:'ğŸ”§', avatarColor:'#a78bfa', idType:'passport', idNumber:'AB1234567' },
    { id:9, username:'ceo_cleanit', password:'ceo789', name:'× ×•×¢×” ×©××™×¨', role:'ceo', company:'cleanit', avatar:'âœ¨', avatarColor:'#34d399' },
    { id:10, username:'employee4', password:'emp321', name:'×˜×œ ×‘×¨×§', role:'employee', company:'cleanit', avatar:'ğŸ’¼', avatarColor:'#60a5fa', idType:'id', idNumber:'316789012' },
    { id:11, username:'worker3', password:'work789', name:'×¤××“×™ ×™×•×¡×£', role:'worker', company:'techcorp', avatar:'ğŸ”§', avatarColor:'#f59e0b', idType:'passport', idNumber:'CD9876543' },
    { id:12, username:'worker4', password:'work321', name:'×’×³×•×¨×’×³ ××¡×™×—', role:'worker', company:'cleanit', avatar:'ğŸ”§', avatarColor:'#ec4899', idType:'passport', idNumber:'EF5678901' },
  ],
  companies: [
    { id:'techcorp', name:'TechCorp', emoji:'ğŸ’»', field:'×¤×™×ª×•×— ×ª×•×›× ×” ×•××¤×œ×™×§×¦×™×•×ª', employees:3, color:'#6c63ff', sigPassword:'sign123', signed:{} },
    { id:'buildpro', name:'BuildPro', emoji:'ğŸ—ï¸', field:'×‘× ×™×™×” ×•×¤×™×ª×•×— × ×“×œ"×Ÿ', employees:3, color:'#fb923c', sigPassword:'sign456', signed:{} },
    { id:'cleanit', name:'CleanIt', emoji:'âœ¨', field:'×©×™×¨×•×ª×™ × ×™×§×™×•×Ÿ ×•×ª×—×–×•×§×”', employees:2, color:'#34d399', sigPassword:'sign789', signed:{} },
  ],
  tasks: [
    { id:1, title:'×¢×™×¦×•×‘ ×“×£ ×”×‘×™×ª ×”×—×“×©', desc:'×œ×™×¦×•×¨ ××§××¤ ×œ×“×£ ×”×‘×™×ª ×”××¢×•×“×›×Ÿ', assignedTo:4, assignedBy:2, company:'techcorp', priority:'high', status:'open', dueDate:'2026-02-25', createdByEmp:false },
    { id:2, title:'×ª×™×§×•×Ÿ ×‘××’ ×‘×œ×•×’×™×Ÿ', desc:'××©×ª××©×™× ××“×•×•×—×™× ×¢×œ ×©×’×™××ª 500', assignedTo:4, assignedBy:2, company:'techcorp', priority:'high', status:'open', dueDate:'2026-02-22', createdByEmp:false },
    { id:3, title:'×›×ª×™×‘×ª ×ª×™×¢×•×“ API', desc:'×œ×ª×¢×“ ××ª ×›×œ ×”× ×§×•×“×•×ª ×”×§×™×™××•×ª', assignedTo:5, assignedBy:2, company:'techcorp', priority:'medium', status:'open', dueDate:'2026-03-01', createdByEmp:false },
    { id:4, title:'×¤×’×™×©×ª ×œ×§×•×—', desc:'×”×›× ×ª ××¦×’×ª ×œ×¤×’×™×©×”', assignedTo:5, assignedBy:2, company:'techcorp', priority:'low', status:'done', dueDate:'2026-02-18', createdByEmp:false },
    { id:5, title:'×‘×“×™×§×ª ×‘×™×¡×•×¡ ×™×¡×•×“×•×ª', desc:'×œ×‘×¦×¢ ×‘×“×™×§×” ××§×™×¤×”', assignedTo:6, assignedBy:3, company:'buildpro', priority:'high', status:'open', dueDate:'2026-02-23', createdByEmp:false },
    { id:6, title:'×ª×›× ×•×Ÿ ×ª×©×ª×™×ª ×—×©××œ', desc:'×œ×”×›×™×Ÿ ×ª×•×›× ×™×ª ××¤×•×¨×˜×ª', assignedTo:6, assignedBy:3, company:'buildpro', priority:'medium', status:'open', dueDate:'2026-02-28', createdByEmp:false },
    { id:7, title:'×”×•×¡×¤×ª ×¤×™×¦×³×¨ ×—×“×©', desc:'×”×•×¡×¤×ª ×œ×•×— ×©× ×” ×œ××©×ª××©×™×', assignedTo:4, assignedBy:4, company:'techcorp', priority:'medium', status:'open', dueDate:'2026-03-05', createdByEmp:true },
    { id:8, title:'× ×™×§×™×•×Ÿ ×—×“×¨ ×©×¨×ª×™×', desc:'×¤×¢× ×‘×©×‘×•×¢', assignedTo:10, assignedBy:9, company:'cleanit', priority:'low', status:'open', dueDate:'2026-02-27', createdByEmp:false },
  ],
  notes: {},
  quickNotes: {},
  workerHours: {},
};

let currentUser = null;
let currentPage = null;
let workerCurrentMonth = new Date().getMonth();
let workerCurrentYear = new Date().getFullYear();
let taskFilter = 'all';
let nextTaskId = 100;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH (original stubs - overridden by Appwrite layer below)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin() {
  // Overridden by Appwrite integration layer
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const user = DATA.users.find(x => x.username === u && x.password === p);
  if (!user) { document.getElementById('loginError').style.display = 'block'; return; }
  login(user);
}

function quickLogin(u, p) {
  document.getElementById('loginUser').value = u;
  document.getElementById('loginPass').value = p;
  doLogin();
}

function login(user) {
  currentUser = user;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('loginError').style.display = 'none';

  // Setup user header
  const av = document.getElementById('userAvatar');
  av.textContent = user.avatar;
  av.style.background = user.avatarColor + '33';
  av.style.color = user.avatarColor;
  document.getElementById('userName').textContent = user.name;

  const roleLabels = { admin:'×× ×”×œ ××¢×¨×›×ª', ceo:'×× ×›"×œ', employee:'×¢×•×‘×“', worker:'×¤×•×¢×œ' };
  const roleColors = { admin:'#6c63ff', ceo:'#60a5fa', employee:'#4ade80', worker:'#fb923c' };
  const badge = document.getElementById('roleBadge');
  badge.textContent = roleLabels[user.role];
  badge.style.background = roleColors[user.role] + '22';
  badge.style.color = roleColors[user.role];

  buildNav();
  routeToRole();
}

function logout() {
  // Overridden by Appwrite integration layer
  currentUser = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  closeSidebar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const navConfigs = {
  admin: [
    { page:'admin-dashboard', icon:'ğŸ“Š', label:'×œ×•×— ×‘×§×¨×”' },
    { page:'admin-companies', icon:'ğŸ¢', label:'× ×™×”×•×œ ×—×‘×¨×•×ª' },
    { page:'admin-users', icon:'ğŸ‘¥', label:'××©×ª××©×™× ×•×¡×™×¡×××•×ª' },
    { page:'admin-notes', icon:'ğŸ“', label:'×”×¢×¨×•×ª ××™×©×™×•×ª' },
    { page:'admin-ai', icon:'ğŸ¤–', label:'×¢×•×–×¨ AI' },
  ],
  ceo: [
    { page:'ceo-dashboard', icon:'ğŸ“Š', label:'×œ×•×— ×‘×§×¨×”' },
    { page:'ceo-employees', icon:'ğŸ’¼', label:'×¢×•×‘×“×™×' },
    { page:'ceo-workers', icon:'ğŸ”§', label:'×¤×•×¢×œ×™× ×•×©×¢×•×ª' },
    { page:'ceo-tasks', icon:'ğŸ“‹', label:'××©×™××•×ª' },
    { page:'ceo-credentials', icon:'ğŸ”‘', label:'×©××•×ª ××©×ª××© ×•×¡×™×¡×××•×ª' },
    { page:'ceo-notes', icon:'ğŸ“', label:'×”×¢×¨×•×ª ××™×©×™×•×ª' },
    { page:'ceo-ai', icon:'ğŸ¤–', label:'×¢×•×–×¨ AI' },
  ],
  employee: [
    { page:'emp-dashboard', icon:'ğŸ ', label:'×¨××©×™' },
    { page:'emp-tasks', icon:'ğŸ“‹', label:'×”××©×™××•×ª ×©×œ×™' },
    { page:'emp-calendar', icon:'ğŸ“…', label:'×œ×•×— ×–×× ×™×' },
    { page:'emp-notes', icon:'ğŸ“', label:'×”×¢×¨×•×ª ××™×©×™×•×ª' },
  ],
  worker: [
    { page:'worker-hours', icon:'â°', label:'×“×•×— ×©×¢×•×ª' },
    { page:'worker-notes', icon:'ğŸ“', label:'×”×¢×¨×•×ª ××™×©×™×•×ª' },
  ],
};

function buildNav() {
  const nav = document.getElementById('sidebarNav');
  const config = navConfigs[currentUser.role] || [];
  nav.innerHTML = '';
  config.forEach(item => {
    const el = document.createElement('div');
    el.className = 'nav-item';
    el.dataset.page = item.page;
    el.innerHTML = `<span class="icon">${item.icon}</span>${item.label}`;
    el.onclick = () => { goPage(item.page); closeSidebar(); };
    nav.appendChild(el);
  });
}

function goPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pg = document.getElementById('page-' + pageId);
  if (pg) pg.classList.add('active');
  const nav = document.querySelector(`[data-page="${pageId}"]`);
  if (nav) nav.classList.add('active');

  const labels = { 'admin-dashboard':'×œ×•×— ×‘×§×¨×”','admin-companies':'× ×™×”×•×œ ×—×‘×¨×•×ª','admin-users':'××©×ª××©×™×','admin-notes':'×”×¢×¨×•×ª',
    'ceo-dashboard':'×œ×•×— ×‘×§×¨×”','ceo-employees':'×¢×•×‘×“×™×','ceo-workers':'×¤×•×¢×œ×™×','ceo-tasks':'××©×™××•×ª','ceo-credentials':'×¡×™×¡×××•×ª ×”×¦×•×•×ª','ceo-notes':'×”×¢×¨×•×ª',
    'emp-dashboard':'×¨××©×™','emp-tasks':'×”××©×™××•×ª ×©×œ×™','emp-calendar':'×œ×•×— ×–×× ×™×','emp-notes':'×”×¢×¨×•×ª',
    'worker-hours':'×“×•×— ×©×¢×•×ª','worker-notes':'×”×¢×¨×•×ª' };
  document.getElementById('pageTitle').textContent = labels[pageId] || pageId;
  currentPage = pageId;
  // Clear global search on page change
  const gs = document.getElementById('globalSearch');
  if (gs) gs.value = '';
  document.getElementById('topbarInfo').textContent = '';
  renderPage(pageId);
}

function routeToRole() {
  const defaults = { admin:'admin-dashboard', ceo:'ceo-dashboard', employee:'emp-dashboard', worker:'worker-hours' };
  goPage(defaults[currentUser.role]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPage(pageId) {
  if (pageId === 'admin-companies') renderAdminCompanies();
  else if (pageId === 'admin-users') renderAdminUsers();
  else if (pageId === 'admin-notes') renderNotes('admin');
  else if (pageId === 'admin-ai') { /* page is static, just focus input */ setTimeout(() => document.getElementById('admin-ai-input')?.focus(), 100); }
  else if (pageId === 'ceo-dashboard') renderCeoDashboard();
  else if (pageId === 'ceo-employees') renderCeoEmployees();
  else if (pageId === 'ceo-workers') { renderCeoWorkers(); renderCeoWorkersGrid(false); setTimeout(() => { fitGridToScreen(false); updateSliderFill(document.getElementById('grid-zoom-slider')); }, 80); }
  else if (pageId === 'ceo-tasks') renderCeoTasks();
  else if (pageId === 'ceo-credentials') renderCeoCredentials();
  else if (pageId === 'ceo-notes') renderNotes('ceo');
  else if (pageId === 'ceo-ai') initAiPage();
  else if (pageId === 'emp-dashboard') renderEmpDashboard();
  else if (pageId === 'emp-tasks') renderEmpTasks();
  else if (pageId === 'emp-calendar') renderEmpCalendar();
  else if (pageId === 'emp-notes') renderNotes('emp');
  else if (pageId === 'worker-hours') renderWorkerHours();
  else if (pageId === 'worker-notes') renderNotes('worker');
}

// â”€â”€ ADMIN â”€â”€
function renderAdminCompanies() {
  const grid = document.getElementById('companiesGrid');
  document.getElementById('stat-companies').textContent = DATA.companies.length;
  document.getElementById('stat-users').textContent = DATA.users.filter(u => u.role !== 'admin').length;
  grid.innerHTML = DATA.companies.map(c => {
    const empCount = DATA.users.filter(u => u.company === c.id).length;
    return `
    <div class="company-card">
      <div class="company-logo" style="background:${c.color}22;font-size:24px;">${c.emoji}</div>      <div class="company-name">${c.name}</div>
      <div class="company-meta">${c.field} â€¢ ${empCount} ×× ×©×™×</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;">
        <span class="tag tag-gray">×¢×•×‘×“×™×: ${DATA.users.filter(u=>u.company===c.id&&u.role==='employee').length}</span>
        <span class="tag tag-gray">×¤×•×¢×œ×™×: ${DATA.users.filter(u=>u.company===c.id&&u.role==='worker').length}</span>
        <span class="tag tag-gray">×× ×›"×œ: ${DATA.users.filter(u=>u.company===c.id&&u.role==='ceo').length}</span>
      </div>
      <div class="company-actions">
        <button class="btn btn-outline btn-sm" onclick="editCompany('${c.id}')">âœï¸ ×¢×¨×™×›×”</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCompany('${c.id}')">ğŸ—‘ï¸ ××—×§</button>
      </div>
    </div>`;
  }).join('');
}

let adminUserSort = { field: 'name', dir: 1 };

function setSort(field) {
  if (adminUserSort.field === field) {
    adminUserSort.dir *= -1;
  } else {
    adminUserSort.field = field;
    adminUserSort.dir = 1;
  }
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active-sort'));
  const btn = document.getElementById('sort-' + field);
  if (btn) btn.classList.add('active-sort');
  // update arrow indicators
  document.querySelectorAll('.sort-btn').forEach(b => {
    const f = b.id.replace('sort-','');
    const labels = { name:'×©×', role:'×ª×¤×§×™×“', company:'×—×‘×¨×”' };
    b.textContent = labels[f] + (adminUserSort.field === f ? (adminUserSort.dir === 1 ? ' â†‘' : ' â†“') : ' â†•');
  });
  renderAdminUsers();
}

function renderAdminUsers() {
  // Populate company filter dropdown
  const companyFilter = document.getElementById('usersFilterCompany');
  if (companyFilter) {
    const cur = companyFilter.value;
    companyFilter.innerHTML = '<option value="">×›×œ ×”×—×‘×¨×•×ª</option>' +
      DATA.companies.map(c => `<option value="${c.id}" ${cur===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('');
  }

  const roleLabels = { admin:'ğŸ‘‘ ×× ×”×œ ××¢×¨×›×ª', ceo:'ğŸ¢ ×× ×›"×œ', employee:'ğŸ’¼ ×¢×•×‘×“', worker:'ğŸ”§ ×¤×•×¢×œ' };
  const searchVal = (document.getElementById('usersSearch')?.value || '').toLowerCase().trim();
  const roleFilter = document.getElementById('usersFilterRole')?.value || '';
  const companyVal = companyFilter?.value || '';

  let users = [...DATA.users];

  // Filter
  if (searchVal) users = users.filter(u =>
    u.name.toLowerCase().includes(searchVal) ||
    u.username.toLowerCase().includes(searchVal)
  );
  if (roleFilter) users = users.filter(u => u.role === roleFilter);
  if (companyVal) users = users.filter(u => u.company === companyVal);

  // Sort
  const sortField = adminUserSort.field;
  const sortDir = adminUserSort.dir;
  users.sort((a, b) => {
    let va, vb;
    if (sortField === 'name') { va = a.name; vb = b.name; }
    else if (sortField === 'role') {
      const order = { admin:0, ceo:1, employee:2, worker:3 };
      va = order[a.role] ?? 9; vb = order[b.role] ?? 9;
      return (va - vb) * sortDir;
    }
    else if (sortField === 'company') {
      const ca = DATA.companies.find(c => c.id === a.company);
      const cb = DATA.companies.find(c => c.id === b.company);
      va = ca ? ca.name : '×ª'; vb = cb ? cb.name : '×ª';
    }
    return va < vb ? -sortDir : va > vb ? sortDir : 0;
  });

  const tbody = document.getElementById('usersTableBody');
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:32px;font-size:14px;">ğŸ˜• ×œ× × ××¦××• ××©×ª××©×™×</td></tr>';
  } else {
    tbody.innerHTML = users.map(u => {
      const company = DATA.companies.find(c => c.id === u.company);
      return `
      <tr>
        <td><div style="display:flex;align-items:center;gap:8px;">
          <div style="width:30px;height:30px;border-radius:50%;background:${u.avatarColor}33;color:${u.avatarColor};display:flex;align-items:center;justify-content:center;font-size:13px;">${u.avatar}</div>
          <span style="font-weight:600;">${highlightText(u.name, searchVal)}</span>
        </div></td>
        <td>${roleLabels[u.role]}</td>
        <td>${company ? `${company.emoji} ${company.name}` : 'â€”'}</td>
        <td><code style="background:var(--bg3);padding:3px 8px;border-radius:5px;font-size:12px;">${highlightText(u.username, searchVal)}</code></td>
        <td>
          <div style="display:flex;align-items:center;gap:6px;">
            <span id="pass-display-${u.id}" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 10px;font-size:12px;font-family:monospace;letter-spacing:2px;">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
            <button onclick="togglePassView(${u.id},'${u.password}')" title="×”×¦×’/×”×¡×ª×¨ ×¡×™×¡××”" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 8px;cursor:pointer;font-size:13px;color:var(--text2);" id="eye-btn-${u.id}">ğŸ‘ï¸</button>
          </div>
        </td>
        <td>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-outline btn-sm" onclick="editUser(${u.id})">âœï¸</button>
            <button class="btn btn-outline btn-sm" onclick="changePassword(${u.id})">ğŸ”‘</button>
            ${u.role !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">ğŸ—‘ï¸</button>` : ''}
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  const countEl = document.getElementById('usersCount');
  if (countEl) countEl.textContent = `××¦×™×’ ${users.length} ××ª×•×š ${DATA.users.length} ××©×ª××©×™×`;
}

function highlightText(text, query) {
  if (!query) return text;
  const idx = text.toLowerCase().indexOf(query);
  if (idx === -1) return text;
  return text.slice(0,idx) + `<mark style="background:#fde68a;border-radius:3px;padding:0 2px;">${text.slice(idx, idx+query.length)}</mark>` + text.slice(idx+query.length);
}

// Global search handler
function handleSearch(val) {
  const q = val.toLowerCase().trim();
  if (!q) { document.getElementById('topbarInfo').textContent = ''; return; }

  if (currentPage === 'admin-users') {
    const el = document.getElementById('usersSearch');
    if (el) { el.value = val; renderAdminUsers(); }
    return;
  }
  if (currentPage === 'ceo-tasks' || currentPage === 'emp-tasks') {
    searchTasks(q);
    return;
  }
  if (currentPage === 'ceo-credentials') {
    searchCredentials(q);
    return;
  }
  if (currentPage === 'ceo-employees') {
    searchEmployees(q);
    return;
  }
}

function searchTasks(q) {
  const isCeo = currentPage === 'ceo-tasks';
  const grid = document.getElementById(isCeo ? 'ceo-tasks-grid' : 'emp-tasks-grid');
  let tasks = DATA.tasks.filter(t =>
    (isCeo ? t.company === currentUser.company : t.assignedTo === currentUser.id) &&
    (t.title.toLowerCase().includes(q) || (t.desc || '').toLowerCase().includes(q))
  );
  renderTaskCards(grid, tasks, isCeo ? 'ceo' : 'emp');
  document.getElementById('topbarInfo').textContent = `${tasks.length} ×ª×•×¦××•×ª`;
}

function searchEmployees(q) {
  const tbody = document.getElementById('ceo-employees-table');
  const emps = DATA.users.filter(u =>
    u.company === currentUser.company && u.role === 'employee' &&
    (u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q))
  );
  if (!emps.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:24px;">×œ× × ××¦××• ×ª×•×¦××•×ª</td></tr>'; return; }
  renderCeoEmployees();
}

function searchCredentials(q) {
  // Re-render with highlight
  renderCeoCredentials(q);
}


// â”€â”€ CEO â”€â”€
function renderCeoDashboard() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  document.getElementById('ceo-company-emoji').textContent = company.emoji;
  document.getElementById('ceo-company-name').textContent = company.name;
  document.getElementById('ceo-company-field').textContent = company.field;

  const emps = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const tasks = DATA.tasks.filter(t => t.company === currentUser.company);
  const openTasks = tasks.filter(t => t.status === 'open');
  const doneTasks = tasks.filter(t => t.status === 'done');

  document.getElementById('ceo-stat-employees').textContent = emps.length;
  document.getElementById('ceo-stat-workers').textContent = workers.length;
  document.getElementById('ceo-stat-tasks').textContent = openTasks.length;
  document.getElementById('ceo-stat-done').textContent = doneTasks.length;
}

function renderCeoEmployees() {
  const tbody = document.getElementById('ceo-employees-table');
  const emps = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  if (!emps.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:24px;">××™×Ÿ ×¢×•×‘×“×™×</td></tr>'; return; }
  tbody.innerHTML = emps.map(emp => {
    const empTasks = DATA.tasks.filter(t => t.assignedTo === emp.id);
    const open = empTasks.filter(t => t.status === 'open').length;
    const done = empTasks.filter(t => t.status === 'done').length;
    const total = empTasks.length;
    const pct = total ? Math.round(done/total*100) : 0;
    return `
    <tr>
      <td><div style="display:flex;align-items:center;gap:8px;">
        <div style="width:32px;height:32px;border-radius:50%;background:${emp.avatarColor}33;color:${emp.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:700;">${emp.name[0]}</div>
        <div><div style="font-weight:600;">${emp.name}</div><div style="font-size:11px;color:var(--text3);">${emp.username}</div></div>
      </div></td>
      <td><span class="tag tag-blue">×¢×•×‘×“</span></td>
      <td><span class="tag tag-yellow">${open}</span></td>
      <td><span class="tag tag-green">${done}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="progress-bar" style="width:100px;"><div class="progress-fill" style="width:${pct}%;background:#7bb3d8;"></div></div>
          <span style="font-size:12px;color:var(--text2);">${pct}%</span>
        </div>
      </td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="openAssignTask(${emp.id})">+ ××©×™××”</button>
      </td>
    </tr>`;
  }).join('');
}

function renderCeoCredentials(searchQ) {
  const empBody = document.getElementById('ceo-emp-creds-table');
  const workerBody = document.getElementById('ceo-worker-creds-table');
  const q = (searchQ || '').toLowerCase().trim();
  let emps = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  let workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  if (q) {
    emps = emps.filter(u => u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q));
    workers = workers.filter(u => u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q));
    document.getElementById('topbarInfo').textContent = `${emps.length + workers.length} ×ª×•×¦××•×ª`;
  } else {
    document.getElementById('topbarInfo').textContent = '';
  }

  function credRow(u, prefix) {
    const idIcon = u.idType === 'passport' ? 'ğŸ›‚' : 'ğŸªª';
    const idLabel = u.idType === 'passport' ? '×“×¨×›×•×Ÿ' : '×ª"×–';
    const idDisplay = u.idNumber
      ? `<span style="font-size:12px;display:flex;align-items:center;gap:4px;">${idIcon} <span style="font-family:monospace;">${u.idNumber}</span> <span style="font-size:10px;color:var(--text3);">(${idLabel})</span></span>`
      : `<span style="color:var(--text3);font-size:12px;">â€”</span>`;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:8px;">
        <div style="width:30px;height:30px;border-radius:50%;background:${u.avatarColor}33;color:${u.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;">${u.name[0]}</div>
        <span style="font-weight:600;">${highlightText(u.name, q)}</span>
      </div></td>
      <td><code style="background:var(--bg3);padding:3px 10px;border-radius:6px;font-size:13px;">${highlightText(u.username, q)}</code></td>
      <td>${idDisplay}</td>
      <td><div style="display:flex;align-items:center;gap:8px;">
        <span id="ceo-pass-${prefix}-${u.id}" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 12px;font-size:12px;font-family:monospace;letter-spacing:2px;">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
        <button onclick="ceoPwToggle('${prefix}',${u.id},'${u.password}')" id="ceo-eye-${prefix}-${u.id}" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 8px;cursor:pointer;font-size:13px;color:var(--text2);">ğŸ‘ï¸</button>
      </div></td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" onclick="ceoEditCredentials(${u.id})" title="×¢×¨×•×š ×¤×¨×˜×™ ×›× ×™×¡×”">âœï¸ ×¢×¨×•×š</button>
          <button class="btn btn-danger btn-sm" onclick="ceoDeleteMember(${u.id})" title="××—×§">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`;
  }

  empBody.innerHTML = emps.length ? emps.map(u => credRow(u,'emp')).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:20px;">××™×Ÿ ×¢×•×‘×“×™×</td></tr>';
  workerBody.innerHTML = workers.length ? workers.map(u => credRow(u,'wkr')).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:20px;">××™×Ÿ ×¤×•×¢×œ×™×</td></tr>';
}

const ceoPwVisible = {};
function ceoPwToggle(prefix, userId, password) {
  const key = `${prefix}-${userId}`;
  ceoPwVisible[key] = !ceoPwVisible[key];
  const el = document.getElementById(`ceo-pass-${key}`);
  const btn = document.getElementById(`ceo-eye-${key}`);
  if (el) el.textContent = ceoPwVisible[key] ? password : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  if (btn) btn.textContent = ceoPwVisible[key] ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
}

function ceoEditCredentials(userId) {
  const user = DATA.users.find(u => u.id === userId);
  if (!user) return;
  const roleLabel = user.role === 'employee' ? '×¢×•×‘×“' : '×¤×•×¢×œ';
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">âœï¸ ×¢×¨×™×›×ª ×¤×¨×˜×™ ×¢×•×‘×“ â€” ${user.name}</div>
    <div style="background:var(--bg3);border-radius:10px;padding:12px 16px;margin-bottom:18px;display:flex;align-items:center;gap:10px;">
      <div style="width:36px;height:36px;border-radius:50%;background:${user.avatarColor}33;color:${user.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">${user.name[0]}</div>
      <div><div style="font-weight:700;font-size:14px;">${user.name}</div><div style="font-size:11px;color:var(--text2);">${roleLabel}</div></div>
    </div>

    <!-- Name + Role -->
    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <div style="flex:2;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">×©× ××œ×</label>
        <input type="text" id="ceo-edit-name" class="form-input" value="${user.name}" placeholder="×©× ××œ×...">
      </div>
      <div style="flex:1;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">×ª×¤×§×™×“</label>
        <select id="ceo-edit-role" class="form-input" style="padding:8px 12px;">
          <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>ğŸ’¼ ×¢×•×‘×“</option>
          <option value="worker" ${user.role === 'worker' ? 'selected' : ''}>ğŸ”§ ×¤×•×¢×œ</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>×©× ××©×ª××©</label>
      <input type="text" id="ceo-edit-username" class="form-input" value="${user.username}" placeholder="×©× ××©×ª××©...">
      <div style="font-size:11px;color:var(--text3);margin-top:4px;">×©× ×”××©×ª××© ×—×™×™×‘ ×œ×”×™×•×ª ×‘×× ×’×œ×™×ª, ×œ×œ× ×¨×•×•×—×™×</div>
    </div>

    <div style="border-top:1px solid var(--border);margin:16px 0;"></div>

    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <div style="flex:1;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">×¡×•×’ ××¡××š</label>
        <select id="ceo-edit-idtype" class="form-input" style="padding:8px 12px;">
          <option value="id" ${(!user.idType || user.idType==='id') ? 'selected' : ''}>ğŸªª ×ª×¢×•×“×ª ×–×”×•×ª</option>
          <option value="passport" ${user.idType==='passport' ? 'selected' : ''}>ğŸ›‚ ×“×¨×›×•×Ÿ</option>
        </select>
      </div>
      <div style="flex:2;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">××¡×¤×¨ ××¡××š</label>
        <input type="text" id="ceo-edit-idnumber" class="form-input" value="${user.idNumber || ''}" placeholder="××¡×¤×¨ ×ª&quot;×– / ×“×¨×›×•×Ÿ...">
      </div>
    </div>

    <div style="border-top:1px solid var(--border);margin:16px 0;"></div>

    <div class="form-group">
      <label>×¡×™×¡××” ×—×“×©×” <span style="color:var(--text3);font-weight:400;font-size:11px;">(×”×©××¨ ×¨×™×§ ×× ×œ× ×¨×•×¦×” ×œ×©× ×•×ª)</span></label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="password" id="ceo-new-pass" class="form-input" placeholder="×¡×™×¡××” ×—×“×©×”..." style="flex:1;">
        <button onclick="toggleCeoNewPass()" id="ceo-new-pass-eye" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:14px;flex-shrink:0;">ğŸ‘ï¸</button>
      </div>
    </div>
    <div class="form-group">
      <label>××™××•×ª ×¡×™×¡××”</label>
      <input type="password" id="ceo-confirm-pass" class="form-input" placeholder="×”×›× ×¡ ×©×•×‘ ××ª ×”×¡×™×¡××”...">
    </div>

    <div id="ceo-pass-error" style="color:#c0506a;font-size:12px;margin-bottom:10px;display:none;padding:8px 12px;background:#fff5f5;border-radius:6px;border:1px solid #f0c0c8;"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="ceoSaveCredentials(${userId})">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
  setTimeout(() => document.getElementById('ceo-edit-name')?.focus(), 100);
}

function toggleCeoNewPass() {
  const input = document.getElementById('ceo-new-pass');
  const btn = document.getElementById('ceo-new-pass-eye');
  if (!input) return;
  input.type = input.type === 'password' ? 'text' : 'password';
  btn.textContent = input.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
}

function ceoSaveCredentials(userId) {
  const user = DATA.users.find(u => u.id === userId);
  if (!user) return;
  const errEl = document.getElementById('ceo-pass-error');
  errEl.style.display = 'none';

  const newName = document.getElementById('ceo-edit-name').value.trim();
  const newRole = document.getElementById('ceo-edit-role').value;
  const newUsername = document.getElementById('ceo-edit-username').value.trim();
  const newIdType = document.getElementById('ceo-edit-idtype').value;
  const newIdNumber = document.getElementById('ceo-edit-idnumber').value.trim();
  const newPass = document.getElementById('ceo-new-pass').value.trim();
  const confirm = document.getElementById('ceo-confirm-pass').value.trim();

  if (!newName) { errEl.textContent = 'âŒ ×©× ××œ× ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§'; errEl.style.display = 'block'; return; }
  if (!newUsername) { errEl.textContent = 'âŒ ×©× ××©×ª××© ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§'; errEl.style.display = 'block'; return; }
  if (/\s/.test(newUsername)) { errEl.textContent = 'âŒ ×©× ××©×ª××© ×œ× ×™×›×•×œ ×œ×”×›×™×œ ×¨×•×•×—×™×'; errEl.style.display = 'block'; return; }
  if (newUsername !== user.username && DATA.users.find(u => u.username === newUsername)) {
    errEl.textContent = 'âŒ ×©× ××©×ª××© ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª'; errEl.style.display = 'block'; return;
  }
  if (newPass) {
    if (newPass.length < 4) { errEl.textContent = 'âŒ ×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 4 ×ª×•×•×™×'; errEl.style.display = 'block'; return; }
    if (newPass !== confirm) { errEl.textContent = 'âŒ ×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª'; errEl.style.display = 'block'; return; }
  }

  user.name = newName;
  user.role = newRole;
  user.avatar = newRole === 'employee' ? 'ğŸ’¼' : 'ğŸ”§';
  user.avatarColor = newRole === 'employee' ? '#4ade80' : '#fb923c';
  user.username = newUsername;
  user.idType = newIdType;
  user.idNumber = newIdNumber;
  if (newPass) user.password = newPass;

  closeModal();
  renderCeoCredentials();
  awSaveUser(user); // Appwrite sync
  showToast(`âœ… ×¤×¨×˜×™ ${user.name} ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!`);
}

function ceoDeleteMember(userId) {
  const user = DATA.users.find(u => u.id === userId);
  if (!user) return;
  const roleLabel = user.role === 'employee' ? '×¢×•×‘×“' : '×¤×•×¢×œ';
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ—‘ï¸ ××—×™×§×ª ${roleLabel}</div>
    <div style="background:#fff5f5;border:1px solid #f0c0c8;border-radius:12px;padding:18px;margin-bottom:18px;text-align:center;">
      <div style="width:50px;height:50px;border-radius:50%;background:${user.avatarColor}33;color:${user.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;margin:0 auto 10px;">${user.name[0]}</div>
      <div style="font-size:17px;font-weight:800;">${user.name}</div>
      <div style="font-size:12px;color:var(--text2);margin-top:4px;">${user.username} â€¢ ${roleLabel}</div>
    </div>
    <div style="background:#fff8f0;border:1px solid #f0d0a8;border-radius:10px;padding:12px 14px;margin-bottom:18px;font-size:13px;color:#a05010;">
      âš ï¸ ××—×™×§×” ×–×• ×ª×¡×™×¨ ××ª ${user.name} ××”××¢×¨×›×ª ×œ×—×œ×•×˜×™×Ÿ ×›×•×œ×œ ×›×œ × ×ª×•× ×™ ×”×©×¢×•×ª ×©×œ×•.
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="confirmCeoDeleteMember(${userId})">ğŸ—‘ï¸ ×›×Ÿ, ××—×§</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function confirmCeoDeleteMember(userId) {
  const user = DATA.users.find(u => u.id === userId);
  if (!user) return;
  const name = user.name;
  awDeleteUser(userId); // Appwrite sync
  DATA.users.splice(DATA.users.findIndex(u => u.id === userId), 1);
  DATA.tasks.forEach(t => { if (t.assignedTo === userId) t.assignedTo = null; });
  closeModal();
  renderCeoCredentials();
  showToast(`ğŸ—‘ï¸ ${name} × ××—×§ ××”××¢×¨×›×ª`);
}

function toggleSection(sectionId, iconId) {
  const section = document.getElementById(sectionId);
  const icon = document.getElementById(iconId);
  if (!section) return;
  const isOpen = section.style.display !== 'none';
  section.style.display = isOpen ? 'none' : '';
  if (icon) icon.style.transform = isOpen ? 'rotate(-90deg)' : 'rotate(0deg)';
}

function filterWorkersTable() {
  const searchType = document.getElementById('workers-search-type')?.value || 'name';
  const searchQ = (document.getElementById('workers-search-input')?.value || '').trim().toLowerCase();
  const countEl = document.getElementById('workers-search-count');

  const tbody = document.getElementById('ceo-workers-table');
  if (!tbody) return;

  const rows = tbody.querySelectorAll('tr');
  let visible = 0;

  rows.forEach(tr => {
    const workerId = parseInt(tr.dataset.workerId);
    if (!workerId) { tr.style.display = ''; return; }
    const worker = DATA.users.find(u => u.id === workerId);
    if (!worker) { tr.style.display = ''; return; }

    let match = true;
    if (searchQ) {
      if (searchType === 'name') match = worker.name.toLowerCase().includes(searchQ);
      else match = (worker.idNumber || '').toLowerCase().includes(searchQ);
    }

    tr.style.display = match ? '' : 'none';
    if (match) visible++;
  });

  if (countEl) {
    const total = rows.length;
    countEl.textContent = searchQ ? `${visible} ××ª×•×š ${total} ×¤×•×¢×œ×™×` : '';
  }
}

function renderCeoWorkers() {
  const tbody = document.getElementById('ceo-workers-table');
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!workers.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:24px;">××™×Ÿ ×¤×•×¢×œ×™×</td></tr>'; return; }
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();

  tbody.innerHTML = workers.map(w => {
    const key = `${w.id}-${now.getFullYear()}-${now.getMonth()}`;
    const hours = DATA.workerHours[key] || {};
    const signedInfo = company && company.signed[key];
    const isFullSigned = signedInfo && signedInfo.type === 'full';
    const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

    // Calculate total, signed, and unsigned hours
    let totalH = 0, signedH = 0, unsignedH = 0;
    for (let d = 1; d <= daysInMonth; d++) {
      const v = hours[d];
      if (!v) continue;
      const h = v.start && v.end
        ? calcHoursFromTime(v.start, v.end)
        : (parseFloat(v.hours) || 0);
      if (h <= 0) continue;
      totalH += h;
      const isDaySigned = isFullSigned || partialDays.includes(d);
      if (isDaySigned) signedH += h;
      else unsignedH += h;
    }

    // Status badge
    let statusBadge;
    if (isFullSigned) {
      statusBadge = '<span class="tag tag-green">âœ… ×›×œ ×”×—×•×“×©</span>';
    } else if (partialDays.length > 0) {
      statusBadge = `<span class="tag tag-purple">ğŸ“… ${partialDays.length} ×™××™×</span>`;
    } else {
      statusBadge = '<span class="tag tag-red">âŒ ×œ× ×—×ª×•×</span>';
    }

    return `
    <tr data-worker-id="${w.id}">
      <td><div style="display:flex;align-items:center;gap:8px;">
        <div style="width:32px;height:32px;border-radius:50%;background:${w.avatarColor}33;color:${w.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:700;">${w.name[0]}</div>
        <div>
          <div style="font-weight:600;">${w.name}</div>
          ${w.idNumber ? `<div style="font-size:10px;color:var(--text3);">${w.idType==='passport'?'ğŸ›‚':'ğŸªª'} ${w.idNumber}</div>` : ''}
        </div>
      </div></td>
      <td><span style="font-size:16px;font-weight:800;color:#4a6080;">${totalH.toFixed(1)}</span> <span style="color:var(--text2);font-size:11px;">×©×¢'</span></td>
      <td><span style="font-size:15px;font-weight:700;color:#3a9a7a;">${signedH > 0 ? signedH.toFixed(1) : 'â€”'}</span>${signedH > 0 ? ' <span style="color:var(--text2);font-size:11px;">×©×¢\'</span>' : ''}</td>
      <td><span style="font-size:15px;font-weight:700;color:${unsignedH > 0 ? '#c07030' : 'var(--text3)'};">${unsignedH > 0 ? unsignedH.toFixed(1) : 'â€”'}</span>${unsignedH > 0 ? ' <span style="color:var(--text2);font-size:11px;">×©×¢\'</span>' : ''}</td>
      <td>${statusBadge}</td>
      <td><button class="btn btn-outline btn-sm" onclick="viewWorkerReport(${w.id})">ğŸ‘ï¸ ×¦×¤×™×™×”</button></td>
      <td><div style="display:flex;gap:6px;">
        ${signedInfo ? `<button class="btn btn-outline btn-sm" onclick="ceoUnsignWorker(${w.id})" title="×‘×˜×œ ×—×ª×™××”">ğŸ”“ ×‘×˜×œ</button>` : ''}
        <button class="btn btn-danger btn-sm" onclick="removeWorker(${w.id})">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  }).join('');

  // Update current sig password display
  if (company) {
    document.getElementById('sigPasswordInput').value = '';
    const dispEl = document.getElementById('current-sig-pass-display');
    if (dispEl) { dispEl.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; dispEl.dataset.pass = company.sigPassword || ''; }
    const eyeEl = document.getElementById('current-sig-pass-eye');
    if (eyeEl) eyeEl.textContent = 'ğŸ‘ï¸';
    sigPassVisible = false;
  }
}

let gridZoomNormal = 11;   // px for inline grid
let gridZoomFS = 13;       // px for fullscreen grid

function stepGridZoom(delta, isFS) {
  const currentVal = isFS ? gridZoomFS : gridZoomNormal;
  const min = isFS ? 7 : 7;
  const max = isFS ? 22 : 18;
  const newVal = Math.min(max, Math.max(min, currentVal + delta));
  applyGridZoom(newVal, isFS);
}

function updateSliderFill(slider) {
  if (!slider) return;
  const min = parseFloat(slider.min);
  const max = parseFloat(slider.max);
  const val = parseFloat(slider.value);
  const pct = ((val - min) / (max - min)) * 100;
  slider.style.background = `linear-gradient(to left, var(--accent) ${pct}%, var(--border) ${pct}%)`;
}

function applyGridZoom(val, isFS) {
  const size = parseFloat(val);
  const cellW = Math.max(28, Math.round(size * 3.0));
  const nameW = Math.max(80, Math.round(size * 9));

  if (isFS) {
    gridZoomFS = size;
    const lbl = document.getElementById('fs-grid-zoom-label');
    const slider = document.getElementById('fs-grid-zoom-slider');
    if (lbl) lbl.textContent = Math.round(size) + 'px';
    if (slider) { slider.value = size; updateSliderFill(slider); }
    const table = document.querySelector('#fs-workers-grid-wrap .hours-grid-table');
    if (table) applyZoomToTable(table, size, cellW, nameW);
  } else {
    gridZoomNormal = size;
    const lbl = document.getElementById('grid-zoom-label');
    const slider = document.getElementById('grid-zoom-slider');
    if (lbl) lbl.textContent = Math.round(size) + 'px';
    if (slider) { slider.value = size; updateSliderFill(slider); }
    const table = document.querySelector('#workers-grid-wrap .hours-grid-table');
    if (table) applyZoomToTable(table, size, cellW, nameW);
  }
}

function fitGridToScreen(isFS) {
  // Calculate the available width and compute optimal font size so all columns fit
  const daysInMonth = new Date(gridYear, gridMonth + 1, 0).getDate();
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');

  let containerWidth;
  if (isFS) {
    containerWidth = window.innerWidth - 80; // overlay padding
  } else {
    const container = document.getElementById('grid-scroll-container');
    containerWidth = container ? container.clientWidth : window.innerWidth - 300;
  }

  // nameCol + daysInMonth day cols + total col
  // Try sizes from 7 to 18, pick the largest that fits
  let bestSize = 7;
  for (let s = 18; s >= 7; s -= 0.5) {
    const cellW = Math.max(28, Math.round(s * 3.0));
    const nameW = Math.max(80, Math.round(s * 9));
    const totalWidth = nameW + (daysInMonth * cellW) + 55; // 55 for totals col
    if (totalWidth <= containerWidth) {
      bestSize = s;
      break;
    }
  }

  applyGridZoom(bestSize, isFS);
  applyGridZoom(bestSize, isFS);
}


function applyZoomToTable(table, size, cellW, nameW) {
  table.style.fontSize = size + 'px';
  // Set th/td sizes
  const allTh = table.querySelectorAll('th');
  const allTd = table.querySelectorAll('td');
  allTh.forEach(el => {
    if (el.classList.contains('worker-name-col')) { el.style.minWidth = nameW + 'px'; el.style.maxWidth = (nameW + 20) + 'px'; }
    else { el.style.minWidth = cellW + 'px'; el.style.padding = Math.max(2, size * 0.4) + 'px ' + Math.max(1, size * 0.2) + 'px'; }
  });
  allTd.forEach(el => {
    if (el.classList.contains('worker-name-td')) { el.style.minWidth = nameW + 'px'; }
    else if (!el.classList.contains('total-td')) { el.style.minWidth = cellW + 'px'; el.style.padding = Math.max(2, size * 0.4) + 'px ' + Math.max(1, size * 0.2) + 'px'; }
  });
}

function openGridFullscreen() {
  const overlay = document.getElementById('gridFullscreenOverlay');
  overlay.style.display = 'block';
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const subtitle = document.getElementById('fs-grid-subtitle');
  if (subtitle) subtitle.textContent = `${company ? company.name : ''} â€¢ ${workers.length} ×¤×•×¢×œ×™×`;
  // Sync FS slider
  const fsSlider = document.getElementById('fs-grid-zoom-slider');
  const fsLbl = document.getElementById('fs-grid-zoom-label');
  if (fsSlider) fsSlider.value = gridZoomFS;
  if (fsLbl) fsLbl.textContent = gridZoomFS + 'px';
  renderCeoWorkersGrid(true);
  document.addEventListener('keydown', _fsGridEscHandler);
}

function closeGridFullscreen() {
  document.getElementById('gridFullscreenOverlay').style.display = 'none';
  document.removeEventListener('keydown', _fsGridEscHandler);
}

function _fsGridEscHandler(e) {
  if (e.key === 'Escape') closeGridFullscreen();
}

function changeGridMonthFS(delta) {
  gridMonth += delta;
  if (gridMonth > 11) { gridMonth = 0; gridYear++; }
  if (gridMonth < 0) { gridMonth = 11; gridYear--; }
  // Update both grids
  renderCeoWorkersGrid(false);
  renderCeoWorkersGrid(true);
}


let gridYear = new Date().getFullYear();
let gridMonth = new Date().getMonth();

function changeGridMonth(delta) {
  gridMonth += delta;
  if (gridMonth > 11) { gridMonth = 0; gridYear++; }
  if (gridMonth < 0) { gridMonth = 11; gridYear--; }
  renderCeoWorkersGrid(false);
}

function renderCeoWorkersGrid(fullscreen) {
  const monthNames = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
  const dayNames = ['××³','×‘×³','×’×³','×“×³','×”×³','×•×³','×©×³'];
  const monthLabel = `${monthNames[gridMonth]} ${gridYear}`;

  // Update both month labels
  const labelEl = document.getElementById('grid-month-label');
  if (labelEl) labelEl.textContent = monthLabel;
  const fsLabelEl = document.getElementById('fs-grid-month-label');
  if (fsLabelEl) fsLabelEl.textContent = monthLabel;

  const wrap = document.getElementById(fullscreen ? 'fs-workers-grid-wrap' : 'workers-grid-wrap');
  if (!wrap) return;

  let workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const company = DATA.companies.find(c => c.id === currentUser.company);

  // Apply search filter (inline or fullscreen)
  const searchTypeId = fullscreen ? 'fs-grid-search-type' : 'grid-search-type';
  const searchInputId = fullscreen ? 'fs-grid-search-input' : 'grid-search-input';
  const searchCountId = fullscreen ? 'fs-grid-search-count' : 'grid-search-count';
  const searchType = document.getElementById(searchTypeId)?.value || 'name';
  const searchQ = (document.getElementById(searchInputId)?.value || '').trim().toLowerCase();
  const showIdInCell = searchType === 'idpassport'; // show ID number column regardless of search text

  if (searchQ) {
    workers = workers.filter(w => {
      if (searchType === 'name') return w.name.toLowerCase().includes(searchQ);
      if (searchType === 'idpassport') return (w.idNumber || '').toLowerCase().includes(searchQ);
      return true;
    });
  }
  const countEl = document.getElementById(searchCountId);
  if (countEl) {
    const totalWorkers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker').length;
    countEl.textContent = searchQ ? `${workers.length} ××ª×•×š ${totalWorkers} ×¤×•×¢×œ×™×` : '';
  }

  if (!workers.length) { wrap.innerHTML = '<div style="text-align:center;color:var(--text3);padding:24px;">×œ× × ××¦××• ×¤×•×¢×œ×™× ×ª×•×××™× ×œ×—×™×¤×•×©</div>'; return; }

  const daysInMonth = new Date(gridYear, gridMonth + 1, 0).getDate();
  const todayDate = new Date();
  const todayDay = (todayDate.getFullYear() === gridYear && todayDate.getMonth() === gridMonth) ? todayDate.getDate() : -1;

  // Header column label changes when showing IDs
  const nameColLabel = showIdInCell ? '×ª"×– / ×“×¨×›×•×Ÿ \\ ×™×•×' : '×¤×•×¢×œ \\ ×™×•×';
  let headerCells = `<th class="worker-name-col">${nameColLabel}</th>`;
  for (let d = 1; d <= daysInMonth; d++) {
    const dayIdx = new Date(gridYear, gridMonth, d).getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const isToday = d === todayDay;
    const cls = isToday ? 'today-col' : (isWeekend ? 'weekend-col' : '');
    const todayMark = isToday ? '<div style="font-size:7px;margin-top:1px;color:#3366aa;">â—</div>' : '';
    headerCells += `<th class="${cls}" title="${d}/${gridMonth+1} ${dayNames[dayIdx]}">${d}<br><span style="font-size:8px;opacity:0.7;">${dayNames[dayIdx]}</span>${todayMark}</th>`;
  }
  headerCells += `<th class="total-col">×¡×”"×›</th>`;

  // Build worker rows
  let workerRows = '';
  const dayTotals = new Array(daysInMonth + 1).fill(0);

  workers.forEach(w => {
    const key = `${w.id}-${gridYear}-${gridMonth}`;
    const hours = DATA.workerHours[key] || {};
    const signedInfo = company && company.signed[key];
    const isFullSigned = signedInfo && signedInfo.type === 'full';
    const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

    let workerTotal = 0;
    let dayCells = '';
    for (let d = 1; d <= daysInMonth; d++) {
      const dayIdx = new Date(gridYear, gridMonth, d).getDay();
      const isWeekend = dayIdx === 5 || dayIdx === 6;
      const isToday = d === todayDay;
      const entry = hours[d];
      const h = entry
        ? (entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours) || 0))
        : 0;
      if (h > 0) { workerTotal += h; dayTotals[d] += h; }
      const isDaySigned = isFullSigned || partialDays.includes(d);

      let cls = '';
      if (isToday) cls = 'today-col';
      else if (isWeekend) cls = 'weekend-col';
      if (isDaySigned && h > 0) cls += ' signed-cell';
      if (h > 0) cls += ' has-hours';

      const signedDot = isDaySigned && h > 0 ? '<span style="color:#3a9a7a;font-size:7px;display:block;line-height:1;">âœ“</span>' : '';
      const display = h > 0 ? (h % 1 === 0 ? h.toFixed(0) : h.toFixed(1)) : '';
      dayCells += `<td class="${cls.trim()}" title="${d}/${gridMonth+1}: ${h > 0 ? h.toFixed(1)+' ×©×¢×•×ª' : '×œ×œ× × ×•×›×—×•×ª'}">${display}${signedDot}</td>`;
    }

    // Name cell content: show ID number when in ID search mode
    const idIcon = w.idType === 'passport' ? 'ğŸ›‚' : 'ğŸªª';
    const nameCellContent = showIdInCell
      ? `<div style="display:flex;align-items:center;gap:4px;"><span style="font-size:11px;">${idIcon}</span><span style="font-family:monospace;font-size:10px;">${w.idNumber || 'â€”'}</span></div>`
      : `<div style="display:flex;align-items:center;gap:5px;">
          <div style="width:20px;height:20px;border-radius:50%;background:${w.avatarColor}33;color:${w.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:9px;flex-shrink:0;">${w.name[0]}</div>
          <span>${w.name}</span>
        </div>`;

    workerRows += `
    <tr>
      <td class="worker-name-td" title="${w.name}${w.idNumber ? ' | '+(w.idType==='passport'?'×“×¨×›×•×Ÿ':'×ª"×–')+': '+w.idNumber : ''}">
        ${nameCellContent}
      </td>
      ${dayCells}
      <td class="total-td" title="×¡×”&quot;×› ×©×¢×•×ª ×—×•×“×©×™">${workerTotal > 0 ? workerTotal.toFixed(1) : 'â€”'}</td>
    </tr>`;
  });

  // Build totals row
  let totalCells = '';
  let grandTotal = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    const dayIdx = new Date(gridYear, gridMonth, d).getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const isToday = d === todayDay;
    grandTotal += dayTotals[d];
    const cls = isToday ? 'today-col' : (isWeekend ? 'weekend-col' : '');
    totalCells += `<td class="${cls}" style="font-weight:800;color:#4a6080;">${dayTotals[d] > 0 ? dayTotals[d].toFixed(1) : ''}</td>`;
  }

  wrap.innerHTML = `
    <table class="hours-grid-table">
      <thead><tr>${headerCells}</tr></thead>
      <tbody>
        ${workerRows}
        <tr class="total-row">
          <td class="worker-name-td" style="color:var(--text2);font-size:10px;">×¡×”"×› ×™×•××™</td>
          ${totalCells}
          <td class="total-td">${grandTotal > 0 ? grandTotal.toFixed(1) : 'â€”'}</td>
        </tr>
      </tbody>
    </table>`;

  // Apply current zoom level after render
  const currentSize = fullscreen ? gridZoomFS : gridZoomNormal;
  const appliedCellW = Math.max(28, Math.round(currentSize * 3.0));
  const appliedNameW = Math.max(80, Math.round(currentSize * 9));
  const renderedTable = wrap.querySelector('.hours-grid-table');
  if (renderedTable) applyZoomToTable(renderedTable, currentSize, appliedCellW, appliedNameW);
}

function copyGridToExcel() { _copyGridToExcelImpl(false); }
function copyGridToExcelFS() { _copyGridToExcelImpl(true); }

function _copyGridToExcelImpl(fullscreen) {
  const monthNames = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const daysInMonth = new Date(gridYear, gridMonth + 1, 0).getDate();
  const m = gridMonth + 1;

  // Apply same search filter as the current view
  const searchTypeId = fullscreen ? 'fs-grid-search-type' : 'grid-search-type';
  const searchInputId = fullscreen ? 'fs-grid-search-input' : 'grid-search-input';
  const searchType = document.getElementById(searchTypeId)?.value || 'name';
  const searchQ = (document.getElementById(searchInputId)?.value || '').trim().toLowerCase();
  let workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  if (searchQ) {
    workers = workers.filter(w => {
      if (searchType === 'name') return w.name.toLowerCase().includes(searchQ);
      if (searchType === 'idpassport') return (w.idNumber || '').toLowerCase().includes(searchQ);
      return true;
    });
  }

  const showId = searchType === 'idpassport';

  const rows = [];
  rows.push([`×œ×•×— ×©×¢×•×ª - ${monthNames[gridMonth]} ${gridYear} - ${company ? company.name : ''}`]);
  rows.push([]);

  const headerRow = [showId ? '×ª"×– / ×“×¨×›×•×Ÿ' : '×©× ×¤×•×¢×œ'];
  for (let d = 1; d <= daysInMonth; d++) headerRow.push(`${d}.${m}`);
  headerRow.push('×¡×”"×›');
  rows.push(headerRow);

  const dayTotals = new Array(daysInMonth + 1).fill(0);
  workers.forEach(w => {
    const key = `${w.id}-${gridYear}-${gridMonth}`;
    const hours = DATA.workerHours[key] || {};
    let workerTotal = 0;
    const workerRow = [showId ? (w.idNumber || 'â€”') : w.name];
    for (let d = 1; d <= daysInMonth; d++) {
      const entry = hours[d];
      const h = entry ? (entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours) || 0)) : 0;
      workerTotal += h;
      dayTotals[d] += h;
      workerRow.push(h > 0 ? h : '');
    }
    workerRow.push(workerTotal > 0 ? workerTotal : '');
    rows.push(workerRow);
  });

  const totalsRow = ['×¡×”"×› ×™×•××™'];
  let grandTotal = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    grandTotal += dayTotals[d];
    totalsRow.push(dayTotals[d] > 0 ? dayTotals[d] : '');
  }
  totalsRow.push(grandTotal > 0 ? grandTotal : '');
  rows.push([]);
  rows.push(totalsRow);

  rows.push([]);
  rows.push(['×¡×˜×˜×•×¡ ×—×ª×™××”:']);
  workers.forEach(w => {
    const key = `${w.id}-${gridYear}-${gridMonth}`;
    const signedInfo = company && company.signed[key];
    let status = '×œ× ×—×ª×•×';
    if (signedInfo && signedInfo.type === 'full') status = `×—×ª×•× - ×›×œ ×”×—×•×“×© (${signedInfo.date})`;
    else if (signedInfo && signedInfo.type === 'partial') status = `×—×ª×•× ×—×œ×§×™×ª - ×ª××¨×™×›×™×: ${signedInfo.days.join(', ')} (${signedInfo.date})`;
    rows.push([showId ? (w.idNumber || w.name) : w.name, status]);
  });

  const tsv = rows.map(row => row.join('\t')).join('\n');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(tsv).then(() => showToast('âœ… ×”×•×¢×ª×§! ×¤×ª×— ××§×¡×œ ×•×œ×—×¥ Ctrl+V ×œ×”×“×‘×§×”', 'success')).catch(() => fallbackCopy(tsv));
  } else {
    fallbackCopy(tsv);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try {
    document.execCommand('copy');
    showToast('âœ… ×”×•×¢×ª×§! ×¤×ª×— ××§×¡×œ ×•×œ×—×¥ Ctrl+V ×œ×”×“×‘×§×”', 'success');
  } catch {
    showToast('âŒ ×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§, × ×¡×” ×©× ×™×ª', 'error');
  }
  document.body.removeChild(ta);
}

function renderCeoTasks() {
  const grid = document.getElementById('ceo-tasks-grid');
  let tasks = DATA.tasks.filter(t => t.company === currentUser.company);

  // Populate employee filter dropdown (employees only, not workers)
  const empFilter = document.getElementById('ceo-task-employee-filter');
  if (empFilter) {
    const currentVal = empFilter.value;
    const companyEmployees = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
    empFilter.innerHTML = '<option value="">ğŸ’¼ ×›×œ ×”×¢×•×‘×“×™×</option>' +
      companyEmployees.map(u =>
        `<option value="${u.id}" ${currentVal == u.id ? 'selected' : ''}>ğŸ’¼ ${u.name}</option>`
      ).join('');
    if (currentVal) empFilter.value = currentVal;
  }

  // Apply status/priority filter
  if (taskFilter === 'open') tasks = tasks.filter(t => t.status === 'open');
  else if (taskFilter === 'done') tasks = tasks.filter(t => t.status === 'done');
  else if (taskFilter === 'high') tasks = tasks.filter(t => t.priority === 'high');

  // Apply employee filter
  const selectedEmp = empFilter?.value;
  if (selectedEmp) tasks = tasks.filter(t => String(t.assignedTo) === String(selectedEmp));

  renderTaskCards(grid, tasks, 'ceo');
}

// â”€â”€ CEO AI ASSISTANT â”€â”€
let aiChatHistory = [];

function initAiPage() {
  // Reset scroll on enter
  const msgs = document.getElementById('ai-chat-messages');
  if (msgs) msgs.scrollTop = msgs.scrollHeight;
}

function clearAiChat() {
  aiChatHistory = [];
  const msgs = document.getElementById('ai-chat-messages');
  msgs.innerHTML = `
    <div id="ai-welcome-msg" style="text-align:center;padding:32px 16px;color:var(--text2);">
      <div style="font-size:40px;margin-bottom:12px;">ğŸ¤–</div>
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:6px;">×©×œ×•×! ×× ×™ ×”×¢×•×–×¨ ×”×—×›× ×©×œ×š</div>
      <div style="font-size:13px;">×× ×™ ×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×¢×œ ×”×¤×•×¢×œ×™×, ×”×¢×•×‘×“×™×, ×”××©×™××•×ª, ×•×©×¢×•×ª ×”×¢×‘×•×“×” ×‘×—×‘×¨×” ×©×œ×š.<br>×× ×™ ×™×›×•×œ ×’× ×œ×‘×¦×¢ ×¤×¢×•×œ×•×ª ×›××• ×™×¦×™×¨×ª ××©×™××•×ª ×•×¢×•×“.</div>
    </div>`;
  document.getElementById('ai-suggestions').style.display = 'flex';
}

function sendAiSuggestion(text) {
  document.getElementById('ai-input').value = text;
  sendAiMessage();
}

function buildCompanyContext() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const employees = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const tasks = DATA.tasks.filter(t => t.company === currentUser.company);
  const now = new Date();
  const monthNames = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

  // Build worker hours summary for current month
  const workerHoursSummary = workers.map(w => {
    const key = `${w.id}-${now.getFullYear()}-${now.getMonth()}`;
    const hours = DATA.workerHours[key] || {};
    let total = 0;
    Object.values(hours).forEach(e => {
      const h = e.start && e.end ? calcHoursFromTime(e.start, e.end) : (parseFloat(e.hours)||0);
      total += h;
    });
    const signedInfo = company && company.signed[key];
    const signStatus = signedInfo ? (signedInfo.type === 'full' ? '×—×ª×•× ×›×œ ×”×—×•×“×©' : `×—×ª×•× ×—×œ×§×™×ª (${signedInfo.days?.length || 0} ×™××™×)`) : '×œ× ×—×ª×•×';
    return `  - ${w.name} (×ª"×–/×“×¨×›×•×Ÿ: ${w.idNumber||'×œ× ×”×•×–×Ÿ'}, ${w.idType==='passport'?'×“×¨×›×•×Ÿ':'×ª"×–'}): ${total.toFixed(1)} ×©×¢×•×ª ×”×—×•×“×©, ×¡×˜×˜×•×¡: ${signStatus}`;
  }).join('\n');

  const tasksSummary = tasks.map(t => {
    const assignee = DATA.users.find(u => u.id === t.assignedTo);
    return `  - "${t.title}" | ×¢×“×™×¤×•×ª: ${t.priority==='high'?'×’×‘×•×”×”':t.priority==='medium'?'×‘×™× ×•× ×™×ª':'× ××•×›×”'} | ×¡×˜×˜×•×¡: ${t.status==='open'?'×¤×ª×•×—×”':'×”×•×©×œ××”'} | ××•×§×¦×” ×œ: ${assignee?.name||'â€”'} | ×ª××¨×™×š ×™×¢×“: ${t.dueDate}`;
  }).join('\n');

  return `××ª×” ×¢×•×–×¨ AI ×—×›× ×©×œ ×× ×›"×œ ×—×‘×¨×”. ××ª×” ××“×‘×¨ ×¢×‘×¨×™×ª ×‘×œ×‘×“. ××ª×” ××›×™×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ ×”×—×‘×¨×” ×•×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×•×œ×‘×¦×¢ ××©×™××•×ª.

== ×¤×¨×˜×™ ×”×—×‘×¨×” ==
×©×: ${company?.name || 'â€”'}
×ª×—×•×: ${company?.field || 'â€”'}
×× ×›"×œ: ${currentUser.name}
×ª××¨×™×š ×”×™×•×: ${now.toLocaleDateString('he-IL')} (${monthNames[now.getMonth()]} ${now.getFullYear()})

== ×¢×•×‘×“×™× (${employees.length}) ==
${employees.map(e => `  - ${e.name} (×©× ××©×ª××©: ${e.username})`).join('\n') || '  ××™×Ÿ ×¢×•×‘×“×™×'}

== ×¤×•×¢×œ×™× (${workers.length}) ==
${workers.map(w => `  - ${w.name} (×ª"×–/×“×¨×›×•×Ÿ: ${w.idNumber||'×œ× ×”×•×–×Ÿ'})`).join('\n') || '  ××™×Ÿ ×¤×•×¢×œ×™×'}

== ×©×¢×•×ª ×¢×‘×•×“×” ×—×•×“×© × ×•×›×—×™ (${monthNames[now.getMonth()]}) ==
${workerHoursSummary || '  ××™×Ÿ × ×ª×•× ×™×'}

== ××©×™××•×ª (${tasks.length}) ==
${tasksSummary || '  ××™×Ÿ ××©×™××•×ª'}

== ×”×•×¨××•×ª ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×•×ª ==
×× ×”××©×ª××© ××‘×§×© ×œ×‘×¦×¢ ×¤×¢×•×œ×” (×›×’×•×Ÿ ×™×¦×™×¨×ª ××©×™××”, ×©×™× ×•×™ ×¡×˜×˜×•×¡, ×•×›×•'), ×ª××¨ ×‘×“×™×•×§ ××” ××ª×” ××‘×¦×¢ ×•×‘×¡×•×£ ×”×”×•×“×¢×” ×”×•×¡×£ JSON ×‘×¤×•×¨××˜ ×”×‘× ×‘×ª×•×š ×ª×’×™×•×ª <ACTION>:
<ACTION>{"type":"create_task","title":"×›×•×ª×¨×ª","desc":"×ª×™××•×¨","assignedTo":"×©× ×”×¢×•×‘×“","priority":"high|medium|low","dueDate":"YYYY-MM-DD"}</ACTION>
××• ×œ×¡×’×™×¨×ª ××©×™××”:
<ACTION>{"type":"close_task","title":"×—×œ×§ ××”×›×•×ª×¨×ª"}</ACTION>
××• ×œ×¤×ª×™×—×ª ××©×™××”:
<ACTION>{"type":"open_task","title":"×—×œ×§ ××”×›×•×ª×¨×ª"}</ACTION>

×× ××™×Ÿ ×¤×¢×•×œ×” ×œ×‘×™×¦×•×¢, ××œ ×ª×•×¡×™×£ ×ª×’×™×•×ª ACTION.
×¢× ×” ×‘×¦×•×¨×” ×™×“×™×“×•×ª×™×ª, ×ª××¦×™×ª×™×ª ×•××§×¦×•×¢×™×ª ×‘×¢×‘×¨×™×ª.`;
}

async function sendAiMessage() {
  const input = document.getElementById('ai-input');
  const text = input.value.trim();
  if (!text) return;

  // Hide welcome + suggestions
  const welcome = document.getElementById('ai-welcome-msg');
  if (welcome) welcome.remove();
  document.getElementById('ai-suggestions').style.display = 'none';

  input.value = '';
  input.disabled = true;
  document.getElementById('ai-send-btn').disabled = true;

  const msgs = document.getElementById('ai-chat-messages');

  // Add user message
  msgs.innerHTML += `
    <div style="display:flex;justify-content:flex-start;">
      <div style="max-width:75%;background:#e8e0ff;border-radius:14px 14px 4px 14px;padding:10px 14px;font-size:13px;line-height:1.6;color:var(--text);">${text.replace(/\n/g,'<br>')}</div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  // Add typing indicator
  const typingId = 'ai-typing-' + Date.now();
  msgs.innerHTML += `
    <div id="${typingId}" style="display:flex;justify-content:flex-end;">
      <div style="background:var(--bg3);border-radius:14px 14px 14px 4px;padding:10px 16px;font-size:13px;color:var(--text2);">
        <span style="display:inline-flex;gap:4px;align-items:center;">
          <span style="width:6px;height:6px;background:#7b63d8;border-radius:50%;animation:aiDot 1.2s infinite 0s;"></span>
          <span style="width:6px;height:6px;background:#7b63d8;border-radius:50%;animation:aiDot 1.2s infinite 0.4s;"></span>
          <span style="width:6px;height:6px;background:#7b63d8;border-radius:50%;animation:aiDot 1.2s infinite 0.8s;"></span>
        </span>
      </div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  // Add CSS animation if not present
  if (!document.getElementById('ai-dot-style')) {
    const s = document.createElement('style');
    s.id = 'ai-dot-style';
    s.textContent = '@keyframes aiDot{0%,80%,100%{opacity:0.2;transform:scale(0.8)}40%{opacity:1;transform:scale(1.2)}}';
    document.head.appendChild(s);
  }

  // Add to history
  aiChatHistory.push({ role: 'user', content: text });

  try {
    const systemPrompt = buildCompanyContext();
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: aiChatHistory
      })
    });

    const data = await response.json();
    const rawReply = data.content?.[0]?.text || 'âŒ ×œ× ×”×ª×§×‘×œ×” ×ª×’×•×‘×”';

    // Parse and execute any actions
    let displayReply = rawReply;
    const actionMatch = rawReply.match(/<ACTION>([\s\S]*?)<\/ACTION>/);
    if (actionMatch) {
      displayReply = rawReply.replace(/<ACTION>[\s\S]*?<\/ACTION>/, '').trim();
      try {
        const action = JSON.parse(actionMatch[1]);
        executeAiAction(action);
      } catch(e) { console.error('Action parse error', e); }
    }

    aiChatHistory.push({ role: 'assistant', content: rawReply });

    // Remove typing, add response
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:80%;background:var(--card);border:1px solid var(--border);border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;line-height:1.7;color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.06);">${displayReply.replace(/\n/g,'<br>')}</div>
      </div>`;
  } catch(err) {
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:80%;background:#fff5f5;border:1px solid #f0c0c8;border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;color:#c0506a;">âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-AI. × ×¡×” ×©×•×‘.</div>
      </div>`;
  }

  msgs.scrollTop = msgs.scrollHeight;
  input.disabled = false;
  document.getElementById('ai-send-btn').disabled = false;
  input.focus();
}

function executeAiAction(action) {
  if (action.type === 'create_task') {
    const assignee = DATA.users.find(u =>
      u.company === currentUser.company &&
      (u.name === action.assignedTo || u.name.includes(action.assignedTo))
    );
    const newTask = {
      id: ++nextTaskId,
      title: action.title,
      desc: action.desc || '',
      assignedTo: assignee?.id || null,
      assignedBy: currentUser.id,
      company: currentUser.company,
      priority: action.priority || 'medium',
      status: 'open',
      dueDate: action.dueDate || new Date().toISOString().split('T')[0],
      createdByEmp: false
    };
    DATA.tasks.push(newTask);
    awSaveTask(newTask); // Appwrite sync
    showToast(`âœ… ××©×™××” "${action.title}" × ×•×¦×¨×” ×¢×œ ×™×“×™ AI`);
  } else if (action.type === 'close_task') {
    const task = DATA.tasks.find(t => t.company === currentUser.company && t.title.includes(action.title));
    if (task) { task.status = 'done'; awSaveTask(task); showToast(`âœ… ××©×™××” "${task.title}" × ×¡×’×¨×”`); }
  } else if (action.type === 'open_task') {
    const task = DATA.tasks.find(t => t.company === currentUser.company && t.title.includes(action.title));
    if (task) { task.status = 'open'; awSaveTask(task); showToast(`âœ… ××©×™××” "${task.title}" × ×¤×ª×—×” ××—×“×©`); }
  }
}

// â”€â”€ ADMIN AI ASSISTANT â”€â”€
let adminAiHistory = [];

function clearAdminAiChat() {
  adminAiHistory = [];
  const msgs = document.getElementById('admin-ai-messages');
  if (!msgs) return;
  msgs.innerHTML = `
    <div id="admin-ai-welcome" style="text-align:center;padding:32px 16px;color:var(--text2);">
      <div style="font-size:40px;margin-bottom:12px;">ğŸ¤–</div>
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;">×©×œ×•× ×× ×”×œ ×”××¢×¨×›×ª!</div>
      <div style="font-size:13px;line-height:1.7;">×× ×™ ××›×™×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘××¢×¨×›×ª ×•×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ× ×”×œ ××•×ª×”.<br>
      ×× ×™ ×™×›×•×œ <strong>×œ×¢× ×•×ª ×©××œ×•×ª</strong>, ×œ×ª×ª <strong>×¢×¦×•×ª ×œ×©×™×¤×•×¨</strong>, ×•×’× <strong>×œ×‘×¦×¢ ×¤×¢×•×œ×•×ª</strong> ×›××• ×”×•×¡×¤×ª ×—×‘×¨×”, ×”×•×¡×¤×ª ××©×ª××©, ××—×™×§×”, ×•×¢×•×“.</div>
    </div>`;
  document.getElementById('admin-ai-suggestions').style.display = 'flex';
}

function sendAdminAiSuggestion(text) {
  const input = document.getElementById('admin-ai-input');
  if (input) input.value = text;
  sendAdminAiMessage();
}

function buildAdminContext() {
  const now = new Date();
  const monthNames = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

  // Companies summary
  const companiesSummary = DATA.companies.map(c => {
    const members = DATA.users.filter(u => u.company === c.id);
    const ceos = members.filter(u => u.role === 'ceo').map(u => u.name);
    const employees = members.filter(u => u.role === 'employee').length;
    const workers = members.filter(u => u.role === 'worker').length;
    const tasks = DATA.tasks.filter(t => t.company === c.id);
    const openTasks = tasks.filter(t => t.status === 'open').length;
    return `  - ${c.emoji} ${c.name} (${c.field}): ×× ×›"×œ: ${ceos.join(', ')||'××™×Ÿ'}, ${employees} ×¢×•×‘×“×™×, ${workers} ×¤×•×¢×œ×™×, ${openTasks} ××©×™××•×ª ×¤×ª×•×—×•×ª`;
  }).join('\n');

  // All users summary
  const usersSummary = DATA.users.filter(u => u.role !== 'admin').map(u => {
    const company = DATA.companies.find(c => c.id === u.company);
    const roleMap = { ceo:'×× ×›"×œ', employee:'×¢×•×‘×“', worker:'×¤×•×¢×œ' };
    return `  - ${u.name} (@${u.username}) | ${roleMap[u.role]||u.role} | ×—×‘×¨×”: ${company?.name||'×œ×œ× ×—×‘×¨×”'}`;
  }).join('\n');

  // Tasks overview
  const allTasks = DATA.tasks;
  const openTasks = allTasks.filter(t => t.status === 'open').length;
  const doneTasks = allTasks.filter(t => t.status === 'done').length;
  const highPriority = allTasks.filter(t => t.priority === 'high' && t.status === 'open').length;

  // Anomalies / insights
  const noCompanyUsers = DATA.users.filter(u => !u.company && u.role !== 'admin');
  const companiesNoCeo = DATA.companies.filter(c => !DATA.users.find(u => u.company === c.id && u.role === 'ceo'));

  return `××ª×” ×¢×•×–×¨ AI ××ª×§×“× ×©×œ ×× ×”×œ ××¢×¨×›×ª. ××ª×” ××“×‘×¨ ×¢×‘×¨×™×ª ×‘×œ×‘×“. ××ª×” ××›×™×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘××¢×¨×›×ª ×•×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª, ×œ× ×ª×—, ×œ×ª×ª ×”××œ×¦×•×ª, ×•×œ×‘×¦×¢ ×¤×¢×•×œ×•×ª × ×™×”×•×œ×™×•×ª.

== ×¤×¨×˜×™ ×× ×”×œ ×”××¢×¨×›×ª ==
×©×: ${currentUser.name}
×ª××¨×™×š: ${now.toLocaleDateString('he-IL')} (${monthNames[now.getMonth()]} ${now.getFullYear()})

== ×¡×™×›×•× ××¢×¨×›×ª ==
×¡×”"×› ×—×‘×¨×•×ª: ${DATA.companies.length}
×¡×”"×› ××©×ª××©×™× (×œ× ×›×•×œ×œ ×× ×”×œ): ${DATA.users.filter(u=>u.role!=='admin').length}
×¡×”"×› ××©×™××•×ª: ${allTasks.length} (×¤×ª×•×—×•×ª: ${openTasks}, ×”×•×©×œ××•: ${doneTasks}, ×“×—×•×¤×•×ª: ${highPriority})

== ×—×‘×¨×•×ª (${DATA.companies.length}) ==
${companiesSummary || '  ××™×Ÿ ×—×‘×¨×•×ª'}

== ×›×œ ×”××©×ª××©×™× ==
${usersSummary || '  ××™×Ÿ ××©×ª××©×™×'}

${noCompanyUsers.length ? `== âš ï¸ ××©×ª××©×™× ×œ×œ× ×—×‘×¨×” (${noCompanyUsers.length}) ==\n${noCompanyUsers.map(u=>`  - ${u.name} (@${u.username})`).join('\n')}` : ''}
${companiesNoCeo.length ? `== âš ï¸ ×—×‘×¨×•×ª ×œ×œ× ×× ×›"×œ (${companiesNoCeo.length}) ==\n${companiesNoCeo.map(c=>`  - ${c.emoji} ${c.name}`).join('\n')}` : ''}

== ×”×•×¨××•×ª ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×•×ª ==
×›×©×”××©×ª××© ××‘×§×© ×œ×‘×¦×¢ ×¤×¢×•×œ×”, ×ª××¨ ××” ××ª×” ×¢×•×©×” ×•×‘×¡×•×£ ×”×•×¡×£ JSON ×‘×ª×’×™×•×ª <ADMIN_ACTION>:

×”×•×¡×¤×ª ×—×‘×¨×”:
<ADMIN_ACTION>{"type":"add_company","name":"×©×","field":"×ª×—×•×","emoji":"ğŸ¢"}</ADMIN_ACTION>

×”×•×¡×¤×ª ××©×ª××©:
<ADMIN_ACTION>{"type":"add_user","name":"×©× ××œ×","username":"username","password":"×¡×™×¡××”","role":"ceo|employee|worker","company":"×©× ×”×—×‘×¨×”"}</ADMIN_ACTION>

××—×™×§×ª ××©×ª××©:
<ADMIN_ACTION>{"type":"delete_user","username":"username"}</ADMIN_ACTION>

××—×™×§×ª ×—×‘×¨×”:
<ADMIN_ACTION>{"type":"delete_company","name":"×©× ×”×—×‘×¨×”"}</ADMIN_ACTION>

×”×•×¡×¤×ª ×”×¢×¨×” ××™×©×™×ª:
<ADMIN_ACTION>{"type":"add_note","content":"×ª×•×›×Ÿ ×”×”×¢×¨×”"}</ADMIN_ACTION>

×©×™× ×•×™ ×¡×™×¡××ª ××©×ª××©:
<ADMIN_ACTION>{"type":"change_password","username":"username","password":"×¡×™×¡××” ×—×“×©×”"}</ADMIN_ACTION>

×©×™× ×•×™ ×—×‘×¨×” ×©×œ ××©×ª××©:
<ADMIN_ACTION>{"type":"move_user","username":"username","company":"×©× ×”×—×‘×¨×”"}</ADMIN_ACTION>

== ×¢×¦×•×ª ×œ×©×™×¤×•×¨ â€” ×”× ×—×™×•×ª ==
×›×©××‘×§×©×™× ×”××œ×¦×•×ª, ×ª× ×ª×— ××ª ×”× ×ª×•× ×™× ×œ×¢×•××§: ×”×× ×™×© ×—×‘×¨×•×ª ×¢× ××¢×˜ ×¢×•×‘×“×™×? ×× ×•××œ×™×•×ª? ××©×ª××©×™× ×œ× ×¤×¢×™×œ×™×? ××©×™××•×ª ×¤×ª×•×—×•×ª ×™×©× ×•×ª? ×ª×Ÿ ×”××œ×¦×•×ª ×§×•× ×§×¨×˜×™×•×ª ×•×× ×•××§×•×ª.

×¢× ×” ×‘×¦×•×¨×” ××§×¦×•×¢×™×ª, ×™×“×™×“×•×ª×™×ª ×•×ª××¦×™×ª×™×ª ×‘×¢×‘×¨×™×ª.`;
}

async function sendAdminAiMessage() {
  const input = document.getElementById('admin-ai-input');
  const text = (input?.value || '').trim();
  if (!text) return;

  const welcome = document.getElementById('admin-ai-welcome');
  if (welcome) welcome.remove();
  document.getElementById('admin-ai-suggestions').style.display = 'none';

  input.value = '';
  input.disabled = true;
  const sendBtn = document.getElementById('admin-ai-send-btn');
  if (sendBtn) sendBtn.disabled = true;

  const msgs = document.getElementById('admin-ai-messages');

  // User bubble
  msgs.innerHTML += `
    <div style="display:flex;justify-content:flex-start;">
      <div style="max-width:75%;background:#dde8ff;border-radius:14px 14px 4px 14px;padding:10px 14px;font-size:13px;line-height:1.6;color:var(--text);">${text.replace(/\n/g,'<br>')}</div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  // Typing dots
  if (!document.getElementById('ai-dot-style')) {
    const s = document.createElement('style');
    s.id = 'ai-dot-style';
    s.textContent = '@keyframes aiDot{0%,80%,100%{opacity:0.2;transform:scale(0.8)}40%{opacity:1;transform:scale(1.2)}}';
    document.head.appendChild(s);
  }
  const typingId = 'admin-typing-' + Date.now();
  msgs.innerHTML += `
    <div id="${typingId}" style="display:flex;justify-content:flex-end;">
      <div style="background:var(--bg3);border-radius:14px 14px 14px 4px;padding:10px 16px;">
        <span style="display:inline-flex;gap:4px;align-items:center;">
          <span style="width:6px;height:6px;background:#4a6cc8;border-radius:50%;animation:aiDot 1.2s infinite 0s;"></span>
          <span style="width:6px;height:6px;background:#4a6cc8;border-radius:50%;animation:aiDot 1.2s infinite 0.4s;"></span>
          <span style="width:6px;height:6px;background:#4a6cc8;border-radius:50%;animation:aiDot 1.2s infinite 0.8s;"></span>
        </span>
      </div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  adminAiHistory.push({ role: 'user', content: text });

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1200,
        system: buildAdminContext(),
        messages: adminAiHistory
      })
    });
    const data = await response.json();
    const rawReply = data.content?.[0]?.text || 'âŒ ×œ× ×”×ª×§×‘×œ×” ×ª×’×•×‘×”';

    // Parse and execute actions
    let displayReply = rawReply;
    const actionMatch = rawReply.match(/<ADMIN_ACTION>([\s\S]*?)<\/ADMIN_ACTION>/);
    let actionResult = '';
    if (actionMatch) {
      displayReply = rawReply.replace(/<ADMIN_ACTION>[\s\S]*?<\/ADMIN_ACTION>/, '').trim();
      try {
        const action = JSON.parse(actionMatch[1]);
        actionResult = executeAdminAiAction(action);
      } catch(e) { console.error('Admin action parse error', e); }
    }

    adminAiHistory.push({ role: 'assistant', content: rawReply });

    document.getElementById(typingId)?.remove();

    // Action result badge
    const actionBadge = actionResult
      ? `<div style="margin-top:8px;padding:6px 10px;background:#f0fff4;border:1px solid #a8e0b8;border-radius:8px;font-size:11px;color:#2d8a5a;font-weight:600;">${actionResult}</div>`
      : '';

    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:82%;background:var(--card);border:1px solid var(--border);border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;line-height:1.7;color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.06);">
          ${displayReply.replace(/\n/g,'<br>')}${actionBadge}
        </div>
      </div>`;

  } catch(err) {
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:80%;background:#fff5f5;border:1px solid #f0c0c8;border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;color:#c0506a;">âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-AI. × ×¡×” ×©×•×‘.</div>
      </div>`;
  }

  msgs.scrollTop = msgs.scrollHeight;
  input.disabled = false;
  if (sendBtn) sendBtn.disabled = false;
  input.focus();
}

function executeAdminAiAction(action) {
  const roleMap = { ceo:'×× ×›"×œ', employee:'×¢×•×‘×“', worker:'×¤×•×¢×œ' };
  const avatarColors = { ceo:'#a78bfa', employee:'#4ade80', worker:'#fb923c' };
  const avatarIcons = { ceo:'ğŸ‘”', employee:'ğŸ’¼', worker:'ğŸ”§' };

  if (action.type === 'add_company') {
    const id = 'co_' + Date.now();
    DATA.companies.push({ id, name: action.name, field: action.field || '×›×œ×œ×™', emoji: action.emoji || 'ğŸ¢', signed: {} });
    renderAdminCompanies?.();
    return `âœ… ×—×‘×¨×” "${action.name}" × ×•×¡×¤×” ×‘×”×¦×œ×—×”`;
  }

  if (action.type === 'add_user') {
    if (DATA.users.find(u => u.username === action.username)) return `âŒ ×©× ××©×ª××© "${action.username}" ×›×‘×¨ ×§×™×™×`;
    const company = DATA.companies.find(c => c.name === action.company || c.id === action.company);
    const maxId = Math.max(...DATA.users.map(u => u.id));
    const role = action.role || 'employee';
    DATA.users.push({
      id: maxId + 1, username: action.username, password: action.password || '1234',
      name: action.name, role, company: company?.id || null,
      avatar: avatarIcons[role] || 'ğŸ‘¤', avatarColor: avatarColors[role] || '#888'
    });
    renderAdminUsers?.();
    return `âœ… ××©×ª××© "${action.name}" (@${action.username}) × ×•×¡×£ ×›${roleMap[role]||role}${company ? ' ×œ×—×‘×¨×ª ' + company.name : ''}`;
  }

  if (action.type === 'delete_user') {
    const idx = DATA.users.findIndex(u => u.username === action.username && u.role !== 'admin');
    if (idx === -1) return `âŒ ××©×ª××© "${action.username}" ×œ× × ××¦×`;
    const name = DATA.users[idx].name;
    DATA.users.splice(idx, 1);
    DATA.tasks.forEach(t => { if (t.assignedTo === DATA.users[idx]?.id) t.assignedTo = null; });
    renderAdminUsers?.();
    return `âœ… ××©×ª××© "${name}" × ××—×§ ××”××¢×¨×›×ª`;
  }

  if (action.type === 'delete_company') {
    const idx = DATA.companies.findIndex(c => c.name === action.name);
    if (idx === -1) return `âŒ ×—×‘×¨×” "${action.name}" ×œ× × ××¦××”`;
    const compId = DATA.companies[idx].id;
    DATA.companies.splice(idx, 1);
    DATA.users.forEach(u => { if (u.company === compId) u.company = null; });
    renderAdminCompanies?.();
    return `âœ… ×—×‘×¨×” "${action.name}" × ××—×§×”`;
  }

  if (action.type === 'add_note') {
    const notesEl = document.getElementById('admin-notes');
    if (notesEl) {
      const existing = notesEl.value;
      notesEl.value = existing ? existing + '\n' + action.content : action.content;
    }
    return `âœ… ×”×¢×¨×” × ×•×¡×¤×” ×œ××–×•×¨ ×”×”×¢×¨×•×ª ×”××™×©×™×•×ª`;
  }

  if (action.type === 'change_password') {
    const user = DATA.users.find(u => u.username === action.username);
    if (!user) return `âŒ ××©×ª××© "${action.username}" ×œ× × ××¦×`;
    user.password = action.password;
    renderAdminUsers?.();
    return `âœ… ×¡×™×¡××ª "${user.name}" ×©×•× ×ª×” ×‘×”×¦×œ×—×”`;
  }

  if (action.type === 'move_user') {
    const user = DATA.users.find(u => u.username === action.username);
    const company = DATA.companies.find(c => c.name === action.company);
    if (!user) return `âŒ ××©×ª××© "${action.username}" ×œ× × ××¦×`;
    if (!company) return `âŒ ×—×‘×¨×” "${action.company}" ×œ× × ××¦××”`;
    user.company = company.id;
    renderAdminUsers?.();
    return `âœ… ${user.name} ×”×•×¢×‘×¨ ×œ×—×‘×¨×ª "${company.name}"`;
  }

  return '';
}

// â”€â”€ EMPLOYEE â”€â”€
function renderEmpDashboard() {
  document.getElementById('emp-welcome-name').textContent = currentUser.name;
  const company = DATA.companies.find(c => c.id === currentUser.company);
  document.getElementById('emp-company-label').textContent = company ? `${company.emoji} ${company.name}` : '';
  const myTasks = DATA.tasks.filter(t => t.assignedTo === currentUser.id || (t.createdByEmp && t.assignedTo === currentUser.id));
  const open = myTasks.filter(t => t.status === 'open');
  const done = myTasks.filter(t => t.status === 'done');
  const urgent = myTasks.filter(t => t.status === 'open' && t.priority === 'high');
  document.getElementById('emp-stat-open').textContent = open.length;
  document.getElementById('emp-stat-done').textContent = done.length;
  document.getElementById('emp-stat-urgent').textContent = urgent.length;
  document.getElementById('emp-stat-today').textContent = open.filter(t => t.dueDate === new Date().toISOString().split('T')[0]).length;

  const urgentDiv = document.getElementById('emp-urgent-tasks');
  if (!urgent.length) { urgentDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‰</div><p>××™×Ÿ ××©×™××•×ª ×“×—×•×¤×•×ª!</p></div>'; return; }
  urgentDiv.innerHTML = `<div class="tasks-grid">${urgent.slice(0,3).map(t => taskCardHTML(t,'emp')).join('')}</div>`;
}

function renderEmpTasks() {
  const grid = document.getElementById('emp-tasks-grid');
  let tasks = DATA.tasks.filter(t => t.assignedTo === currentUser.id);
  if (taskFilter === 'open') tasks = tasks.filter(t => t.status === 'open');
  else if (taskFilter === 'done') tasks = tasks.filter(t => t.status === 'done');
  else if (taskFilter === 'high') tasks = tasks.filter(t => t.priority === 'high');
  else if (taskFilter === 'mine') tasks = tasks.filter(t => t.createdByEmp);
  renderTaskCards(grid, tasks, 'emp');
}

function renderEmpCalendar() {
  const tasks = DATA.tasks.filter(t => t.assignedTo === currentUser.id && t.status === 'open')
    .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
  const div = document.getElementById('emp-upcoming-tasks');
  if (!tasks.length) { div.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“…</div><p>××™×Ÿ ××©×™××•×ª ×××ª×™× ×•×ª</p></div>'; return; }
  div.innerHTML = '<div style="text-align:right;">' + tasks.map(t => {
    const due = new Date(t.dueDate);
    const today = new Date();
    const diff = Math.ceil((due - today) / (1000*60*60*24));
    const urgency = diff < 0 ? 'tag-red' : diff <= 2 ? 'tag-yellow' : 'tag-green';
    const urgencyText = diff < 0 ? `××™×—×•×¨ ${Math.abs(diff)} ×™××™×` : diff === 0 ? '×”×™×•×!' : `×¢×•×“ ${diff} ×™××™×`;
    return `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg3);border-radius:10px;margin-bottom:8px;">
      <div class="priority-dot p-${t.priority}"></div>
      <div style="flex:1;"><div style="font-weight:600;font-size:13px;">${t.title}</div>
      <div style="font-size:11px;color:var(--text2);">${t.dueDate}</div></div>
      <span class="tag ${urgency}">${urgencyText}</span>
    </div>`;
  }).join('') + '</div>';
}

// â”€â”€ WORKER HOURS â”€â”€
function calcHoursFromTime(start, end) {
  if (!start || !end) return 0;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  const startMins = sh * 60 + sm;
  let endMins = eh * 60 + em;
  if (endMins <= startMins) endMins += 24 * 60; // overnight shift
  const diff = (endMins - startMins) / 60;
  return diff > 0 ? Math.round(diff * 10) / 10 : 0;
}

function isWorkerMonthSigned() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;
  const sig = company && company.signed[key];
  return sig && sig.type === 'full';
}

function isDayLocked(day) {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;
  const sig = company && company.signed[key];
  if (!sig) return false;
  if (sig.type === 'full') return true;
  if (sig.type === 'partial') return sig.days.includes(day);
  return false;
}

function renderWorkerHours(viewWorkerId, viewMonth, viewYear) {
  // If called as viewer by CEO, use different context
  const isViewer = !!viewWorkerId;
  const workerId = viewWorkerId || currentUser.id;
  const month = viewMonth !== undefined ? viewMonth : workerCurrentMonth;
  const year = viewYear !== undefined ? viewYear : workerCurrentYear;
  const worker = DATA.users.find(u => u.id === workerId);

  if (!isViewer) {
    document.getElementById('worker-name-display').textContent = currentUser.name;
    const company = DATA.companies.find(c => c.id === currentUser.company);
    document.getElementById('worker-company-display').textContent = company ? `${company.emoji} ${company.name}` : '';
    const months = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
    document.getElementById('worker-month-label').textContent = `${months[month]} ${year}`;
  }

  const companyId = worker ? worker.company : currentUser.company;
  const company = DATA.companies.find(c => c.id === companyId);
  const key = `${workerId}-${year}-${month}`;
  const hours = DATA.workerHours[key] || {};
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const dayNames = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];

  const signedInfo = company && company.signed[key];
  const isFullSigned = signedInfo && signedInfo.type === 'full';
  const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

  // For worker: lock signed days
  let totalH = 0, workDays = 0;
  const tbody = document.getElementById('worker-hours-table');
  const todayDate = new Date();
  const todayDay = (todayDate.getFullYear() === year && todayDate.getMonth() === month) ? todayDate.getDate() : -1;
  let rows = '';
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const dayIdx = date.getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const isToday = d === todayDay;
    const entry = hours[d] || { hours:'', start:'', end:'', note:'' };
    const computed = entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours)||0);
    if (computed > 0) { totalH += computed; workDays++; }

    const isDaySigned = isFullSigned || partialDays.includes(d);
    const locked = isDaySigned && !isViewer && currentUser.role === 'worker';
    let rowBg = isWeekend ? 'background:#fdf0f0;' : '';
    if (isDaySigned) rowBg = 'background:#f0fff4;';
    if (isToday) rowBg = 'background:linear-gradient(90deg,#e8f4ff,#f0e8ff);';
    const signedBadge = isDaySigned ? `<span style="font-size:10px;color:#3a9a7a;font-weight:700;margin-right:4px;">âœ“</span>` : '';
    const todayBadge = isToday ? `<span style="font-size:9px;background:#7bb3d8;color:white;padding:1px 5px;border-radius:4px;margin-right:4px;font-weight:700;">×”×™×•×</span>` : '';
    const leftBorder = isToday ? 'border-right:3px solid #7bb3d8;' : '';

    rows += `
    <tr data-day="${d}" style="${rowBg}${locked ? 'opacity:0.75;' : ''}${leftBorder}${isToday ? 'font-weight:600;' : ''}">
      <td style="font-weight:${isToday?'700':'600'};">${todayBadge}${d}/${month+1} ${signedBadge}</td>
      <td style="color:${isWeekend ? '#c0506a' : 'var(--text2)'};">${dayNames[dayIdx]}</td>
      <td><input class="hours-input" type="time" value="${entry.start||''}" onchange="updateHourEntry(${d},'start',this.value,'${workerId}')" style="width:100px;" ${locked || isViewer ? 'disabled' : ''}></td>
      <td><input class="hours-input" type="time" value="${entry.end||''}" onchange="updateHourEntry(${d},'end',this.value,'${workerId}')" style="width:100px;" ${locked || isViewer ? 'disabled' : ''}></td>
      <td style="font-weight:700;color:#4a88b8;text-align:center;" class="computed-hours">${computed > 0 ? computed.toFixed(1) : 'â€”'}</td>
      <td><input class="hours-input" type="text" value="${entry.note||''}" onchange="updateHourEntry(${d},'note',this.value,'${workerId}')" placeholder="×”×¢×¨×”..." style="width:120px;" ${locked || isViewer ? 'disabled' : ''}></td>
    </tr>`;
  }
  tbody.innerHTML = rows;

  // Auto-scroll to today's row
  if (!isViewer && todayDay > 0) {
    setTimeout(() => {
      const allRows = tbody.querySelectorAll('tr');
      if (allRows[todayDay - 1]) {
        allRows[todayDay - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 50);
  }

  if (!isViewer) {
    document.getElementById('worker-total-hours').textContent = totalH.toFixed(1);
    document.getElementById('worker-work-days').textContent = workDays;
    document.getElementById('worker-avg-hours').textContent = workDays ? (totalH/workDays).toFixed(1) : '0';

    // Lock banner
    const fullyLocked = isFullSigned && currentUser.role === 'worker';
    const saveBtn = document.getElementById('worker-save-btn');
    const lockedBanner = document.getElementById('worker-locked-banner');
    if (saveBtn) saveBtn.style.display = fullyLocked ? 'none' : 'inline-flex';
    if (lockedBanner) lockedBanner.style.display = fullyLocked ? 'block' : 'none';

    // Signature status UI
    const hasSig = !!signedInfo;
    // Show unsigned form if: fully unsigned, OR partially signed (can still add more days)
    const showUnsignedForm = !hasSig || (signedInfo && signedInfo.type === 'partial');
    const showSignedBox = hasSig;
    document.getElementById('sig-unsigned').style.display = showUnsignedForm ? 'block' : 'none';
    document.getElementById('sig-signed').style.display = showSignedBox ? 'block' : 'none';

    // When partially signed, hide the "sign full month" block only, keep partial block visible
    const fullMonthBlock = document.getElementById('sig-full-month-block');
    if (fullMonthBlock) {
      fullMonthBlock.style.display = (signedInfo && signedInfo.type === 'partial') ? 'none' : 'block';
    }

    if (hasSig) {
      document.getElementById('sig-info').textContent = isFullSigned
        ? `âœ… ×›×œ ×”×—×•×“×© ××•×©×¨ ×‘-${signedInfo.date}`
        : `ğŸ“… ×—×œ×§ ××”×™××™× ××•×©×¨×• ×‘-${signedInfo.date}`;
      const partialEl = document.getElementById('sig-partial-info');
      if (partialEl) {
        if (!isFullSigned && partialDays.length) {
          partialEl.style.display = 'block';
          partialEl.textContent = `×ª××¨×™×›×™× ×—×ª×•××™×: ${partialDays.join(', ')}`;
        } else {
          partialEl.style.display = 'none';
        }
      }
    }

      const partialNote = document.getElementById('sig-partial-note');
      if (partialNote) partialNote.style.display = (!isFullSigned && partialDays.length) ? 'block' : 'none';
    const daysList = document.getElementById('sig-days-list');
    const daysTags = document.getElementById('sig-days-tags');
    if (daysList && daysTags) {
      if (!isFullSigned && partialDays.length > 0) {
        daysList.style.display = 'block';
        daysTags.innerHTML = partialDays.map(d => `<span class="tag tag-green" style="font-size:11px;">${d}/${month+1}</span>`).join('');
      } else {
        daysList.style.display = 'none';
      }
    }
  }
}

function updateHourEntry(day, field, val, wid) {
  const workerId = wid ? parseInt(wid) : currentUser.id;
  if (workerId === currentUser.id && isDayLocked(day)) {
    showToast('âŒ ×™×•× ×–×” × ×—×ª× ×•×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š', 'error');
    renderWorkerHours();
    return;
  }
  const key = `${workerId}-${workerCurrentYear}-${workerCurrentMonth}`;
  if (!DATA.workerHours[key]) DATA.workerHours[key] = {};
  if (!DATA.workerHours[key][day]) DATA.workerHours[key][day] = { hours:'', start:'', end:'', note:'' };
  DATA.workerHours[key][day][field] = val;

  // Auto-calc hours from start/end
  const entry = DATA.workerHours[key][day];
  if (field === 'start' || field === 'end') {
    entry.hours = calcHoursFromTime(entry.start, entry.end).toString();
  }

  // Update totals + computed cell only for the active worker
  if (workerId === currentUser.id) {
    let totalH = 0, workDays = 0;
    const daysInMonth = new Date(workerCurrentYear, workerCurrentMonth+1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
      const e = DATA.workerHours[key][d];
      if (e) {
        const h = e.start && e.end ? calcHoursFromTime(e.start, e.end) : (parseFloat(e.hours)||0);
        if (h > 0) { totalH += h; workDays++; }
      }
    }
    document.getElementById('worker-total-hours').textContent = totalH.toFixed(1);
    document.getElementById('worker-work-days').textContent = workDays;
    document.getElementById('worker-avg-hours').textContent = workDays ? (totalH/workDays).toFixed(1) : '0';

    const rows = document.getElementById('worker-hours-table').rows;
    for (let i = 0; i < rows.length; i++) {
      if (parseInt(rows[i].dataset.day) === day) {
        const computed = calcHoursFromTime(entry.start, entry.end);
        const cell = rows[i].querySelector('.computed-hours');
        if (cell) cell.textContent = computed > 0 ? computed.toFixed(1) : 'â€”';
        break;
      }
    }
  }
}

function saveWorkerHours() {
  showToast('âœ… ×©×¢×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!');
}

function changeWorkerMonth(delta) {
  workerCurrentMonth += delta;
  if (workerCurrentMonth > 11) { workerCurrentMonth = 0; workerCurrentYear++; }
  if (workerCurrentMonth < 0) { workerCurrentMonth = 11; workerCurrentYear--; }
  renderWorkerHours();
}

function signReport(mode) {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;

  if (mode === 'full') {
    const pass = document.getElementById('sigPasswordVerify').value;
    if (!pass) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××”', 'error'); return; }
    if (pass !== company.sigPassword) { showToast('âŒ ×¡×™×¡××” ×©×’×•×™×”!', 'error'); return; }
    const now = new Date().toLocaleDateString('he-IL');
    company.signed[key] = { type:'full', date: now, days: null };
    awSaveSignature(company.id, key); // Appwrite sync
    document.getElementById('sigPasswordVerify').value = '';
    showToast('âœ… ×›×œ ×”×“×•×— ××•×©×¨ ×•×—×ª×•×!');

  } else if (mode === 'partial') {
    const pass = document.getElementById('sigPasswordVerifyPartial').value;
    if (!pass) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××”', 'error'); return; }
    if (pass !== company.sigPassword) { showToast('âŒ ×¡×™×¡××” ×©×’×•×™×”!', 'error'); return; }
    const from = document.getElementById('sigDayFrom').value;
    const to = document.getElementById('sigDayTo').value;
    if (!from || !to) { showToast('âŒ ×™×© ×œ×‘×—×•×¨ ×˜×•×•×— ×ª××¨×™×›×™×', 'error'); return; }
    if (from > to) { showToast('âŒ ×ª××¨×™×š ×”×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ ×”×¡×™×•×', 'error'); return; }

    // Collect all days in the range that belong to this month
    const days = [];
    const cur = new Date(from);
    const end = new Date(to);
    while (cur <= end) {
      if (cur.getFullYear() === workerCurrentYear && cur.getMonth() === workerCurrentMonth) {
        days.push(cur.getDate());
      }
      cur.setDate(cur.getDate() + 1);
    }
    if (!days.length) { showToast('âŒ ×”×˜×•×•×— ×œ× ×›×•×œ×œ ×™××™× ×‘×—×•×“×© ×”× ×•×›×—×™', 'error'); return; }

    const now = new Date().toLocaleDateString('he-IL');
    // Merge with existing partial days if any
    const existing = company.signed[key];
    let existingDays = (existing && existing.type === 'partial') ? existing.days : [];
    const merged = [...new Set([...existingDays, ...days])].sort((a,b)=>a-b);
    company.signed[key] = { type:'partial', date: now, days: merged };
    awSaveSignature(company.id, key); // Appwrite sync
    document.getElementById('sigPasswordVerifyPartial').value = '';
    showToast(`âœ… ×™××™× ${days[0]}-${days[days.length-1]} ××•×©×¨×• ×•×—×ª×•××•!`);
  }

  renderWorkerHours();
}

function unsignReport() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  const pass = document.getElementById('unsignPassword').value;
  if (!pass) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××”', 'error'); return; }
  if (pass !== company.sigPassword) { showToast('âŒ ×¡×™×¡××” ×©×’×•×™×”!', 'error'); return; }
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;
  delete company.signed[key];
  awSaveSignature(company.id, key); // Appwrite sync (saves empty = unsigned)
  document.getElementById('unsignPassword').value = '';
  renderWorkerHours();
  showToast('âœ… ×”××™×©×•×¨ ×‘×•×˜×œ â€” × ×™×ª×Ÿ ×œ×¢×¨×•×š ×©×•×‘');
}

function ceoUnsignWorker(workerId) {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  const now = new Date();
  const key = `${workerId}-${now.getFullYear()}-${now.getMonth()}`;
  if (!company.signed[key]) { showToast('×”×“×•×— ××™× ×• ×—×ª×•×', 'error'); return; }
  if (!confirm('×œ×‘×˜×œ ××ª ×—×ª×™××ª ×”×¤×•×¢×œ ×”×–×” ×œ×—×•×“×© ×”× ×•×›×—×™?')) return;
  delete company.signed[key];
  renderCeoWorkers();
  showToast('âœ… ×—×ª×™××” ×‘×•×˜×œ×” â€” ×”×¤×•×¢×œ ×™×›×•×œ ×œ×¢×¨×•×š ×©×•×‘');
}

function setSignToday() {
  const today = new Date().toISOString().split('T')[0];
  const fromEl = document.getElementById('sigDayFrom');
  const toEl = document.getElementById('sigDayTo');
  if (fromEl) fromEl.value = today;
  if (toEl) toEl.value = today;
  showToast('ğŸ“Œ ×ª××¨×™×š ×”×™×•× ×¡×•××Ÿ ××•×˜×•××˜×™×ª');
}

function ceoOpenAddMember(role) {
  const roleLabel = role === 'employee' ? '×¢×•×‘×“' : '×¤×•×¢×œ';
  const roleEmoji = role === 'employee' ? 'ğŸ’¼' : 'ğŸ”§';
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">${roleEmoji} ×”×•×¡×£ ${roleLabel} ×—×“×© ×œ×—×‘×¨×”</div>
    <div class="form-group"><label>×©× ××œ×</label><input type="text" id="cm-name" placeholder="×©× ××œ×..."></div>
    <div class="form-group"><label>×©× ××©×ª××©</label><input type="text" id="cm-username" placeholder="username (×× ×’×œ×™×ª ×‘×œ×‘×“)..."></div>
    <div class="form-group"><label>×¡×™×¡××”</label><input type="password" id="cm-pass" placeholder="×¡×™×¡××” ×¨××©×•× ×™×ª..."></div>
    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <div style="flex:1;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">×¡×•×’ ××¡××š</label>
        <select id="cm-idtype" class="form-input" style="padding:8px 12px;">
          <option value="id">ğŸªª ×ª×¢×•×“×ª ×–×”×•×ª</option>
          <option value="passport">ğŸ›‚ ×“×¨×›×•×Ÿ</option>
        </select>
      </div>
      <div style="flex:2;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">××¡×¤×¨ ××¡××š</label>
        <input type="text" id="cm-idnumber" class="form-input" placeholder="××¡×¤×¨ ×ª&quot;×– / ×“×¨×›×•×Ÿ...">
      </div>
    </div>
    <div style="padding:12px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--text2);margin-bottom:8px;">
      â„¹ï¸ ×”${roleLabel} ×™×¦×•×¨×£ ××•×˜×•××˜×™×ª ×œ×—×‘×¨×” ×©×œ×š: <strong>${DATA.companies.find(c=>c.id===currentUser.company)?.name || ''}</strong>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="ceoAddMember('${role}')">+ ×”×•×¡×£ ${roleLabel}</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function ceoAddMember(role) {
  const name = document.getElementById('cm-name').value.trim();
  const username = document.getElementById('cm-username').value.trim();
  const pass = document.getElementById('cm-pass').value.trim();
  const idType = document.getElementById('cm-idtype').value;
  const idNumber = document.getElementById('cm-idnumber').value.trim();
  if (!name || !username || !pass) { showToast('âŒ ×™×© ×œ××œ× ×©×, ×©× ××©×ª××© ×•×¡×™×¡××”', 'error'); return; }
  if (DATA.users.find(u => u.username === username)) { showToast('âŒ ×©× ××©×ª××© ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª', 'error'); return; }
  const colors = { employee:'#4ade80', worker:'#fb923c' };
  const avatars = { employee:'ğŸ’¼', worker:'ğŸ”§' };
  const newUser = {
    id: Math.max(...DATA.users.map(u => u.id)) + 1,
    username, password: pass, name,
    role, company: currentUser.company,
    avatar: avatars[role], avatarColor: colors[role],
    idType, idNumber
  };
  DATA.users.push(newUser);
  awSaveUser(newUser); // Appwrite sync
  closeModal();
  if (role === 'employee') renderCeoEmployees();
  else renderCeoWorkers();
  showToast(`âœ… ${name} × ×•×¡×£${role==='worker'?'':'×”'} ×‘×”×¦×œ×—×”!`);
}

// â”€â”€ BULK IMPORT WORKERS â”€â”€
const BULK_ROWS = 10; // initial empty rows

function openBulkImportWorkers() {
  // Use wide modal
  const modal = document.getElementById('modalContent');
  modal.dataset.prevMaxWidth = modal.style.maxWidth || '';
  modal.style.maxWidth = '780px';

  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ“¥ ×™×™×‘×•× ×¤×•×¢×œ×™× ×××§×¡×œ</div>

    <!-- Instructions -->
    <div style="background:linear-gradient(135deg,#f0f7ff,#e8f5ff);border:1px solid #c0d8f0;border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:12px;color:var(--text2);">
      âœï¸ <strong>××œ× ××ª ×”×˜×‘×œ×”</strong> ×™×©×™×¨×•×ª ×›××Ÿ, ××• <strong>×”×¢×ª×§</strong> ××•×ª×” ×œ××§×¡×œ, ××œ× ×©×, ×•<strong>×”×“×‘×§ ×—×–×¨×”</strong> (Ctrl+V).
      <br>×”×¢××•×“×” ×”××—×¨×•× ×” â€” ×× ×”×›×•×ª×¨×ª <strong>×“×¨×›×•×Ÿ</strong> ×™×™×¨×©× ×“×¨×›×•×Ÿ, ×× <strong>×ª"×–</strong> ×™×™×¨×©× ×ª"×–.
    </div>

    <!-- Doc type toggle -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span style="font-size:12px;font-weight:600;color:var(--text);">×¡×•×’ ××¡××š:</span>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;">
        <input type="radio" name="bulk-doctype" value="id" onchange="updateBulkDocHeader(this.value)"> ğŸªª ×ª"×–
      </label>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;">
        <input type="radio" name="bulk-doctype" value="passport" checked onchange="updateBulkDocHeader(this.value)"> ğŸ›‚ ×“×¨×›×•×Ÿ
      </label>
      <div style="margin-right:auto;display:flex;gap:6px;">
        <button onclick="copyBulkTable()" class="btn btn-outline btn-sm" style="font-size:11px;">ğŸ“‹ ×”×¢×ª×§ ×˜×‘×œ×” ×œ××§×¡×œ</button>
        <button onclick="addBulkRow()" class="btn btn-outline btn-sm" style="font-size:11px;">+ ×”×•×¡×£ ×©×•×¨×”</button>
        <button onclick="clearBulkTable()" class="btn btn-outline btn-sm" style="font-size:11px;color:var(--text3);">ğŸ—‘ï¸ × ×§×”</button>
      </div>
    </div>

    <!-- Editable table -->
    <div style="overflow-x:auto;border:1px solid var(--border);border-radius:10px;background:white;">
      <table id="bulk-table" style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="background:#f0f4f8;">
            <th style="padding:8px 10px;border-bottom:2px solid var(--border);border-left:1px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:140px;">×©× ××œ×</th>
            <th style="padding:8px 10px;border-bottom:2px solid var(--border);border-left:1px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:130px;">×©× ××©×ª××©</th>
            <th style="padding:8px 10px;border-bottom:2px solid var(--border);border-left:1px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:110px;">×¡×™×¡××”</th>
            <th id="bulk-doc-header" style="padding:8px 10px;border-bottom:2px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:130px;">ğŸ›‚ ×“×¨×›×•×Ÿ</th>
          </tr>
        </thead>
        <tbody id="bulk-tbody"></tbody>
      </table>
    </div>

    <!-- Validation feedback -->
    <div id="bulk-validation" style="margin-top:10px;font-size:12px;display:none;"></div>

    <div class="modal-actions" style="margin-top:14px;">
      <button class="btn btn-primary" id="bulk-import-btn" onclick="executeBulkImport()">ğŸ“¥ ×™×™×‘× ×¤×•×¢×œ×™×</button>
      <button class="btn btn-outline" onclick="closeBulkModal()">×‘×™×˜×•×œ</button>
    </div>`;

  // Build initial empty rows
  buildBulkRows(BULK_ROWS);
  openModal();

  // Handle paste on whole modal
  document.getElementById('bulk-table').addEventListener('paste', handleBulkPaste);
}

function closeBulkModal() {
  const modal = document.getElementById('modalContent');
  modal.style.maxWidth = modal.dataset.prevMaxWidth || '';
  closeModal();
}

function buildBulkRows(count) {
  const tbody = document.getElementById('bulk-tbody');
  tbody.innerHTML = '';
  for (let i = 0; i < count; i++) addBulkRow();
}

function addBulkRow(values = ['','','','']) {
  const tbody = document.getElementById('bulk-tbody');
  const rowIdx = tbody.rows.length;
  const tr = document.createElement('tr');
  tr.style.cssText = 'border-bottom:1px solid var(--border);';
  tr.innerHTML = values.map((v, ci) => `
    <td style="padding:0;border-left:${ci < 3 ? '1px solid var(--border)' : 'none'};">
      <input type="${ci === 2 ? 'text' : 'text'}" value="${v.replace(/"/g,'&quot;')}"
        style="width:100%;border:none;outline:none;padding:7px 10px;font-size:13px;background:transparent;font-family:inherit;box-sizing:border-box;"
        onkeydown="bulkCellKeydown(event,this,${rowIdx},${ci})"
        oninput="validateBulkTable()"
        onfocus="this.style.background='#f0f4ff'" onblur="this.style.background='transparent'">
    </td>`).join('');
  tbody.appendChild(tr);
}

function bulkCellKeydown(e, input, row, col) {
  const tbody = document.getElementById('bulk-tbody');
  const numCols = 4;
  if (e.key === 'Tab') {
    e.preventDefault();
    const next = e.shiftKey ? (col - 1 + numCols * (row + 1)) : (col + 1 + numCols * row);
    const allInputs = tbody.querySelectorAll('input');
    const nextIdx = row * numCols + col + (e.shiftKey ? -1 : 1);
    if (nextIdx >= 0 && nextIdx < allInputs.length) allInputs[nextIdx].focus();
    else if (!e.shiftKey && nextIdx >= allInputs.length) { addBulkRow(); setTimeout(() => tbody.querySelectorAll('input')[nextIdx]?.focus(), 10); }
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const allInputs = tbody.querySelectorAll('input');
    const nextIdx = (row + 1) * numCols + col;
    if (nextIdx < allInputs.length) allInputs[nextIdx].focus();
    else { addBulkRow(); setTimeout(() => tbody.querySelectorAll('input')[nextIdx]?.focus(), 10); }
  }
}

function updateBulkDocHeader(type) {
  const h = document.getElementById('bulk-doc-header');
  if (h) h.textContent = type === 'passport' ? 'ğŸ›‚ ×“×¨×›×•×Ÿ' : 'ğŸªª ×ª"×–';
  validateBulkTable();
}

function getBulkDocType() {
  return document.querySelector('input[name="bulk-doctype"]:checked')?.value || 'passport';
}

function getBulkTableData() {
  const tbody = document.getElementById('bulk-tbody');
  const rows = [];
  for (const tr of tbody.rows) {
    const inputs = tr.querySelectorAll('input');
    const vals = [...inputs].map(i => i.value.trim());
    if (vals.some(v => v)) rows.push(vals); // skip fully empty rows
  }
  return rows;
}

function validateBulkTable() {
  const rows = getBulkTableData();
  const docType = getBulkDocType();
  const validEl = document.getElementById('bulk-validation');
  const btn = document.getElementById('bulk-import-btn');

  if (!rows.length) { validEl.style.display='none'; btn.disabled=true; btn.style.opacity='0.5'; btn.textContent='ğŸ“¥ ×™×™×‘× ×¤×•×¢×œ×™×'; return; }

  const errors = [];
  const validRows = [];

  rows.forEach((cols, idx) => {
    const [name, username, password, idNumber] = cols;
    const rowErrors = [];
    if (!name) rowErrors.push('×©× ××œ× ×—×¡×¨');
    if (!username) rowErrors.push('×©× ××©×ª××© ×—×¡×¨');
    else if (/\s/.test(username)) rowErrors.push('×©× ××©×ª××© ××›×™×œ ×¨×•×•×—×™×');
    if (!password) rowErrors.push('×¡×™×¡××” ×—×¡×¨×”');
    else if (password.length < 4) rowErrors.push('×¡×™×¡××” ×§×¦×¨×”');
    if (username && DATA.users.find(u => u.username === username)) rowErrors.push('×©× ××©×ª××© ×ª×¤×•×¡');

    // Highlight row
    const tbody = document.getElementById('bulk-tbody');
    const allRows = [...tbody.rows].filter(tr => {
      const vals = [...tr.querySelectorAll('input')].map(i => i.value.trim());
      return vals.some(v => v);
    });
    if (allRows[idx]) {
      allRows[idx].style.background = rowErrors.length ? '#fff5f5' : '#f0fff4';
    }

    if (rowErrors.length) errors.push(`×©×•×¨×” ${idx+1} (${name||'?'}): ${rowErrors.join(', ')}`);
    else validRows.push({ name, username, password, idType: docType, idNumber });
  });

  if (errors.length) {
    validEl.style.display = 'block';
    validEl.innerHTML = `<div style="background:#fff5f5;border:1px solid #f0c0c8;border-radius:8px;padding:8px 12px;color:#c0506a;">âš ï¸ ${errors.join('<br>')}</div>`;
  } else {
    validEl.style.display = 'none';
  }

  if (validRows.length) {
    btn.disabled = false; btn.style.opacity = '1';
    btn.textContent = `ğŸ“¥ ×™×™×‘× ${validRows.length} ×¤×•×¢×œ×™×`;
  } else {
    btn.disabled = true; btn.style.opacity = '0.5';
    btn.textContent = 'ğŸ“¥ ×™×™×‘× ×¤×•×¢×œ×™×';
  }
}

function handleBulkPaste(e) {
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData('text');
  const lines = text.trim().split(/\r?\n/).filter(l => l.trim());
  if (!lines.length) return;

  // Check if first line is a header (contains Hebrew letters that look like headers)
  let dataLines = lines;
  const firstCols = lines[0].split('\t');
  const looksLikeHeader = firstCols.some(c => /^(×©×|×“×¨×›×•×Ÿ|×ª"×–|×¡×™×¡××”|××¡××š|××©×ª××©)/.test(c.trim()));

  // If header includes ×“×¨×›×•×Ÿ â†’ set doctype to passport
  if (looksLikeHeader) {
    const lastHeader = firstCols[firstCols.length - 1].trim();
    if (lastHeader === '×“×¨×›×•×Ÿ' || lastHeader === 'ğŸ›‚ ×“×¨×›×•×Ÿ') {
      document.querySelector('input[name="bulk-doctype"][value="passport"]').checked = true;
      updateBulkDocHeader('passport');
    } else {
      document.querySelector('input[name="bulk-doctype"][value="id"]').checked = true;
      updateBulkDocHeader('id');
    }
    dataLines = lines.slice(1);
  }

  // Re-build table with pasted rows + a few empty rows at end
  const tbody = document.getElementById('bulk-tbody');
  tbody.innerHTML = '';
  dataLines.forEach(line => {
    const cols = line.split('\t');
    addBulkRow([cols[0]||'', cols[1]||'', cols[2]||'', cols[3]||'']);
  });
  // Add 3 empty rows at bottom for extra entry
  for (let i = 0; i < 3; i++) addBulkRow();
  validateBulkTable();
}

function copyBulkTable() {
  const docType = getBulkDocType();
  const docLabel = docType === 'passport' ? '×“×¨×›×•×Ÿ' : '×ª"×–';
  // Copy header + all current rows (including empty ones) as TSV
  const header = `×©× ××œ×\t×©× ××©×ª××©\t×¡×™×¡××”\t${docLabel}`;
  const tbody = document.getElementById('bulk-tbody');
  const allRows = [...tbody.rows].map(tr => {
    const inputs = tr.querySelectorAll('input');
    return [...inputs].map(i => i.value).join('\t');
  });
  const tsv = header + '\n' + allRows.join('\n');

  const fallback = () => {
    const ta = document.createElement('textarea');
    ta.value = tsv; ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    showToast('ğŸ“‹ ×”×˜×‘×œ×” ×”×•×¢×ª×§×”! ×¤×ª×— ××§×¡×œ ×•×œ×—×¥ Ctrl+V');
  };

  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(tsv)
      .then(() => showToast('ğŸ“‹ ×”×˜×‘×œ×” ×”×•×¢×ª×§×”! ×¤×ª×— ××§×¡×œ ×•×œ×—×¥ Ctrl+V'))
      .catch(fallback);
  } else {
    fallback();
  }
}

function clearBulkTable() {
  buildBulkRows(BULK_ROWS);
  document.getElementById('bulk-validation').style.display = 'none';
  const btn = document.getElementById('bulk-import-btn');
  btn.disabled = true; btn.style.opacity = '0.5'; btn.textContent = 'ğŸ“¥ ×™×™×‘× ×¤×•×¢×œ×™×';
}

function executeBulkImport() {
  const rows = getBulkTableData();
  const docType = getBulkDocType();
  const valid = [];

  rows.forEach(cols => {
    const [name, username, password, idNumber] = cols;
    if (!name || !username || !password || password.length < 4 || /\s/.test(username)) return;
    if (DATA.users.find(u => u.username === username)) return;
    valid.push({ name, username, password, idType: docType, idNumber });
  });

  if (!valid.length) { showToast('âŒ ××™×Ÿ ×¤×•×¢×œ×™× ×ª×§×™× ×™× ×œ×™×™×‘×•×', 'error'); return; }

  let maxId = Math.max(...DATA.users.map(u => u.id));
  valid.forEach(w => {
    const newWorker = {
      id: ++maxId,
      username: w.username, password: w.password, name: w.name,
      role: 'worker', company: currentUser.company,
      avatar: 'ğŸ”§', avatarColor: '#fb923c',
      idType: w.idType, idNumber: w.idNumber
    };
    DATA.users.push(newWorker);
    awSaveUser(newWorker); // Appwrite sync
  });

  closeBulkModal();
  renderCeoWorkers();
  renderCeoWorkersGrid(false);
  showToast(`âœ… ${valid.length} ×¤×•×¢×œ×™× ×™×•×‘××• ×‘×”×¦×œ×—×”!`, 'success');
}

let sigPassVisible = false;
function toggleCurrentSigPass() {
  sigPassVisible = !sigPassVisible;
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const dispEl = document.getElementById('current-sig-pass-display');
  const eyeEl = document.getElementById('current-sig-pass-eye');
  if (!dispEl || !company) return;
  dispEl.textContent = sigPassVisible ? (company.sigPassword || '(×œ× ×”×•×’×“×¨×”)') : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  if (eyeEl) eyeEl.textContent = sigPassVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
}

function setSigPassword() {
  const pass = document.getElementById('sigPasswordInput').value;
  if (!pass) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××”', 'error'); return; }
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (company) {
    company.sigPassword = pass;
    awSaveCompany(company); // Appwrite sync
    const dispEl = document.getElementById('current-sig-pass-display');
    if (dispEl) { dispEl.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; dispEl.dataset.pass = pass; sigPassVisible = false; }
    showToast('âœ… ×¡×™×¡××ª ×”×—×ª×™××” ×¢×•×“×›× ×”!');
  }
  document.getElementById('sigPasswordInput').value = '';
}



function exportHours() {
  showToast('ğŸ“¥ ×”×“×•×— ×™×•×¦×•× ×‘×”×¦×œ×—×” (PDF)');
}

// â”€â”€ TASKS â”€â”€
function taskCardHTML(t, mode) {
  const assignee = DATA.users.find(u => u.id === t.assignedTo);
  const priorLabels = { high:'ğŸ”¥ ×“×—×•×£', medium:'âš¡ ×‘×™× ×•× ×™', low:'ğŸŒ¿ × ××•×š' };
  const priorTags = { high:'tag-red', medium:'tag-yellow', low:'tag-green' };
  const due = t.dueDate ? new Date(t.dueDate) : null;
  const today = new Date();
  const isOverdue = due && due < today && t.status === 'open';
  return `
  <div class="task-card ${t.status === 'done' ? 'done' : ''}" onclick="openTaskDetail(${t.id})">
    <div class="task-card-top">
      <div class="task-title">${t.title}</div>
      <div class="priority-dot p-${t.priority}" title="${priorLabels[t.priority]}"></div>
    </div>
    ${t.desc ? `<div class="task-desc">${t.desc}</div>` : ''}
    <div class="task-meta">
      <span class="tag ${priorTags[t.priority]}">${priorLabels[t.priority]}</span>
      ${t.status === 'done' ? '<span class="tag tag-green">âœ… ×”×•×©×œ×</span>' : '<span class="tag tag-gray">ğŸ“‹ ×¤×ª×•×—</span>'}
      ${isOverdue ? '<span class="tag tag-red">âš ï¸ ×‘××™×—×•×¨</span>' : ''}
      ${t.dueDate ? `<span style="font-size:11px;color:var(--text3);">ğŸ“… ${t.dueDate}</span>` : ''}
    </div>
    ${assignee ? `<div style="font-size:11px;color:var(--text3);margin-top:8px;">ğŸ‘¤ ${assignee.name}</div>` : ''}
  </div>`;
}

function renderTaskCards(grid, tasks, mode) {
  if (!tasks.length) { grid.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><p>××™×Ÿ ××©×™××•×ª</p></div>'; return; }
  grid.innerHTML = tasks.map(t => taskCardHTML(t, mode)).join('');
}

function filterTasks(f, el) {
  taskFilter = f;
  document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (currentPage === 'ceo-tasks') renderCeoTasks();
  else if (currentPage === 'emp-tasks') renderEmpTasks();
}

function filterEmpTasks(f, el) { filterTasks(f, el); }

function openTaskDetail(taskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  if (!t) return;
  const assignee = DATA.users.find(u => u.id === t.assignedTo);
  const priorLabels = { high:'ğŸ”¥ ×“×—×•×£', medium:'âš¡ ×‘×™× ×•× ×™', low:'ğŸŒ¿ × ××•×š' };
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">${t.title}</div>
    <div style="margin-bottom:16px;">
      <span class="tag tag-${t.status==='done'?'green':'yellow'}" style="margin-left:8px;">${t.status==='done'?'âœ… ×”×•×©×œ×':'ğŸ“‹ ×¤×ª×•×—'}</span>
      <span class="tag tag-red">${priorLabels[t.priority]}</span>
    </div>
    ${t.desc ? `<p style="color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:16px;">${t.desc}</p>` : ''}
    ${assignee ? `<div style="margin-bottom:12px;font-size:13px;color:var(--text2);">ğŸ‘¤ ××•×§×¦×” ×œ: <strong>${assignee.name}</strong></div>` : ''}
    ${t.dueDate ? `<div style="margin-bottom:16px;font-size:13px;color:var(--text2);">ğŸ“… ×ª××¨×™×š ×™×¢×“: <strong>${t.dueDate}</strong></div>` : ''}
    <div class="modal-actions">
      ${t.status === 'open' ? `<button class="btn btn-success btn-sm" onclick="toggleTaskStatus(${t.id});closeModal();">âœ… ×¡××Ÿ ×›×”×•×©×œ×</button>` : `<button class="btn btn-outline btn-sm" onclick="toggleTaskStatus(${t.id});closeModal();">â†©ï¸ ×¤×ª×— ××—×“×©</button>`}
      <button class="btn btn-danger btn-sm" onclick="deleteTask(${t.id})">ğŸ—‘ï¸ ××—×§</button>
      <button class="btn btn-outline btn-sm" onclick="closeModal()">×¡×’×•×¨</button>
    </div>`;
  openModal();
}

function toggleTaskStatus(taskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  if (t) { t.status = t.status === 'open' ? 'done' : 'open'; awSaveTask(t); } // Appwrite sync
  renderPage(currentPage);
}

function deleteTask(taskId) {
  awDeleteTask(taskId); // Appwrite sync
  DATA.tasks.splice(DATA.tasks.findIndex(t => t.id === taskId), 1);
  closeModal();
  renderPage(currentPage);
}

// â”€â”€ ADD TASK MODAL â”€â”€
function openAddTask(mode) {
  const companyId = currentUser.company;
  const assignees = DATA.users.filter(u => u.company === companyId && u.role === 'employee');
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">â• ×”×•×¡×¤×ª ××©×™××” ×—×“×©×”</div>
    <div class="form-group"><label>×›×•×ª×¨×ª</label><input type="text" id="nt-title" placeholder="×›×•×ª×¨×ª ×”××©×™××”..."></div>
    <div class="form-group"><label>×ª×™××•×¨</label><textarea id="nt-desc" placeholder="×¤×¨×˜×™ ×”××©×™××”..." rows="3"></textarea></div>
    ${mode === 'ceo' ? `<div class="form-group"><label>×”×•×§×¦×” ×œ</label><select id="nt-assign"><option value="">×‘×—×¨ ×¢×•×‘×“</option>${assignees.map(e=>`<option value="${e.id}">${e.name}</option>`).join('')}</select></div>` : ''}
    <div class="form-group"><label>×¢×“×™×¤×•×ª</label><select id="nt-priority"><option value="high">ğŸ”¥ ×“×—×•×£</option><option value="medium" selected>âš¡ ×‘×™× ×•× ×™</option><option value="low">ğŸŒ¿ × ××•×š</option></select></div>
    <div class="form-group"><label>×ª××¨×™×š ×™×¢×“</label><input type="date" id="nt-date"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addTask('${mode}')">â• ×”×•×¡×£</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function openAssignTask(empId) {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ“‹ ×”×•×¡×£ ××©×™××” ×œ×¢×•×‘×“</div>
    <div class="form-group"><label>×›×•×ª×¨×ª</label><input type="text" id="at-title" placeholder="×›×•×ª×¨×ª ×”××©×™××”..."></div>
    <div class="form-group"><label>×ª×™××•×¨</label><textarea id="at-desc" placeholder="×¤×¨×˜×™×..." rows="3"></textarea></div>
    <div class="form-group"><label>×¢×“×™×¤×•×ª</label><select id="at-priority"><option value="high">ğŸ”¥ ×“×—×•×£</option><option value="medium" selected>âš¡ ×‘×™× ×•× ×™</option><option value="low">ğŸŒ¿ × ××•×š</option></select></div>
    <div class="form-group"><label>×ª××¨×™×š ×™×¢×“</label><input type="date" id="at-date"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addTaskToEmp(${empId})">×”×•×¡×£</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function addTask(mode) {
  const title = document.getElementById('nt-title').value.trim();
  if (!title) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×›×•×ª×¨×ª', 'error'); return; }
  const assignTo = mode === 'ceo' ? parseInt(document.getElementById('nt-assign').value) || currentUser.id : currentUser.id;
  const newTask = {
    id: nextTaskId++, title, desc: document.getElementById('nt-desc').value,
    assignedTo: assignTo, assignedBy: currentUser.id, company: currentUser.company,
    priority: document.getElementById('nt-priority').value,
    status: 'open', dueDate: document.getElementById('nt-date').value, createdByEmp: mode === 'emp'
  };
  DATA.tasks.push(newTask);
  awSaveTask(newTask); // Appwrite sync
  closeModal(); renderPage(currentPage); showToast('âœ… ××©×™××” × ×•×¡×¤×”!');
}

function addTaskToEmp(empId) {
  const title = document.getElementById('at-title').value.trim();
  if (!title) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×›×•×ª×¨×ª', 'error'); return; }
  const newTask = {
    id: nextTaskId++, title, desc: document.getElementById('at-desc').value,
    assignedTo: empId, assignedBy: currentUser.id, company: currentUser.company,
    priority: document.getElementById('at-priority').value,
    status: 'open', dueDate: document.getElementById('at-date').value, createdByEmp: false
  };
  DATA.tasks.push(newTask);
  awSaveTask(newTask); // Appwrite sync
  closeModal(); renderPage(currentPage); showToast('âœ… ××©×™××” ×”×•×§×¦×ª×”!');
}

// â”€â”€ COMPANY MANAGEMENT â”€â”€
function openAddCompany() {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ¢ ×”×•×¡×£ ×—×‘×¨×” ×—×“×©×”</div>
    <div class="form-group"><label>×©× ×”×—×‘×¨×”</label><input type="text" id="nc-name" placeholder="×©× ×”×—×‘×¨×”..."></div>
    <div class="form-group"><label>×ª×—×•× ×¤×¢×™×œ×•×ª</label><input type="text" id="nc-field" placeholder="×ª×—×•× ×¤×¢×™×œ×•×ª..."></div>
    <div class="form-group"><label>×××•×’×³×™</label><input type="text" id="nc-emoji" placeholder="ğŸ¢" maxlength="2" style="font-size:24px;width:80px;text-align:center;"></div>
    <div class="form-group"><label>×¦×‘×¢</label><input type="color" id="nc-color" value="#6c63ff" style="width:60px;height:40px;border-radius:8px;border:none;cursor:pointer;"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addCompany()">×”×•×¡×£</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function addCompany() {
  const name = document.getElementById('nc-name').value.trim();
  if (!name) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×©×', 'error'); return; }
  const id = name.toLowerCase().replace(/\s+/g, '');
  const newCo = { id, name, emoji: document.getElementById('nc-emoji').value || 'ğŸ¢',
    field: document.getElementById('nc-field').value || '×›×œ×œ×™',
    color: document.getElementById('nc-color').value, employees: 0, sigPassword: 'sign123', signed: {} };
  DATA.companies.push(newCo);
  awSaveCompany(newCo); // Appwrite sync
  closeModal(); renderAdminCompanies(); showToast('âœ… ×—×‘×¨×” × ×•×¡×¤×”!');
}

function editCompany(compId) {
  const c = DATA.companies.find(x => x.id === compId);
  if (!c) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">âœï¸ ×¢×¨×™×›×ª ${c.name}</div>
    <div class="form-group"><label>×©× ×”×—×‘×¨×”</label><input type="text" id="ec-name" value="${c.name}"></div>
    <div class="form-group"><label>×ª×—×•× ×¤×¢×™×œ×•×ª</label><input type="text" id="ec-field" value="${c.field}"></div>
    <div class="form-group"><label>×××•×’×³×™</label><input type="text" id="ec-emoji" value="${c.emoji}" maxlength="2" style="font-size:24px;width:80px;text-align:center;"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveCompany('${compId}')">ğŸ’¾ ×©××•×¨</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function saveCompany(compId) {
  const c = DATA.companies.find(x => x.id === compId);
  if (c) {
    c.name = document.getElementById('ec-name').value;
    c.field = document.getElementById('ec-field').value;
    c.emoji = document.getElementById('ec-emoji').value || c.emoji;
    awSaveCompany(c); // Appwrite sync
  }
  closeModal(); renderAdminCompanies(); showToast('âœ… ×—×‘×¨×” ×¢×•×“×›× ×”!');
}

function deleteCompany(compId) {
  const comp = DATA.companies.find(c => c.id === compId);
  if (!comp) return;
  const memberCount = DATA.users.filter(u => u.company === compId).length;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ—‘ï¸ ××—×™×§×ª ×—×‘×¨×”</div>
    <div style="background:#fff5f5;border:1px solid #f0c0c8;border-radius:12px;padding:18px;margin-bottom:18px;text-align:center;">
      <div style="font-size:36px;margin-bottom:8px;">${comp.emoji}</div>
      <div style="font-size:18px;font-weight:800;">${comp.name}</div>
      <div style="font-size:13px;color:var(--text2);margin-top:4px;">${comp.field}</div>
    </div>
    <div style="background:#fff8f0;border:1px solid #f0d0a8;border-radius:10px;padding:14px;margin-bottom:18px;font-size:13px;color:#a05010;">
      âš ï¸ <strong>×©×™× ×œ×‘:</strong> ××—×™×§×ª ×”×—×‘×¨×” ×ª× ×ª×§ ××ª <strong>${memberCount} ×”××©×ª××©×™×</strong> ×”×§×©×•×¨×™× ××œ×™×”. ×”× ×œ× ×™×™××—×§×• ××š ×œ× ×™×”×™×• ××©×•×™×›×™× ×œ×©×•× ×—×‘×¨×”.
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="confirmDeleteCompany('${compId}')">ğŸ—‘ï¸ ×›×Ÿ, ××—×§ ×—×‘×¨×”</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function confirmDeleteCompany(compId) {
  const idx = DATA.companies.findIndex(c => c.id === compId);
  if (idx === -1) return;
  const name = DATA.companies[idx].name;
  awDeleteCompany(compId); // Appwrite sync
  DATA.companies.splice(idx, 1);
  DATA.users.filter(u => u.company === compId).forEach(u => u.company = null);
  closeModal();
  renderAdminCompanies();
  showToast(`ğŸ—‘ï¸ ×”×—×‘×¨×” "${name}" × ××—×§×”`);
}

// â”€â”€ USER MANAGEMENT â”€â”€
function openAddUser() {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ‘¤ ×”×•×¡×£ ××©×ª××© ×—×“×©</div>
    <div class="form-group"><label>×©× ××œ×</label><input type="text" id="nu-name" placeholder="×©× ×”××©×ª××©..."></div>
    <div class="form-group"><label>×©× ××©×ª××©</label><input type="text" id="nu-username" placeholder="username..."></div>
    <div class="form-group"><label>×¡×™×¡××”</label><input type="password" id="nu-pass" placeholder="×¡×™×¡××”..."></div>
    <div class="form-group"><label>×ª×¤×§×™×“</label>
      <select id="nu-role"><option value="ceo">×× ×›"×œ</option><option value="employee" selected>×¢×•×‘×“</option><option value="worker">×¤×•×¢×œ</option></select>
    </div>
    <div class="form-group"><label>×—×‘×¨×”</label>
      <select id="nu-company"><option value="">×‘×—×¨ ×—×‘×¨×”</option>${DATA.companies.map(c=>`<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('')}</select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addUser()">×”×•×¡×£</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function addUser() {
  const name = document.getElementById('nu-name').value.trim();
  const username = document.getElementById('nu-username').value.trim();
  const pass = document.getElementById('nu-pass').value;
  if (!name || !username || !pass) { showToast('âŒ ×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error'); return; }
  if (DATA.users.find(u => u.username === username)) { showToast('âŒ ×©× ××©×ª××© ×ª×¤×•×¡', 'error'); return; }
  const role = document.getElementById('nu-role').value;
  const colors = { ceo:'#60a5fa', employee:'#4ade80', worker:'#fb923c' };
  const newUser = {
    id: Math.max(...DATA.users.map(u=>u.id))+1, username, password: pass, name,
    role, company: document.getElementById('nu-company').value || null,
    avatar: role === 'ceo' ? 'ğŸ¢' : role === 'worker' ? 'ğŸ”§' : 'ğŸ’¼',
    avatarColor: colors[role]
  };
  DATA.users.push(newUser);
  awSaveUser(newUser); // Appwrite sync
  closeModal(); renderAdminUsers(); showToast('âœ… ××©×ª××© × ×•×¡×£!');
}

function editUser(userId) {
  const u = DATA.users.find(x => x.id === userId);
  if (!u) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">âœï¸ ×¢×¨×™×›×ª ${u.name}</div>
    <div class="form-group"><label>×©× ××œ×</label><input type="text" id="eu-name" value="${u.name}"></div>
    <div class="form-group"><label>×—×‘×¨×”</label>
      <select id="eu-company"><option value="">×œ×œ× ×—×‘×¨×”</option>${DATA.companies.map(c=>`<option value="${c.id}" ${u.company===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('')}</select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveUser(${userId})">ğŸ’¾ ×©××•×¨</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function saveUser(userId) {
  const u = DATA.users.find(x => x.id === userId);
  if (u) {
    u.name = document.getElementById('eu-name').value;
    u.company = document.getElementById('eu-company').value || null;
    awSaveUser(u); // Appwrite sync
  }
  closeModal(); renderAdminUsers(); showToast('âœ… ××©×ª××© ×¢×•×“×›×Ÿ!');
}

function changePassword(userId) {
  const u = DATA.users.find(x => x.id === userId);
  if (!u) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ”‘ ×©×™× ×•×™ ×¡×™×¡××” - ${u.name}</div>
    <div class="form-group"><label>×¡×™×¡××” ×—×“×©×”</label><input type="password" id="new-pass" placeholder="×¡×™×¡××” ×—×“×©×”..."></div>
    <div class="form-group"><label>××™×©×•×¨ ×¡×™×¡××”</label><input type="password" id="conf-pass" placeholder="××™×©×•×¨ ×¡×™×¡××”..."></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="doChangePass(${userId})">ğŸ”‘ ×¢×“×›×Ÿ</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function doChangePass(userId) {
  const np = document.getElementById('new-pass').value;
  const cp = document.getElementById('conf-pass').value;
  if (!np) { showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××”', 'error'); return; }
  if (np !== cp) { showToast('âŒ ×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª', 'error'); return; }
  const u = DATA.users.find(x => x.id === userId);
  if (u) { u.password = np; awSaveUser(u); } // Appwrite sync
  closeModal(); showToast('âœ… ×¡×™×¡××” ×¢×•×“×›× ×”!');
}

function deleteUser(userId) {
  const u = DATA.users.find(x => x.id === userId);
  if (!u) return;
  const roleLabels = { ceo:'×× ×›"×œ', employee:'×¢×•×‘×“', worker:'×¤×•×¢×œ' };
  const company = DATA.companies.find(c => c.id === u.company);
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ—‘ï¸ ××—×™×§×ª ××©×ª××©</div>
    <div style="background:#fff5f5;border:1px solid #f0c0c8;border-radius:12px;padding:18px;margin-bottom:18px;text-align:center;">
      <div style="width:50px;height:50px;border-radius:50%;background:${u.avatarColor}33;color:${u.avatarColor};display:flex;align-items:center;justify-content:center;font-size:22px;margin:0 auto 10px;">${u.avatar}</div>
      <div style="font-size:17px;font-weight:800;">${u.name}</div>
      <div style="font-size:12px;color:var(--text2);margin-top:4px;">${roleLabels[u.role] || u.role}${company ? ' â€¢ ' + company.name : ''}</div>
    </div>
    <div style="background:#fff8f0;border:1px solid #f0d0a8;border-radius:10px;padding:12px 14px;margin-bottom:18px;font-size:13px;color:#a05010;">
      âš ï¸ ××—×™×§×” ×ª×¡×™×¨ ××ª ×”××©×ª××© ××”××¢×¨×›×ª ×œ×—×œ×•×˜×™×Ÿ. ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="confirmDeleteUser(${userId})">ğŸ—‘ï¸ ×›×Ÿ, ××—×§</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
}

function confirmDeleteUser(userId) {
  const idx = DATA.users.findIndex(x => x.id === userId);
  if (idx === -1) return;
  const name = DATA.users[idx].name;
  awDeleteUser(userId); // Appwrite sync
  DATA.users.splice(idx, 1);
  DATA.tasks.forEach(t => { if (t.assignedTo === userId) t.assignedTo = null; });
  closeModal();
  renderAdminUsers();
  showToast(`ğŸ—‘ï¸ ${name} × ××—×§ ××”××¢×¨×›×ª`);
}

function viewWorkerReport(workerId) {
  const worker = DATA.users.find(u => u.id === workerId);
  if (!worker) return;
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const now = new Date();
  const months = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

  // Build month selector
  const monthOptions = [];
  for (let i = 0; i < 6; i++) {
    let m = now.getMonth() - i;
    let y = now.getFullYear();
    if (m < 0) { m += 12; y--; }
    monthOptions.push({ m, y, label: `${months[m]} ${y}` });
  }

  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ“Š ×“×•×— ×©×¢×•×ª â€” ${worker.name}</div>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
      <select id="report-month-select" onchange="loadWorkerReportMonth(${workerId})" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;">
        ${monthOptions.map((o,i) => `<option value="${o.m}|${o.y}" ${i===0?'selected':''}>${o.label}</option>`).join('')}
      </select>
      <span id="report-sig-badge" style="font-size:12px;"></span>
    </div>
    <div id="report-stats" style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:14px;padding:14px;background:var(--bg3);border-radius:10px;"></div>
    <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
      <table class="hours-table">
        <thead><tr><th>×ª××¨×™×š</th><th>×™×•×</th><th>×©×¢×•×ª</th><th>×”×’×¢×”</th><th>×™×¦×™××”</th><th>×”×¢×¨×•×ª</th></tr></thead>
        <tbody id="report-table-body"></tbody>
      </table>
    </div>
    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-outline btn-sm" onclick="closeModal()">×¡×’×•×¨</button>
    </div>`;

  openModal();
  loadWorkerReportMonth(workerId);
}

function loadWorkerReportMonth(workerId) {
  const sel = document.getElementById('report-month-select');
  if (!sel) return;
  const [m, y] = sel.value.split('|').map(Number);
  const worker = DATA.users.find(u => u.id === workerId);
  const company = DATA.companies.find(c => c.id === worker?.company);
  const key = `${workerId}-${y}-${m}`;
  const hours = DATA.workerHours[key] || {};
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const dayNames = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
  const months = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

  const signedInfo = company && company.signed[key];
  const isFullSigned = signedInfo && signedInfo.type === 'full';
  const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

  // Signature badge
  const badge = document.getElementById('report-sig-badge');
  if (badge) {
    if (isFullSigned) badge.innerHTML = '<span class="tag tag-green">âœ… ×›×œ ×”×—×•×“×© ×—×ª×•×</span>';
    else if (partialDays.length) badge.innerHTML = `<span class="tag tag-purple">ğŸ“… ${partialDays.length} ×ª××¨×™×›×™× ×—×ª×•××™×</span>`;
    else badge.innerHTML = '<span class="tag tag-red">âŒ ×œ× ×—×ª×•×</span>';
  }

  // Build rows & stats
  let totalH = 0, workDays = 0;
  let rows = '';
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(y, m, d);
    const dayIdx = date.getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const entry = hours[d] || {};
    const computed = entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours)||0);
    if (computed > 0) { totalH += computed; workDays++; }
    const isDaySigned = isFullSigned || partialDays.includes(d);
    const rowBg = isDaySigned ? 'background:#f0fff4;' : (isWeekend ? 'background:#fdf0f0;' : '');
    const sigMark = isDaySigned ? ' âœ“' : '';

    rows += `<tr style="${rowBg}">
      <td style="font-weight:600;font-size:12px;">${d}/${m+1}${sigMark}</td>
      <td style="color:${isWeekend ? '#c0506a' : 'var(--text2)'};font-size:12px;">${dayNames[dayIdx]}</td>
      <td style="font-weight:700;color:#4a88b8;font-size:13px;">${computed > 0 ? computed.toFixed(1) : 'â€”'}</td>
      <td style="font-size:12px;color:var(--text2);">${entry.start || 'â€”'}</td>
      <td style="font-size:12px;color:var(--text2);">${entry.end || 'â€”'}</td>
      <td style="font-size:12px;color:var(--text2);">${entry.note || ''}</td>
    </tr>`;
  }

  const tbody = document.getElementById('report-table-body');
  if (tbody) tbody.innerHTML = rows;

  const stats = document.getElementById('report-stats');
  if (stats) stats.innerHTML = `
    <div><div style="font-size:22px;font-weight:800;color:#b06830;">${totalH.toFixed(1)}</div><div style="font-size:11px;color:var(--text2);">×¡×”"×› ×©×¢×•×ª</div></div>
    <div><div style="font-size:22px;font-weight:800;color:#a07820;">${workDays}</div><div style="font-size:11px;color:var(--text2);">×™××™ ×¢×‘×•×“×”</div></div>
    <div><div style="font-size:22px;font-weight:800;color:#3a9a7a;">${workDays ? (totalH/workDays).toFixed(1) : '0'}</div><div style="font-size:11px;color:var(--text2);">×××•×¦×¢ ×™×•××™</div></div>
    <div><div style="font-size:22px;font-weight:800;color:#7b63d8;">${months[m]} ${y}</div><div style="font-size:11px;color:var(--text2);">×—×•×“×©</div></div>`;
}

function removeWorker(workerId) {
  const w = DATA.users.find(u => u.id === workerId);
  if (!confirm(`×œ×”×¡×™×¨ ××ª ${w.name}?`)) return;
  w.company = null;
  renderCeoWorkers(); showToast('âœ… ×¤×•×¢×œ ×”×•×¡×¨ ××”×—×‘×¨×”');
}

// â”€â”€ NOTES â”€â”€
function renderNotes(type) {
  const el = document.getElementById(`${type}-notes`);
  if (el && DATA.notes[`${type}-${currentUser.id}`]) el.value = DATA.notes[`${type}-${currentUser.id}`];
  renderQuickNotes(type);
}

function saveNotes(type) {
  const el = document.getElementById(`${type}-notes`);
  if (el) DATA.notes[`${type}-${currentUser.id}`] = el.value;
  showToast('âœ… ×”×¢×¨×•×ª × ×©××¨×•!');
}

function addQuickNote(type) {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">ğŸ“Œ ×¤×ª×§ ××”×™×¨ ×—×“×©</div>
    <div class="form-group">
      <label>×ª×•×›×Ÿ ×”×¤×ª×§</label>
      <textarea id="quick-note-text" class="form-input" rows="4" placeholder="×›×ª×•×‘ ×›××Ÿ ××ª ×”×¤×ª×§..." style="resize:vertical;font-family:inherit;"></textarea>
    </div>
    <div style="margin-bottom:14px;">
      <label style="font-size:12px;color:var(--text2);font-weight:600;margin-bottom:6px;display:block;">×¦×‘×¢</label>
      <div style="display:flex;gap:8px;">
        ${['#7bb3d8','#6bc4a6','#e8c46a','#e88fa0','#d4a0c8'].map((c,i) =>
          `<button onclick="selectNoteColor('${c}',this)" data-color="${c}" style="width:28px;height:28px;border-radius:50%;background:${c};border:3px solid ${i===0?'#333':'transparent'};cursor:pointer;" class="note-color-btn"></button>`
        ).join('')}
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveQuickNote('${type}')">ğŸ“Œ ×”×•×¡×£ ×¤×ª×§</button>
      <button class="btn btn-outline" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;
  openModal();
  setTimeout(() => document.getElementById('quick-note-text')?.focus(), 100);
}

function selectNoteColor(color, btn) {
  document.querySelectorAll('.note-color-btn').forEach(b => b.style.border = '3px solid transparent');
  btn.style.border = '3px solid #333';
  btn.closest('.modal') ? btn.dataset.selected = 'true' : null;
  window._selectedNoteColor = color;
}

function saveQuickNote(type) {
  const text = document.getElementById('quick-note-text')?.value.trim();
  if (!text) { showToast('âŒ ×™×© ×œ×›×ª×•×‘ ×ª×•×›×Ÿ ×œ×¤×ª×§', 'error'); return; }
  const color = window._selectedNoteColor || '#7bb3d8';
  const key = `${type}-${currentUser.id}`;
  if (!DATA.quickNotes[key]) DATA.quickNotes[key] = [];
  DATA.quickNotes[key].push({ text, time: new Date().toLocaleDateString('he-IL'), color });
  window._selectedNoteColor = null;
  closeModal();
  renderQuickNotes(type);
  showToast('ğŸ“Œ ×¤×ª×§ × ×•×¡×£!');
}

function renderQuickNotes(type) {
  const container = document.getElementById(`${type}-quick-notes`);
  if (!container) return;
  const key = `${type}-${currentUser.id}`;
  const notes = DATA.quickNotes[key] || [];
  if (!notes.length) { container.innerHTML = ''; return; }
  container.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:4px;">${notes.map((n,i) => `
    <div style="background:${n.color}15;border:1px solid ${n.color}44;border-radius:10px;padding:14px;position:relative;">
      <button onclick="deleteQuickNote('${type}',${i})" style="position:absolute;top:8px;left:8px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;">âœ•</button>
      <div style="font-size:13px;line-height:1.5;color:var(--text);margin-bottom:6px;">${n.text}</div>      <div style="font-size:11px;color:var(--text3);">${n.time}</div>
    </div>`).join('')}</div>`;
}

function deleteQuickNote(type, idx) {
  const key = `${type}-${currentUser.id}`;
  DATA.quickNotes[key].splice(idx, 1);
  renderQuickNotes(type);
}

const passVisible = {};
function togglePassView(userId, password) {
  passVisible[userId] = !passVisible[userId];
  const el = document.getElementById(`pass-display-${userId}`);
  const btn = document.getElementById(`eye-btn-${userId}`);
  if (el) el.textContent = passVisible[userId] ? password : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  if (btn) btn.textContent = passVisible[userId] ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
}


function openModal() { document.getElementById('modalOverlay').classList.add('open'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
document.getElementById('modalOverlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

// â”€â”€ SIDEBAR â”€â”€
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// â”€â”€ TOAST â”€â”€
function showToast(msg, type = 'success') {
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:${type==='error'?'#fde8ec':'white'};border:1px solid ${type==='error'?'#e88fa0':'var(--border)'};color:${type==='error'?'#c0506a':'var(--text)'};padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 8px 30px rgba(100,130,170,0.2);animation:slideUp 0.2s ease;`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; t.style.transition='opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 2500);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// APPWRITE INTEGRATION LAYER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const AW_CONFIG = {
  endpoint:   'https://nyc.cloud.appwrite.io/v1',
  projectId:  '699c5fba003d3849863e',
  databaseId: 'workflow-pro-db',
  collections: {
    users:       'users',
    companies:   'companies',
    tasks:       'tasks',
    workerHours: 'worker-hours',
    notes:       'notes',
    signatures:  'signatures',
  }
};

// â”€â”€ Appwrite SDK Clients â”€â”€
let _client, _account, _db;
function awClient() {
  if (!_client) {
    _client = new Appwrite.Client();
    _client.setEndpoint(AW_CONFIG.endpoint).setProject(AW_CONFIG.projectId);
    _account = new Appwrite.Account(_client);
    _db      = new Appwrite.Databases(_client);
  }
  return { client: _client, account: _account, db: _db };
}

// â”€â”€ Loading UI helpers â”€â”€
function showLoading(msg = '×˜×•×¢×Ÿ...', sub = '') {
  const el = document.getElementById('appwriteLoading');
  if (el) { el.style.display = 'flex'; }
  const m = document.getElementById('loadingMsg');
  const s = document.getElementById('loadingSubMsg');
  if (m) m.textContent = msg;
  if (s) s.textContent = sub;
}
function hideLoading() {
  const el = document.getElementById('appwriteLoading');
  if (el) el.style.display = 'none';
}

// â”€â”€ Appwrite DB helpers â”€â”€
async function awList(collection, queries = []) {
  const { db } = awClient();
  const res = await db.listDocuments(AW_CONFIG.databaseId, AW_CONFIG.collections[collection], queries);
  return res.documents;
}
async function awGet(collection, id) {
  const { db } = awClient();
  return await db.getDocument(AW_CONFIG.databaseId, AW_CONFIG.collections[collection], id);
}
async function awCreate(collection, id, data) {
  const { db } = awClient();
  return await db.createDocument(AW_CONFIG.databaseId, AW_CONFIG.collections[collection], id, data);
}
async function awUpdate(collection, id, data) {
  const { db } = awClient();
  return await db.updateDocument(AW_CONFIG.databaseId, AW_CONFIG.collections[collection], id, data);
}
async function awDelete(collection, id) {
  const { db } = awClient();
  return await db.deleteDocument(AW_CONFIG.databaseId, AW_CONFIG.collections[collection], id);
}
async function awUpsert(collection, id, data) {
  try { return await awUpdate(collection, id, data); }
  catch(e) {
    if (e.code === 404) return await awCreate(collection, id, data);
    throw e;
  }
}

// â”€â”€ Convert Appwrite doc to local format â”€â”€
function docToUser(d) {
  return { id: d.localId, $id: d.$id, username: d.username, password: d.password,
    name: d.name, role: d.role, company: d.company || null,
    avatar: d.avatar, avatarColor: d.avatarColor,
    idType: d.idType || 'id', idNumber: d.idNumber || '' };
}
function docToCompany(d) {
  return { id: d.localId, $id: d.$id, name: d.name, emoji: d.emoji || 'ğŸ¢',
    field: d.field || '', color: d.color || '#6c63ff',
    sigPassword: d.sigPassword || '', signed: {} };
}
function docToTask(d) {
  return { id: d.localId, $id: d.$id, title: d.title, desc: d.desc || '',
    assignedTo: d.assignedTo || null, assignedBy: d.assignedBy || null,
    company: d.company, priority: d.priority, status: d.status,
    dueDate: d.dueDate, createdByEmp: d.createdByEmp || false };
}

// â”€â”€ LOAD ALL DATA from Appwrite â”€â”€
async function loadAllFromAppwrite() {
  const { db } = awClient();
  try {
    showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Appwrite...', '××©×ª××©×™×');
    const userDocs = await awList('users');
    DATA.users = userDocs.map(docToUser);

    showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Appwrite...', '×—×‘×¨×•×ª');
    const compDocs = await awList('companies');
    DATA.companies = compDocs.map(docToCompany);

    showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Appwrite...', '××©×™××•×ª');
    const taskDocs = await awList('tasks');
    DATA.tasks = taskDocs.map(docToTask);

    showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Appwrite...', '×©×¢×•×ª');
    const hoursDocs = await awList('workerHours');
    DATA.workerHours = {};
    hoursDocs.forEach(d => {
      DATA.workerHours[d.key] = JSON.parse(d.hoursJson || '{}');
    });

    showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Appwrite...', '×—×ª×™××•×ª');
    const sigDocs = await awList('signatures');
    sigDocs.forEach(d => {
      const company = DATA.companies.find(c => c.id === d.companyId);
      if (company) company.signed[d.key] = JSON.parse(d.signedJson || '{}');
    });

    showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Appwrite...', '×”×¢×¨×•×ª');
    const notesDocs = await awList('notes');
    DATA.notes = {};
    DATA.quickNotes = {};
    notesDocs.forEach(d => {
      if (d.noteType === 'quick') DATA.quickNotes[d.key] = JSON.parse(d.content || '[]');
      else DATA.notes[d.key] = d.content || '';
    });

    if (DATA.tasks.length > 0) {
      nextTaskId = Math.max(...DATA.tasks.map(t => t.id), 100) + 1;
    }

    hideLoading();
    return true;
  } catch (err) {
    console.error('Appwrite load error:', err);
    hideLoading();
    if (err.code === 404 || err.message?.includes('Collection')) {
      showSetupBanner();
      return false;
    }
    showToast('âš ï¸ ×©×’×™××ª ×˜×¢×™× ×”: ' + (err.message || err), 'error');
    return false;
  }
}

function showSetupBanner() {
  const banner = document.getElementById('setupBanner');
  const steps = document.getElementById('setupSteps');
  if (!banner || !steps) return;
  steps.innerHTML = `
    ×¦×•×¨ Database ×¢× ID: <code style="background:rgba(255,255,255,0.2);padding:1px 5px;border-radius:3px;">${AW_CONFIG.databaseId}</code> ×‘-Appwrite Console, ×•××– ×¦×•×¨ ××ª ×”-Collections ×”×‘××™×:<br>
    ğŸ“ <strong>users</strong> | ğŸ“ <strong>companies</strong> | ğŸ“ <strong>tasks</strong> | ğŸ“ <strong>worker-hours</strong> | ğŸ“ <strong>notes</strong> | ğŸ“ <strong>signatures</strong><br>
    <span style="opacity:0.8;">×¨××” ××ª ×§×•×‘×¥ <strong>APPWRITE_SETUP.md</strong> ×œ×ª×™×¢×•×“ ××œ× ×©×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×.</span>`;
  banner.style.display = 'block';
}

// â”€â”€ SAVE helpers (called after each local DATA mutation) â”€â”€
async function awSaveUser(user) {
  if (!user) return;
  const $id = user.$id || 'u_' + user.id;
  const data = { localId: user.id, username: user.username, password: user.password,
    name: user.name, role: user.role, company: user.company || '',
    avatar: user.avatar, avatarColor: user.avatarColor,
    idType: user.idType || 'id', idNumber: user.idNumber || '' };
  try { const doc = await awUpsert('users', $id, data); user.$id = doc.$id; }
  catch(e) { console.warn('awSaveUser:', e); }
}

async function awDeleteUser(userId) {
  const user = DATA.users.find(u => u.id === userId);
  const $id = user?.$id || 'u_' + userId;
  try { await awDelete('users', $id); } catch(e) { console.warn('awDeleteUser:', e); }
}

async function awSaveCompany(company) {
  if (!company) return;
  const $id = company.$id || 'c_' + company.id;
  const data = { localId: company.id, name: company.name, emoji: company.emoji || 'ğŸ¢',
    field: company.field || '', color: company.color || '#6c63ff',
    sigPassword: company.sigPassword || '' };
  try { const doc = await awUpsert('companies', $id, data); company.$id = doc.$id; }
  catch(e) { console.warn('awSaveCompany:', e); }
}

async function awDeleteCompany(companyId) {
  const comp = DATA.companies.find(c => c.id === companyId);
  const $id = comp?.$id || 'c_' + companyId;
  try { await awDelete('companies', $id); } catch(e) { console.warn('awDeleteCompany:', e); }
}

async function awSaveTask(task) {
  if (!task) return;
  const $id = task.$id || 't_' + task.id;
  const data = { localId: task.id, title: task.title, desc: task.desc || '',
    assignedTo: task.assignedTo || 0, assignedBy: task.assignedBy || 0,
    company: task.company, priority: task.priority, status: task.status,
    dueDate: task.dueDate, createdByEmp: task.createdByEmp || false };
  try { const doc = await awUpsert('tasks', $id, data); task.$id = doc.$id; }
  catch(e) { console.warn('awSaveTask:', e); }
}

async function awDeleteTask(taskId) {
  const task = DATA.tasks.find(t => t.id === taskId);
  const $id = task?.$id || 't_' + taskId;
  try { await awDelete('tasks', $id); } catch(e) { console.warn('awDeleteTask:', e); }
}

async function awSaveWorkerHours(key) {
  const hoursJson = JSON.stringify(DATA.workerHours[key] || {});
  try { await awUpsert('workerHours', 'wh_' + key.replace(/[^a-zA-Z0-9]/g, '_'), { key, hoursJson }); }
  catch(e) { console.warn('awSaveWorkerHours:', e); }
}

async function awSaveSignature(companyId, key) {
  const company = DATA.companies.find(c => c.id === companyId);
  if (!company) return;
  const signedJson = JSON.stringify(company.signed[key] || {});
  const docId = 'sig_' + (companyId + '_' + key).replace(/[^a-zA-Z0-9]/g, '_');
  try { await awUpsert('signatures', docId, { companyId, key, signedJson }); }
  catch(e) { console.warn('awSaveSignature:', e); }
}

async function awSaveNote(noteKey, content, isQuick = false) {
  const docId = 'note_' + noteKey.replace(/[^a-zA-Z0-9]/g, '_');
  const data = { key: noteKey, content: isQuick ? JSON.stringify(content) : (content || ''), noteType: isQuick ? 'quick' : 'text' };
  try { await awUpsert('notes', docId, data); }
  catch(e) { console.warn('awSaveNote:', e); }
}

// â”€â”€ OVERRIDDEN AUTH FUNCTIONS â”€â”€
async function doLogin() {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value.trim();
  if (!username || !password) return;

  const { account } = awClient();
  showLoading('××ª×—×‘×¨...', username);

  try {
    // Try Appwrite Auth first
    try { await account.deleteSession('current'); } catch(_) {}
    await account.createEmailPasswordSession(username + '@workflow.local', password);

    // Load data then find local user
    const ok = await loadAllFromAppwrite();
    if (!ok) {
      // Fallback: try finding in current DATA
    }
    const user = DATA.users.find(u => u.username === username && u.password === password);
    if (!user) {
      hideLoading();
      document.getElementById('loginError').style.display = 'block';
      document.getElementById('loginError').textContent = '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×';
      return;
    }
    hideLoading();
    document.getElementById('loginError').style.display = 'none';
    login(user);

  } catch(err) {
    // Fallback to local auth if Appwrite Auth fails
    console.warn('Appwrite auth failed, falling back to local:', err.message);
    hideLoading();

    // Try to load data anyway (in case only Auth failed)
    try { await loadAllFromAppwrite(); } catch(_) {}

    const user = DATA.users.find(u => u.username === username && u.password === password);
    if (!user) {
      document.getElementById('loginError').style.display = 'block';
      document.getElementById('loginError').textContent = '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×';
      return;
    }
    document.getElementById('loginError').style.display = 'none';
    login(user);
  }
}

function quickLogin(u, p) {
  document.getElementById('loginUser').value = u;
  document.getElementById('loginPass').value = p;
  doLogin();
}

async function logout() {
  const { account } = awClient();
  try { await account.deleteSession('current'); } catch(_) {}
  currentUser = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  closeSidebar();
}

// â”€â”€ PATCHED SAVE FUNCTIONS (hook into existing mutations) â”€â”€
// Patch saveNotes to also save to Appwrite
const _origSaveNotes = saveNotes;
window.saveNotes = function(type) {
  _origSaveNotes(type);
  const key = `${type}-${currentUser.id}`;
  awSaveNote(key, DATA.notes[key], false);
};

// Patch addQuickNote
const _origAddQuickNote = addQuickNote;
window.addQuickNote = function(type) {
  _origAddQuickNote(type);
  const key = `${type}-${currentUser.id}`;
  awSaveNote(key, DATA.quickNotes[key], true);
};

// Patch setSigPassword
const _origSetSigPassword = typeof setSigPassword !== 'undefined' ? setSigPassword : null;
if (_origSetSigPassword) {
  window.setSigPassword = function() {
    _origSetSigPassword();
    const company = DATA.companies.find(c => c.id === currentUser.company);
    if (company) awSaveCompany(company);
  };
}

// Patch updateHourEntry to save to Appwrite (debounced)
const _awHoursSaveTimers = {};
const _origUpdateHourEntry = updateHourEntry;
window.updateHourEntry = function(day, field, val, wid) {
  _origUpdateHourEntry(day, field, val, wid);
  const now = new Date();
  const key = `${wid}-${now.getFullYear()}-${now.getMonth()}`;
  clearTimeout(_awHoursSaveTimers[key]);
  _awHoursSaveTimers[key] = setTimeout(() => awSaveWorkerHours(key), 1500);
};

// â”€â”€ INITIALIZATION â”€â”€
// Check for existing Appwrite session on page load
(async function initAppwrite() {
  const { account } = awClient();
  try {
    await account.get(); // Check if logged in
    // Has session â€” load data silently
    showLoading('××—×“×© ×—×™×‘×•×¨...', '');
    await loadAllFromAppwrite();
    hideLoading();
  } catch(_) {
    // No session â€” just show login screen normally
    hideLoading();
  }
})();

// â”€â”€ APPWRITE SETUP GUIDE (exported as global for reference) â”€â”€
window.APPWRITE_SCHEMA = {
  databaseId: AW_CONFIG.databaseId,
  collections: {
    users: {
      id: 'users',
      attributes: ['localId(integer)', 'username(string,128)', 'password(string,128)',
        'name(string,256)', 'role(string,32)', 'company(string,64)',
        'avatar(string,16)', 'avatarColor(string,16)', 'idType(string,16)', 'idNumber(string,64)']
    },
    companies: {
      id: 'companies',
      attributes: ['localId(string,64)', 'name(string,256)', 'emoji(string,8)',
        'field(string,256)', 'color(string,16)', 'sigPassword(string,128)']
    },
    tasks: {
      id: 'tasks',
      attributes: ['localId(integer)', 'title(string,512)', 'desc(string,2048)',
        'assignedTo(integer)', 'assignedBy(integer)', 'company(string,64)',
        'priority(string,16)', 'status(string,16)', 'dueDate(string,16)', 'createdByEmp(boolean)']
    },
    'worker-hours': {
      id: 'worker-hours',
      attributes: ['key(string,128)', 'hoursJson(string,65535)']
    },
    notes: {
      id: 'notes',
      attributes: ['key(string,128)', 'content(string,65535)', 'noteType(string,16)']
    },
    signatures: {
      id: 'signatures',
      attributes: ['companyId(string,64)', 'key(string,128)', 'signedJson(string,65535)']
    }
  }
};

console.log('ğŸ“‹ Appwrite Schema:', JSON.stringify(window.APPWRITE_SCHEMA, null, 2));

// â”€â”€ KEYBOARD â”€â”€
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
document.getElementById('loginUser').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginPass').focus(); });
</script>
</body>
</html>
